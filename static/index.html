<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AetherWave Studio - All Intelligence is Welcome Here</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Shared Navigation CSS -->
  <!--<link rel="stylesheet" href="/static/assets/css/navigation.css">-->
  <link rel="stylesheet" href="https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-files%2Fnav.css?alt=media&token=d9ce7aa2-0609-46cc-92a8-169d8d8ca076">
  <!-- Tiled Background CSS -->
  <link rel="stylesheet" href="/static/assets/css/tiled-background.css">
  <style>
   /*:root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    } */
        :root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    }


    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--dark-bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    }

    /* Animated Background */
    .bg-container {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
    background: radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.15), transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(255, 46, 166, 0.12), transparent 50%);
    }

    .bg-grid {
    position: absolute;
    inset: 0;
    background-image:
    linear-gradient(var(--border-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
    0% { transform: translate(0, 0); }
    100% { transform: translate(60px, 60px); }
    }

    .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.4;
    animation: float 15s ease-in-out infinite;
    }

    .orb-1 {
    width: 400px;
    height: 400px;
    background: var(--aetherwave-pink);
    top: 10%;
    left: 10%;
    animation-delay: 0s;
    }

    .orb-2 {
    width: 300px;
    height: 300px;
    background: var(--aetherwave-purple);
    bottom: 20%;
    right: 15%;
    animation-delay: 5s;
    }

    @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Header */
    header {
    position: relative;
    z-index: 10;
    padding: .5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: blur(12px);
    background: url('/assets/header-panel_1761541736595.png') no-repeat center center, rgba(13, 11, 21, 0.8);
    background-size: cover;
    }

    .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    }

    .logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }
        .logo-icon2 {
    width: 75px;
    height: 75px;
    /*background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));*/
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }

    nav {
    display: flex;
    gap: 2rem;
    align-items: center;
    }

    nav a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.2s;
    }

    nav a:hover {
    color: var(--text-primary);
    }

    .nav-btn {
    padding: 0.5rem 1.25rem;
    background: var(--aetherwave-pink);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 46, 166, 0.4);
    }

    /* Main Content */
    main {
    position: relative;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
    min-height: 0;
    }

    .panels-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto 1fr;
    gap: 1.5rem;
    flex: 1;
    min-height: 0;
    position: relative;
    }

    .hero-text {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
    background: url('/assets/header-panel_1761541736595.png') no-repeat center center, linear-gradient(135deg, rgba(13, 11, 21, 0.98), rgba(20, 15, 35, 0.98));
    background-size: cover;
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    }
    
    .panel-music {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
    }
    
    .panel-chat {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
    }
    
    .panel-media {
      grid-column: 3 / 4;
      grid-row: 1 / 3;
    }

    @keyframes fadeInUp {
    from {
    opacity: 0;
    transform: translateY(20px);
    }
    to {
    opacity: 1;
    transform: translateY(0);
    }
    }

    h1 {
    font-size: clamp(1.5rem, 2.5vw, 2rem);
    font-weight: 700;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple), var(--text-primary));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
    }

    .subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.5;
    }

    /* Panel Styling */
    .panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: fadeInUp 0.8s ease-out 0.2s backwards;
    display: flex;
    flex-direction: column;
    }

    .panel-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: url('/assets/header-panel_1761541736595.png') no-repeat center center, rgba(13, 11, 21, 0.5);
    background-size: cover;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }
    
	.treadplate{
	background: url('https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2Ftreadplate_narrow.png?alt=media&token=7a000c4c-bf82-4f14-b1b4-b57ac7c41cbd') no-repeat center;
	background-size: 100%, 100%;
	}
	
    .music-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .credits-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0;
      background: url('/assets/Coins_badge_1761542949252.png') no-repeat center center;
      background-size: 100% 100%;
      border: none;
      border-radius: 0;
      font-weight: 700;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
      min-height: 60px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.8));
    }
    
    .credits-indicator span {
      filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.9)) drop-shadow(0 0 2px rgba(0, 0, 0, 1));
    }
    
    .credits-indicator:hover {
      filter: brightness(1.2) drop-shadow(0 2px 8px rgba(0, 0, 0, 0.8));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 46, 166, 0.3);
    }
    
    .version-dropdown {
      padding: 0.5rem 1rem;
      background: var(--dark-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .version-dropdown:hover {
      border-color: var(--aetherwave-purple);
    }

    .panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    }

    .panel-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    }

    .panel-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    /* Chat Interface */
    .chat-messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
	background: ("https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2FBlack_Screen.png?alt=media&token=9a71a6bb-1f74-4f23-8437-420f17e0cb32");
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100% 100%;
    }

    .message {
    animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
    }

    .message-label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    }

    .message-content {
    padding: 1rem 1.25rem;
    border-radius: 12px;
    line-height: 1.6;
    }
	
    .message.user .message-content {
    background: rgba(255, 46, 166, 0.1);
    border: 1px solid rgba(255, 46, 166, 0.3);
    margin-left: 2rem;
    }

    .message.assistant .message-content {
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
	background: url("https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2FBlack_Surface.png?alt=media&token=06d4bfdc-41d8-4d55-bbfd-5756c5d63845");
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100% 100%;
    }

    .chat-input-area {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    background: rgba(13, 11, 21, 0.5);
	background: url("https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2Ftreadplate_narrow.png?alt=media&token=7a000c4c-bf82-4f14-b1b4-b57ac7c41cbd"); 
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100% 100%;
    }

    /* Music Generation */
    .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }
    
    /* Gender Toggle Buttons */
    .gender-toggle-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    /* Premium Gradient Sliders */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
      margin: 0.5rem 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 46, 166, 0.5);
      transition: all 0.2s;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(255, 46, 166, 0.8);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px rgba(255, 46, 166, 0.5);
      transition: all 0.2s;
    }
    
    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(255, 46, 166, 0.8);
    }
    
    /* Slider value display */
    .slider-value-display {
      display: inline-block;
      min-width: 3rem;
      text-align: right;
      color: var(--aetherwave-purple);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .slider-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Premium Upload Audio Button */
    .premium-upload-btn {
      position: relative;
      padding: 0.75rem 2rem;
      background: linear-gradient(135deg, rgba(13, 11, 21, 0.95), rgba(20, 15, 35, 0.95));
      border: 2px solid transparent;
      border-radius: 24px;
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(24px);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .premium-upload-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 24px;
      padding: 2px;
      background: linear-gradient(135deg, #00f5ff, #ff2ea6);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 1;
      transition: opacity 0.3s;
    }
    
    .premium-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 24px rgba(255, 46, 166, 0.3),
        0 0 20px rgba(0, 245, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .premium-upload-btn:active {
      transform: translateY(0);
    }

    .form-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    }

    textarea {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: inset 0 0 2px rgba(139, 92, 246, 0.3);
    }

    textarea:focus {
    border-color: var(--aetherwave-pink);
    box-shadow: inset 0 0 2px rgba(255, 46, 166, 0.5);
    }

    select {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    }

    select:focus {
    border-color: var(--aetherwave-pink);
    }

    .btn-primary {
    padding: 0.75rem 2rem;
    background-color: transparent;
    background-image: url('/assets/Generate-image-btn.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
    border: none;
    border-radius: 0;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
    font-size: 0.95rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    height: 48px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    }

    .btn-primary:hover:not(.processing) {
    transform: translateY(-2px);
    filter: brightness(1.1);
    }

    .btn-primary:active {
    background-image: url('/assets/Generate-image-btn-active.png');
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    transform: translateY(0);
    }
    
    .btn-primary.processing {
    background-image: url('/assets/Generate-image-btn-active.png');
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    animation: pinkPulse 2s ease-in-out infinite;
    transform: translateY(0);
    }

    .btn-primary:disabled:not(.processing) {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    filter: grayscale(0.3);
    }
    
    .btn-primary:disabled.processing {
    opacity: 1;
    cursor: wait;
    }

    /* Custom Video Generation Button */
    .btn-video-generate {
    padding: 1rem 2rem;
    background-color: transparent;
    background-image: url('/assets/Generate-video-btn.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
    border: none;
    border-radius: 0;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
    font-size: 1.1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    height: 56px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    position: relative;
    min-width: 200px;
    }

    .btn-video-generate:hover:not(.processing) {
    transform: translateY(-2px);
    filter: brightness(1.1);
    }

    .btn-video-generate:active {
    background-image: url('/assets/Generate-video-btn-active.png');
    background-size: contain;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    }
    
    .btn-video-generate.processing {
    background-image: url('/assets/Generate-video-btn-active.png');
    background-size: contain;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    animation: pinkPulse 2s ease-in-out infinite;
    }

    .btn-video-generate:disabled:not(.processing) {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    animation: none;
    filter: none;
    }

    .btn-video-generate:disabled.processing {
    opacity: 1;
    cursor: wait;
    }

    @keyframes pinkPulse {
    0%, 100% {
      filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    }
    50% {
      filter: drop-shadow(0 0 22px rgba(255, 46, 166, 1)) drop-shadow(0 0 45px rgba(255, 46, 166, 0.8));
    }
    }

    .result-box {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-top: 0.5rem;
    }

    .result-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    }

    audio {
    width: 100%;
    margin-bottom: 0.5rem;
    }

    .generated-image {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    }

    .download-btn {
    padding: 0.5rem 1rem;
    background: rgba(139, 92, 246, 0.2);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    }

    .download-btn:hover {
    background: rgba(139, 92, 246, 0.3);
    border-color: var(--aetherwave-purple);
    }

    .input-wrapper {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    }

    input[type="text"] {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
    }

    input[type="text"]:focus {
    border-color: var(--aetherwave-pink);
    }

    input[type="text"]::placeholder {
    color: var(--text-muted);
    }

    .send-btn {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .send-btn:active {
    transform: translateY(0);
    }

    /* Suggested Prompts */
    .suggestions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
    }

    .suggestion-chip {
    padding: 0.4rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.75rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    }

    .suggestion-chip:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: var(--aetherwave-purple);
    color: var(--text-primary);
    }

    /* Use Case Cards */
    .use-case-card {
    position: relative;
    background: url('/assets/use-case-card-bg_1761537069997.png') no-repeat center center;
    background-size: 100% 100%;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem 0.4rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
    }

    .use-case-card:hover {
    border-color: var(--aetherwave-purple);
    filter: brightness(1.2);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
    }

    .use-case-card.selected {
        background: url('/assets/use-case-panel-1.gif') no-repeat;
        background-size: 100% 100%;
    border-color: var(--aetherwave-pink);
    filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 46, 166, 0.5));
    box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .use-case-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    filter: grayscale(0.3);
    transition: filter 0.3s ease;
    }

    .use-case-card:hover .use-case-icon {
    filter: grayscale(0);
    transform: scale(1.1);
    }

    .use-case-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
    }

    /* Tooltip Lightbox */
    .use-case-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: rgba(26, 22, 37, 0.98);
    border: 1px solid var(--aetherwave-purple);
    border-radius: 12px;
    padding: 1rem;
    width: 280px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 100;
    backdrop-filter: blur(12px);
    }

    .use-case-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--aetherwave-purple);
    }

    .use-case-card:hover .use-case-tooltip {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    pointer-events: auto;
    }

    .use-case-tooltip strong {
    display: block;
    color: var(--aetherwave-pink);
    font-size: 1rem;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip p {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip em {
    display: block;
    font-size: 0.75rem;
    color: var(--aetherwave-purple);
    font-style: italic;
    line-height: 1.4;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    }

    /* Media Type Toggle Buttons & Mode Toggle Buttons & Gender Toggle Buttons */
    .media-type-btn:hover,
    .mode-toggle-btn:hover,
    .gender-toggle-btn:hover {
    transform: translateY(-2px);
    filter: brightness(1.2);
    }

    .media-type-btn.active,
    .mode-toggle-btn.active,
    .gender-toggle-btn.active {
    background: url('/assets/Pick-btn-on_1761530040819.png') no-repeat center center !important;
    background-size: 100% 100% !important;
    color: #00F5A0 !important;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.8));
    }

    /* Generate Music Button Glow */
    #generate-music-btn:active {
    filter: drop-shadow(0 0 20px rgba(255, 46, 166, 0.9)) brightness(1.2);
    transform: scale(0.98);
    }


    /* ===== PREMIUM AUDIO PLAYER (Option 2) ===== */
    
    .premium-track-card {
      background: linear-gradient(135deg, rgba(26, 22, 37, 0.9), rgba(13, 11, 21, 0.95));
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .premium-track-card:hover {
      transform: translateY(-2px);
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 12px 48px rgba(139, 92, 246, 0.2);
    }

    .track-content {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    .track-artwork {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    .track-artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .track-duration-badge {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-artist {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .track-progress-container {
      margin-top: 0.75rem;
    }

    .track-progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 2px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .track-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s linear;
      position: relative;
    }

    .track-progress-fill::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .track-progress-bar:hover .track-progress-fill::after {
      opacity: 1;
    }

    .track-times {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .track-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .control-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(255, 46, 166, 0.5);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn-small {
      width: 36px;
      height: 36px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: none;
    }

    .control-btn-small:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.5);
    }

    .track-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(139, 92, 246, 0.1);
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .premium-track-card:hover .track-actions {
      opacity: 1;
      max-height: 100px;
    }

    .action-btn {
      flex: 1;
      padding: 0.625rem 1rem;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .action-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-1px);
    }

    /* Download Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .download-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .download-option {
      padding: 1rem;
      background: rgba(139, 92, 246, 0.08);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .download-option:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--aetherwave-purple);
    }

    .download-option-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .download-option-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .download-option-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .modal-btn {
      flex: 1;
      padding: 0.875rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .modal-btn-secondary {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .modal-btn-secondary:hover {
      background: rgba(139, 92, 246, 0.25);
    }

    /* ============================================
       MOBILE-FIRST RESPONSIVE DESIGN
       ============================================ */
    
    /* Bottom Navigation for Mobile */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(13, 11, 21, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0;
      z-index: 999;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .mobile-bottom-nav-items {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 0.5rem;
      gap: 0.25rem;
    }
    
    .mobile-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      padding: 0.4rem 0.5rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.65rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      max-width: 80px;
      min-width: 50px;
      height: 50px;
      touch-action: manipulation;
      border-radius: 6px;
    }
    
    .mobile-nav-btn img {
      width: 24px;
      height: 24px;
      opacity: 0.6;
      transition: all 0.2s;
    }
    
    .mobile-nav-btn.active {
      color: var(--aetherwave-purple);
    }
    
    .mobile-nav-btn.active img {
      opacity: 1;
      filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.6));
    }
    
    /* Tablet Breakpoint (768px - 1024px) */
    @media (max-width: 1024px) {
      /* Convert to two-column layout on tablets */
      .panels-container {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 1rem;
      }
      
      .hero-text {
        grid-column: 1 / 3;
        grid-row: 1 / 2;
        padding: 1.25rem 1.5rem;
      }
      
      .panel-music {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      
      .panel-chat {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
      }
      
      .panel-media {
        grid-column: 1 / 3;
        grid-row: 3 / 4;
      }
      
      /* Reduce padding */
      main {
        padding: 1rem;
      }
      
      header {
        padding: 0.5rem 1rem;
      }
      
      .panel-content {
        padding: 1rem;
      }
      
      /* Hide desktop nav links on tablets */
      nav a:not(.nav-btn) {
        display: none;
      }
    }
    
    /* Mobile Breakpoint (≤768px) */
    @media (max-width: 768px) {
      /* Prevent horizontal scrolling */
      html, body {
        overflow-x: hidden;
        width: 100vw;
        max-width: 100vw;
      }

      /* Fix body scrolling */
      body {
        min-height: 100dvh;
        overflow-x: hidden;
        overflow-y: auto;
      }

      /* Ensure all content respects viewport width */
      .container, .main-content, main, .content-wrapper {
        max-width: 100vw;
        overflow-x: hidden;
      }

      /* Fix any wide elements */
      img, video, iframe {
        max-width: 100%;
        height: auto;
      }
      
      /* Convert to single-column mobile layout */
      main {
        padding: 0.75rem 0.75rem 5rem 0.75rem;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }
      
      .panels-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: auto;
      }
      
      /* All panels stack vertically */
      .hero-text,
      .panel-music,
      .panel-chat,
      .panel-media {
        grid-column: unset;
        grid-row: unset;
        width: 100%;
      }
      
      /* Condense hero section on mobile */
      .hero-text {
        padding: 1rem;
        min-height: auto;
      }
      
      .hero-text h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      
      .subtitle {
        font-size: 0.85rem;
      }
      
      /* Hide panels by default on mobile */
      .panel-music,
      .panel-chat,
      .panel-media {
        display: none;
      }
      
      /* Show active panel */
      .panel-music.mobile-active,
      .panel-chat.mobile-active,
      .panel-media.mobile-active {
        display: flex;
      }
      
      /* Panel sizing for mobile */
      .panel {
        max-height: calc(100dvh - 200px);
        min-height: 400px;
      }
      
      .panel-content {
        padding: 1rem;
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Show mobile bottom nav */
      .mobile-bottom-nav {
        display: block;
      }

      /* Mobile navigation adjustments for small screens */
      .mobile-bottom-nav-items {
        padding: 0.25rem 0.5rem;
        gap: 0.15rem;
        max-width: 350px;
      }

      .mobile-nav-btn {
        padding: 0.3rem 0.4rem;
        max-width: 70px;
        min-width: 45px;
        height: 45px;
        font-size: 0.6rem;
        gap: 0.15rem;
      }

      .mobile-nav-btn img {
        width: 18px;
        height: 18px;
      }

      /* Header adjustments */
      header {
        padding: 0.5rem 0.75rem;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .logo {
        font-size: 1rem;
        gap: 0.5rem;
      }
      
      .logo-icon2 {
        width: 40px;
        height: 40px;
      }
      
      .logo-icon2 img {
        width: 35px !important;
        height: 35px !important;
      }
      
      .logo span img {
        height: 28px !important;
      }
      
      /* Hide all nav links except auth */
      nav {
        gap: 0.5rem;
      }
      
      nav a:not(.nav-btn) {
        display: none;
      }
      
      #user-profile img {
        width: 32px !important;
        height: 32px !important;
      }
      
      /* Ensure minimum touch targets (44px) */
      button,
      .nav-btn,
      .btn-primary,
      .btn-secondary,
      input[type="button"],
      input[type="submit"],
      .credits-indicator {
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
      }
      
      /* Touch-friendly form elements */
      input[type="text"],
      input[type="number"],
      textarea,
      select {
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
        touch-action: manipulation;
      }
      
      /* Prevent overscroll on modals */
      .modal-overlay {
        overscroll-behavior: contain;
      }

      /* Extra small mobile optimization (max-width: 320px) */
      @media (max-width: 320px) {
        #quest-modal .modal-content {
          width: 98%;
          max-width: 300px;
          padding: 0.75rem;
          margin: 0.25rem;
        }

        #quest-modal .modal-title {
          font-size: 1rem;
        }

        #quest-modal .modal-subtitle {
          font-size: 0.75rem;
        }

        #quest-list {
          gap: 0.5rem !important;
          margin-bottom: 0.75rem !important;
        }

        #quest-modal .modal-actions {
          margin-top: 0.75rem !important;
        }

        #quest-modal .modal-btn {
          padding: 0.5rem 1rem;
          font-size: 0.8rem;
        }
      }
      
      .modal-content {
        max-height: 90dvh;
        overflow-y: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Profile modal mobile optimization */
      #profile-modal .modal-content {
        width: 95%;
        max-width: 400px;
        padding: 1rem;
      }

      /* Quest modal mobile optimization */
      #quest-modal .modal-content {
        width: 92%;
        max-width: 320px;
        padding: clamp(0.5rem, 3vw, 1rem);
        margin: 0.5rem auto;
        box-sizing: border-box;
      }

      #quest-modal .modal-header {
        margin-bottom: clamp(0.75rem, 3vw, 1.5rem);
      }

      #quest-modal .modal-title {
        font-size: clamp(1.1rem, 4vw, 1.5rem);
        line-height: 1.2;
        margin-bottom: 0.25rem;
      }

      #quest-modal .modal-subtitle {
        font-size: clamp(0.75rem, 2.5vw, 0.9rem);
        line-height: 1.3;
      }

      #quest-modal .modal-actions {
        margin-top: clamp(0.75rem, 3vw, 1rem);
      }

      #quest-modal .modal-btn {
        padding: clamp(0.5rem, 2vw, 0.75rem) clamp(1rem, 4vw, 1.5rem);
        font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      }
      
      .profile-section {
        padding: 0.75rem;
      }
      
      /* Music generation form mobile */
      .form-group {
        gap: 0.5rem;
      }
      
      .form-group label {
        font-size: 0.9rem;
      }
      
      /* Media type buttons */
      .media-type-toggle {
        gap: 0.5rem;
      }
      
      .media-type-btn,
      .mode-toggle-btn,
      .gender-toggle-btn {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        min-height: 44px;
      }
      
      /* Use case grid mobile */
      .use-cases-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      .use-case-card {
        padding: 0.75rem;
      }
      
      .use-case-card img {
        width: 40px;
        height: 40px;
      }
      
      .use-case-name {
        font-size: 0.75rem;
      }
      
      /* Disable hover tooltips on mobile (use tap instead) */
      .use-case-tooltip {
        display: none;
      }
      
      /* Chat messages mobile */
      .message.user .message-content {
        margin-left: 0.5rem;
      }
      
      .message-content {
        padding: 0.875rem 1rem;
        font-size: 0.9rem;
      }
      
      /* Reduce animations on mobile for performance */
      .orb {
        opacity: 0.2;
        filter: blur(60px);
      }
      
      .bg-grid {
        opacity: 0.15;
      }
      
      /* Credits indicator mobile */
      .credits-indicator {
        min-width: 50px;
        min-height: 50px;
        font-size: 0.8rem;
      }
      
      /* Panel headers mobile */
      .panel-header {
        padding: 1rem;
      }
      
      .panel-title {
        font-size: 1rem;
      }
      
      .panel-description {
        font-size: 0.8rem;
      }
      
      /* Audio player mobile */
      audio {
        width: 100%;
        max-width: 100%;
      }
      
      /* Download buttons mobile */
      .download-btn,
      .btn-primary {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
      }
    }
    
    /* Extra small phones (≤375px) */
    @media (max-width: 375px) {
      .use-cases-grid {
        grid-template-columns: 1fr;
      }
      
      .mobile-nav-btn {
        font-size: 0.65rem;
        padding: 0.5rem 0.25rem;
      }
      
      .mobile-nav-btn img {
        width: 20px;
        height: 20px;
      }
    }
	.glowing{
	color: #00F5A0 !important;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.8));
	}
 }
  </style>

  <!-- Portal Welcome Section Styles -->
  <style>
  .portal-welcome-section {
    padding: 4rem 2rem;
    text-align: center;
    position: relative;
    z-index: 2;
  }

  .portal-welcome-container {
    max-width: 800px;
    margin: 0 auto;
  }

  .portal-welcome-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }

  .portal-icon {
    position: relative;
  }

  .portal-ring {
    width: 120px;
    height: 120px;
    position: relative;
    animation: portalPulse 3s ease-in-out infinite;
  }

  .portal-ring::before {
    content: '';
    position: absolute;
    inset: -15px;
    background: linear-gradient(45deg, #ff2ea6, #8b5cf6, #667eea, #764ba2);
    border-radius: 50%;
    animation: portalGlow 2s ease-in-out infinite;
    filter: blur(15px);
    opacity: 0.6;
  }

  .portal-core {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
    border: 3px solid #ff2ea6;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
    box-shadow: 0 8px 32px rgba(255, 46, 166, 0.3);
    animation: portalRotate 8s linear infinite;
  }

  .portal-core svg {
    color: #ff2ea6;
    animation: portalIconPulse 2s ease-in-out infinite;
  }

  .portal-text {
    max-width: 600px;
  }

  .portal-title {
    font-size: 3rem;
    font-weight: 700;
    background: linear-gradient(45deg, #ff2ea6, #8b5cf6, #667eea);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 3s ease-in-out infinite;
    margin-bottom: 1rem;
  }

  .portal-subtitle {
    font-size: 1.2rem;
    color: #e9e8ff;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .portal-description {
    font-size: 1rem;
    color: #b7b3d9;
    line-height: 1.6;
  }

  .portal-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .portal-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .portal-btn.primary {
    background: linear-gradient(45deg, #ff2ea6, #8b5cf6);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 46, 166, 0.4);
  }

  .portal-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(255, 46, 166, 0.6);
  }

  .portal-btn.secondary {
    background: rgba(30, 30, 46, 0.9);
    color: #e9e8ff;
    border: 2px solid rgba(255, 46, 166, 0.3);
    backdrop-filter: blur(10px);
  }

  .portal-btn.secondary:hover {
    background: rgba(255, 46, 166, 0.2);
    border-color: #ff2ea6;
    transform: translateY(-2px);
  }

  @keyframes portalPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  @keyframes portalGlow {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
  }

  @keyframes portalRotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes portalIconPulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
  }

  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  .portal-ring::after {
    content: '';
    position: absolute;
    width: 6px;
    height: 6px;
    background: #ff2ea6;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow:
      30px 0 0 #8b5cf6,
      -30px 0 0 #667eea,
      0 30px 0 #764ba2,
      0 -30px 0 #ff2ea6,
      20px 20px 0 #8b5cf6,
      -20px -20px 0 #667eea,
      20px -20px 0 #764ba2,
      -20px 20px 0 #ff2ea6;
    animation: portalParticles 3s linear infinite;
  }

  @keyframes portalParticles {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  @media (max-width: 768px) {
    .portal-welcome-section {
      padding: 2rem 1rem;
    }

    .portal-ring {
      width: 80px;
      height: 80px;
    }

    .portal-core svg {
      width: 30px;
      height: 30px;
    }

    .portal-title {
      font-size: 2rem;
    }

    .portal-actions {
      flex-direction: column;
      width: 100%;
      max-width: 300px;
    }

    .portal-btn {
      width: 100%;
      justify-content: center;
    }
  }
  </style>
</head>
<body>
  <div class="bg-container">
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
  </div>

  <header>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <a href="#" class="logo">
        <div class="logo-icon2">
          <img class="logo-icon2" src="https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2FLogo-SilverAlloy-Loop-1_1761279396703.gif?alt=media&token=57eb7fe9-fcd8-42fe-a845-b80a0347e2ad" alt="AetherWave Logo" style="width: 50px; height: 50px; object-fit: contain;">
        </div>
        <span>
          <img src="https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2Faws-banner_1761542850665.png?alt=media&token=fe7db850-1c11-4f93-a04d-2f5ac6678133" alt="AetherWave Studio" style="height: 40px; object-fit: contain;">
        </span>
      </a>
    </div>
   
	<!-- Navigation will be injected here -->
    <!--<div id="navigation-container"></div>-->
	<nav class="aether-nav">
				<ul>
					<li><a href="https://ai-hub.aetherwavestudio.com">AI-Hub</a></li>
					<li class="dropdown">
						<a href="https://aetherwavestudio.com/static/playlists.html">Playlists</a>
						<div class="dropdown-content">
							<a href="https://playlists.aetherwavestudio.com/darkwave/">DarkWave Essentials</a>
							<a href="https://playlists.aetherwavestudio.com/meditation/">Meditation Soundscapes</a>
							<a href="https://playlists.aetherwavestudio.com/coastal-pulse">Coastal Pulse</a>
							<a href="https://playlists.aetherwavestudio.com/synthwave-epic-loops">SynthWave Epic Loops</a>
						</div>
					</li>
					<li><a href="https://featured-artist.aetherwavestudio.com/">Featured Artist</a></li>
					<li class="dropdown">
						<a href="https://shop.aetherwavestudio.com">Shop</a>
						<div class="dropdown-content">
							<a href="https://shop.aetherwavestudio.com/coastal-pulse">Coastal Pulse</a>
							<a href="https://shop.aetherwavestudio.com/synthwave-epic-loops">SynthWave Epic Loops</a>
						</div>
					</li>
					<li><a href="https://docs.google.com/forms/d/e/1FAIpQLSfHYRDb7iRmNFIneGJNsEhQ1wpi5QQYbXKy9mwFUMP4htvOoQ/viewform?usp=header" target="_blank">Submit Music</a></li>
   
    <div id="auth-section" style="display: flex; align-items: center; gap: 1rem;">
      <a href="/api/login" class="nav-btn" id="login-btn" data-testid="button-login">Login</a>
      <div id="user-profile" style="display: none; align-items: center; gap: 0.75rem;">
        <!-- Credits Badge -->
        <div class="credits-indicator" data-testid="credits-display" onclick="showPaymentModal()" title="Click to view plans and upgrade" style="display: none;">
          <span id="credits-count">0</span>
        </div>
        <!-- Quest Gift Box Icon -->
        <div id="quest-gift-icon" onclick="showQuestModal()" style="display: none; cursor: pointer; position: relative; width: 40px; height: 40px; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255, 46, 166, 0.3);" onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 4px 16px rgba(255, 46, 166, 0.5)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(255, 46, 166, 0.3)'" title="Earn free credits by completing quests!">
          <span style="font-size: 1.3rem;">🎁</span>
          <div id="quest-notification-badge" style="display: none; position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #ff2ea6; border-radius: 50%; border: 2px solid var(--dark-bg); font-size: 0.65rem; font-weight: 700; color: white; display: flex; align-items: center; justify-content: center;"></div>
        </div>
        <div id="profile-trigger" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.25rem 0.75rem; border-radius: 20px; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'" onmouseout="this.style.background='transparent'" data-testid="button-profile">
          <img id="user-avatar" src="/assets/icon-set/profile-icon.png" alt="User" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--aetherwave-purple);">
          <span id="user-name" style="color: var(--text-primary); font-size: 0.9rem;" data-testid="text-username"></span>
        </div>
        <a href="/api/logout" class="nav-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;" data-testid="button-logout">Logout</a>
      </div>
    </div>
    </nav>
  </header>

  <main>

  <!-- Portal Welcome Section -->
  <section class="portal-welcome-section">
    <div class="portal-welcome-container">
      <div class="portal-welcome-content">
        <div class="portal-icon">
          <div class="portal-ring">
            <div class="portal-core">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 2v20M2 12h20"/>
                <path d="m15 9-3 3 3 3"/>
                <path d="m9 15 3-3-3-3"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="portal-text">
          <h1 class="portal-title">Welcome to AetherWave Studio</h1>
          <!--<p class="portal-subtitle">You've successfully passed through the portal from Ghost Musician</p>
          <p class="portal-description">-->
            Explore our AI-powered media generation tools and create stunning content with cutting-edge technology
          </p>
        </div>

        <div class="portal-actions">
          <button class="portal-btn primary" onclick="scrollToTools()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Explore AI Tools
          </button>

          <a href="/user/profile" class="portal-btn secondary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
            Return to Profile
          </a>
        </div>
      </div>
    </div>
  </section>

<div class="panels-container">
    <!-- Music Generation Panel 
    <div class="panel panel-music">
    <div class="panel-header">
    <div class="music-panel-header">
      <select id="music-model-header" class="version-dropdown" data-testid="select-version">
        <option value="V5">v5 (Premium) ▼</option>
        <option value="V4_5PLUS">v4.5+ (Premium) ▼</option>
        <option value="V4_5">v4.5 (Premium) ▼</option>
        <option value="V4" selected>v4 (Free) ▼</option>
        <option value="V3_5">v3.5 (Free) ▼</option>
      </select>
    </div>
    Hero Section -->
   <!-- <div class="hero-text">
    <h1>AI Music and Media Center</h1>
    <p class="subtitle">Create music, chat with AI, and generate album art - all in one creative studio</p>
    </div>-->

    <!-- Chat Panel -->
    <div class="panel panel-chat">
    <div class="panel-header"style="background-image: url('https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2FGlowing_smaller.gif?alt=media&token=1af867a1-5e5b-446c-bc62-f8cd6b311a72')";>
    <div class="panel-title"><img src="https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/Icon%20Set%20Black%2FChat.png?alt=media&token=06f024db-dbc2-4400-ad2d-6b7b3e061d12" style="width: 50px; height: 50px; margin-right: 0.3rem; margin-top: 15px; margin-left: 15px; vertical-align: middle;"> </div>
    <div class="panel-description"></div>
    </div>
    <div class="panel-content">
    <div class="chat-messages">
    <div class="message assistant">
    <div class="message-label">AetherWave AI</div>
    <div class="message-content">
    Hello! I can help you create music, generate album art, or answer questions about AetherWave Studio. What would you like to create today?
    </div>
    </div>
    </div>
    </div>
    <div class="chat-input-area">
    <div class="input-wrapper">
    <input type="text" id="chat-input" placeholder="Ask me anything..." style="background-image: url("https://firebasestorage.googleapis.com/v0/b/aetherwave-playlists.firebasestorage.app/o/global-assets%2FBlack_Surface.png?alt=media&token=06d4bfdc-41d8-4d55-bbfd-5756c5d63845")";/>
    <button class="send-btn" id="send-btn">Send</button>
    </div>
    <div class="suggestions">
    <div class="suggestion-chip">Prompts for Music</div>
    <div class="suggestion-chip">Lyric Generation</div>
    <div class="suggestion-chip">Album Art tips</div>
    </div>
    </div>
    </div>
</div>

  <script>
    // Error handling wrapper
    window.addEventListener('error', (e) => {
    console.error('Global error:', e.message, e.filename, e.lineno, e.colno);
    });

    // Global user state
    let currentUser = null;
    let userCredits = 0;

    // Check authentication status and update UI
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/user', { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          
          // Store user data globally for profile modal
          currentUser = user;
          
          // Fetch user credits
          const creditsResponse = await fetch('/api/user/credits', { credentials: 'include' });
          if (creditsResponse.ok) {
            const creditsData = await creditsResponse.json();
            userCredits = creditsData.credits || 0;
          }
          
          // User is logged in
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('user-profile').style.display = 'flex';
          
          // Truncate username to 20 characters
          const fullName = user.firstName || user.email || 'User';
          const displayName = fullName.length > 20 ? fullName.substring(0, 20) + '...' : fullName;
          document.getElementById('user-name').textContent = displayName;
          
          // Always use the profile icon
          document.getElementById('user-avatar').src = '/assets/icon-set/profile-icon.png';
          document.getElementById('user-avatar').alt = user.firstName || user.email || 'User';
          
          // Load user's vocal gender preference
          if (user.vocalGenderPreference) {
            const genderBtn = document.querySelector(`.gender-toggle-btn[data-gender="${user.vocalGenderPreference}"]`);
            if (genderBtn) {
              document.querySelectorAll('.gender-toggle-btn').forEach(b => b.classList.remove('active'));
              genderBtn.classList.add('active');
              document.getElementById('vocal-gender-value').value = user.vocalGenderPreference;
            }
          }
          
          // Attach event listener to profile trigger (after profile section is shown)
          const profileTrigger = document.getElementById('profile-trigger');
          if (profileTrigger && !profileTrigger.hasAttribute('data-listener-attached')) {
            profileTrigger.addEventListener('click', function() {
              console.log('Profile trigger clicked - navigating to user profile page');
              // Navigate to the full GhostMusician user profile page
              window.location.href = `/ghost-musician/user/${user.id}`;
            });
            profileTrigger.setAttribute('data-listener-attached', 'true');
            console.log('Profile trigger event listener attached');
          }
        } else {
          // User not logged in
          document.getElementById('login-btn').style.display = 'inline-block';
          document.getElementById('user-profile').style.display = 'none';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Show login button on error
        document.getElementById('login-btn').style.display = 'inline-block';
        document.getElementById('user-profile').style.display = 'none';
      }
    }

    // Check auth on page load
    checkAuth();

    // Mobile Navigation Controller
    function initMobileNavigation() {
      const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
      const panels = {
        music: document.querySelector('.panel-music'),
        chat: document.querySelector('.panel-chat'),
        media: document.querySelector('.panel-media')
      };
      
      // Set initial active panel (music)
      if (window.innerWidth <= 768) {
        panels.music.classList.add('mobile-active');
        panels.chat.classList.remove('mobile-active');
        panels.media.classList.remove('mobile-active');
      }
      
      // Handle mobile nav clicks
      mobileNavBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const targetPanel = this.getAttribute('data-panel');
          
          // Update button states
          mobileNavBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update panel visibility (only on mobile)
          if (window.innerWidth <= 768) {
            Object.keys(panels).forEach(key => {
              if (key === targetPanel) {
                panels[key].classList.add('mobile-active');
                panels[key].scrollIntoView({ behavior: 'smooth', block: 'start' });
              } else {
                panels[key].classList.remove('mobile-active');
              }
            });
          }
        });
      });
      
      // Handle window resize - clean up mobile classes on desktop
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          if (window.innerWidth > 768) {
            // Desktop mode - remove mobile-active classes
            Object.values(panels).forEach(panel => {
              panel.classList.remove('mobile-active');
            });
          } else {
            // Mobile mode - ensure one panel is active
            const hasActive = Array.from(Object.values(panels)).some(p => p.classList.contains('mobile-active'));
            if (!hasActive) {
              panels.music.classList.add('mobile-active');
            }
          }
        }, 250);
      });
    }
    
    // Initialize mobile navigation on page load
    initMobileNavigation();

    // Credit Management
    let userPlanType = 'free';
    
    async function fetchUserCredits() {
      try {
        const response = await fetch('/api/user/credits', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          userCredits = data.credits;
          userPlanType = data.planType;
          updateCreditsDisplay();
          
          // Apply quality restrictions based on media type
          if (selectedMediaType === 'video') {
            applyVideoQualityRestrictions();
          } else {
            applyImageEngineRestrictions();
          }
          
          // Auto-check for daily reset
          await checkDailyReset();
        } else if (response.status === 401) {
          // User not authenticated - hide credits display
          const creditsIndicator = document.querySelector('.credits-indicator');
          if (creditsIndicator) {
            creditsIndicator.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Failed to fetch credits:', error);
        // Hide credits on error
        const creditsIndicator = document.querySelector('.credits-indicator');
        if (creditsIndicator) {
          creditsIndicator.style.display = 'none';
        }
      }
    }
    
    async function checkDailyReset() {
      try {
        const response = await fetch('/api/user/credits/check-reset', { method: 'POST', credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          if (data.resetOccurred) {
            userCredits = data.credits;
            updateCreditsDisplay();
            showNotification('Daily credits reset! You now have 50 credits.', 'success');
          }
        }
      } catch (error) {
        console.error('Failed to check daily reset:', error);
      }
    }
    
    function updateCreditsDisplay() {
      const creditsElement = document.getElementById('credits-count');
      const creditsIndicator = document.querySelector('.credits-indicator');
      const questGiftIcon = document.getElementById('quest-gift-icon');

      if (creditsElement && creditsIndicator) {
        // Show the indicator
        creditsIndicator.style.display = 'flex';

        if (userPlanType === 'studio' || userPlanType === 'creator' || userPlanType === 'all_access') {
          creditsElement.textContent = '∞';
          creditsIndicator.title = 'Unlimited music credits - Click to view plans';
          // Hide quest icon for paid users
          if (questGiftIcon) questGiftIcon.style.display = 'none';
        } else {
          creditsElement.textContent = userCredits;
          creditsIndicator.title = `${userCredits} credits remaining - Click to upgrade`;
          // Show quest icon for free users
          if (questGiftIcon) questGiftIcon.style.display = 'flex';
          // Load and check for uncompleted quests
          loadQuests();
        }
      }
    }

    // ===== QUEST SYSTEM FUNCTIONS =====

    let userQuests = [];

    async function loadQuests() {
      try {
        const response = await fetch('/api/quests');
        if (!response.ok) throw new Error('Failed to load quests');

        const data = await response.json();
        userQuests = data.quests;

        // Update notification badge
        const uncompletedCount = userQuests.filter(q => !q.completed).length;
        const badge = document.getElementById('quest-notification-badge');
        if (badge) {
          if (uncompletedCount > 0) {
            badge.textContent = uncompletedCount;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }

        return data;
      } catch (error) {
        console.error('Error loading quests:', error);
        return null;
      }
    }

    async function showQuestModal() {
      const modal = document.getElementById('quest-modal');
      const questList = document.getElementById('quest-list');

      modal.style.display = 'flex';

      // Load quests
      const data = await loadQuests();
      if (!data) {
        questList.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            Failed to load quests. Please try again later.
          </div>
        `;
        return;
      }

      // Render quests
      questList.innerHTML = userQuests.map(quest => {
        const completed = quest.completed;
        const icon = getQuestIcon(quest.type);
        const buttonText = completed ? '✓ Completed' : `Complete (+${quest.reward} credits)`;
        const buttonDisabled = completed ? 'disabled' : '';
        const questUrl = getQuestUrl(quest.type);

        return `
          <div style="background: ${completed ? 'rgba(46, 213, 115, 0.1)' : 'rgba(139, 92, 246, 0.1)'}; border: 2px solid ${completed ? 'rgba(46, 213, 115, 0.3)' : 'rgba(139, 92, 246, 0.3)'}; border-radius: 12px; padding: clamp(0.75rem, 3vw, 1.25rem); display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); flex-shrink: 0;">${icon}</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: clamp(0.9rem, 2.5vw, 1rem); color: var(--text-primary); margin-bottom: 0.25rem;">
                  ${quest.name}
                </div>
                <div style="font-size: clamp(0.75rem, 2vw, 0.85rem); color: var(--text-muted); line-height: 1.3;">
                  ${quest.description}
                </div>
              </div>
              <div style="text-align: right; flex-shrink: 0;">
                <div style="font-size: clamp(1rem, 2.5vw, 1.1rem); font-weight: 700; color: var(--aetherwave-pink); margin-bottom: 0.5rem;">
                  +${quest.reward}
                </div>
              </div>
            </div>
            <div style="display: flex; justify-content: center;">
              ${completed ?
                `<button style="padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.8rem, 3vw, 1rem); background: rgba(46, 213, 115, 0.2); border: 1px solid rgba(46, 213, 115, 0.5); border-radius: 8px; color: #2ed573; font-weight: 600; font-size: clamp(0.75rem, 2vw, 0.85rem); cursor: not-allowed; width: 100%;" disabled>${buttonText}</button>` :
                `<div style="display: flex; gap: 0.5rem; width: 100%;">
                  <a href="${questUrl}" target="_blank" style="flex: 1; padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.6rem, 2vw, 0.8rem); background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: clamp(0.7rem, 2vw, 0.75rem); cursor: pointer; text-decoration: none; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">1. Follow/Join</a>
                  <button onclick="confirmQuestCompletion('${quest.type}')" style="flex: 1; padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.6rem, 2vw, 0.8rem); background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: clamp(0.7rem, 2vw, 0.75rem); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(255, 46, 166, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">2. Claim Credits</button>
                </div>`
              }
            </div>
          </div>
        `;
      }).join('');
    }

    function closeQuestModal() {
      const modal = document.getElementById('quest-modal');
      modal.style.display = 'none';
    }

    function confirmQuestCompletion(questType) {
      const questNames = {
        twitter_follow: 'Follow us on X.com',
        discord_join: 'Join our Discord server',
        facebook_follow: 'Follow us on Facebook',
        tiktok_follow: 'Follow us on TikTok'
      };

      const questName = questNames[questType] || 'Complete quest';

      // Show confirmation dialog
      const confirmed = confirm(
        `Have you actually completed the quest?\n\n` +
        `Quest: ${questName}\n` +
        `Reward: 20 credits\n\n` +
        `Please confirm that you have completed this action. ` +
        `False claims may affect your account status.`
      );

      if (confirmed) {
        completeQuest(questType);
      }
    }

    function getQuestIcon(type) {
      const icons = {
        twitter_follow: '🐦',
        discord_join: '💬',
        facebook_follow: '👍',
        tiktok_follow: '🎵'
      };
      return icons[type] || '⭐';
    }

    function getQuestUrl(type) {
      const urls = {
        twitter_follow: 'https://x.com/aetherwave_ai',
        discord_join: 'https://discord.gg/BVRHUfZS',
        facebook_follow: 'https://facebook.com/AetherWaveStudio',
        tiktok_follow: 'https://tiktok.com/@AetherWaveStudio'
      };
      return urls[type] || '#';
    }

    async function completeQuest(questType) {
      try {
        showNotification('Completing quest...', 'info');

        const response = await fetch('/api/quests/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ questType })
        });

        if (!response.ok) {
          const data = await response.json();
          showNotification(data.error || 'Failed to complete quest', 'error');
          return;
        }

        const data = await response.json();
        userCredits = data.newBalance;
        updateCreditsDisplay();
        showNotification(data.message, 'success');

        // Reload quest modal to show updated completion status
        await loadQuests(); // Reload quests first
        showQuestModal(); // Then refresh modal

      } catch (error) {
        console.error('Error completing quest:', error);
        showNotification('Failed to complete quest', 'error');
      }
    }

    // ===== END QUEST SYSTEM =====

    function applyVideoQualityRestrictions() {
      const videoModel = document.getElementById('media-video-model');
      const resolution = document.getElementById('media-resolution');
      const duration = document.getElementById('media-duration');

      // Check if elements exist before accessing them
      if (!videoModel || !resolution || !duration) {
        console.warn('Video quality restriction elements not found');
        return;
      }

      if (userPlanType === 'free') {
        // Free accounts can only use lowest settings
        videoModel.value = 'seedance-lite';
        resolution.value = '480p';
        duration.value = '5';

        // Disable all dropdowns
        videoModel.disabled = true;
        resolution.disabled = true;
        duration.disabled = true;

        // Add visual indicator
        videoModel.style.opacity = '0.6';
        resolution.style.opacity = '0.6';
        duration.style.opacity = '0.6';

        // Add tooltips
        videoModel.title = 'Upgrade to access higher quality models';
        resolution.title = 'Upgrade to access higher resolutions';
        duration.title = 'Upgrade to access longer durations';
      } else {
        // Paid accounts can use all settings
        videoModel.disabled = false;
        resolution.disabled = false;
        duration.disabled = false;

        videoModel.style.opacity = '1';
        resolution.style.opacity = '1';
        duration.style.opacity = '1';

        videoModel.title = '';
        resolution.title = '';
        duration.title = '';
      }
    }

    function applyImageEngineRestrictions() {
      const imageEngine = document.getElementById('media-image-engine');

      // Check if element exists
      if (!imageEngine) {
        return;
      }

      if (userPlanType === 'free') {
        // Free accounts can only use Nano Banana
        imageEngine.value = 'nano-banana';
        
        // Disable DALL-E 3 and Midjourney options
        const dallE3Option = imageEngine.querySelector('option[value="dall-e-3"]');
        if (dallE3Option) {
          dallE3Option.disabled = true;
        }
        
        const midjourneyOption = imageEngine.querySelector('option[value="midjourney"]');
        if (midjourneyOption) {
          midjourneyOption.disabled = true;
        }
      } else {
        // Paid accounts (Studio+) can use all engines
        const dallE3Option = imageEngine.querySelector('option[value="dall-e-3"]');
        if (dallE3Option) {
          dallE3Option.disabled = false;
        }
        
        const midjourneyOption = imageEngine.querySelector('option[value="midjourney-ttapi"]');
        if (midjourneyOption) {
          midjourneyOption.disabled = false;
        }
      }

      // Trigger visibility update for Midjourney speed selector
      updateMidjourneySpeedVisibility();
    }

    function updateMidjourneySpeedVisibility() {
      const imageEngine = document.getElementById('media-image-engine');
      const speedGroup = document.getElementById('midjourney-speed-group');
      
      if (imageEngine && speedGroup) {
        const isMidjourney = imageEngine.value === 'midjourney-ttapi';
        speedGroup.style.display = isMidjourney ? 'block' : 'none';
      }
    }

    function updateEngineDescription() {
      const imageEngine = document.getElementById('media-image-engine');
      const descriptionEl = document.getElementById('engine-description');
      
      if (!imageEngine || !descriptionEl) return;
      
      const descriptions = {
        'nano-banana': 'Nano Banana: Lightning-fast generation (~5s) with professional results. Best for quick iterations!',
        'dall-e-3': 'DALL-E 3: High-quality, creative AI images with precise prompt following (~10s)',
        'midjourney-ttapi': 'Midjourney: Premium artistic quality with reliable performance (~30-40s). 4 variants per generation!'
      };
      
      descriptionEl.textContent = descriptions[imageEngine.value] || descriptions['nano-banana'];
      descriptionEl.style.color = 'var(--text-muted)';
    }

    // Add event listener for image engine changes
    const imageEngineSelector = document.getElementById('media-image-engine');
    if (imageEngineSelector) {
      imageEngineSelector.addEventListener('change', function() {
        updateMidjourneySpeedVisibility();
        updateEngineDescription();
      });
    }
    
    
    async function deductCredits(amount = 5) {
      try {
        const response = await fetch('/api/user/credits/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount })
        });
        
        if (!response.ok) {
          const data = await response.json();
          if (response.status === 403) {
            // Insufficient credits - show payment modal
            showPaymentModal();
            throw new Error('Insufficient credits');
          }
          throw new Error(data.message || 'Failed to deduct credits');
        }
        
        const data = await response.json();
        userCredits = data.credits;
        updateCreditsDisplay();
        return true;
      } catch (error) {
        console.error('Failed to deduct credits:', error);
        throw error;
      }
    }
    
    function showPaymentModal() {
      const modal = document.createElement('div');
      modal.id = 'payment-modal';
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(13, 11, 21, 0.95);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        animation: fadeIn 0.3s ease-out;
      `;
      
      modal.innerHTML = `
        <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.4s ease-out; overflow: hidden;">
          <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
            <h2 style="font-size: clamp(1.5rem, 5vw, 1.75rem); font-weight: 700; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
              Upgrade Your Plan
            </h2>
            <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: clamp(0.85rem, 2.5vw, 0.95rem);">
              You've run out of credits! Choose a plan to continue creating amazing content.
            </p>
          </div>
          
          <div style="flex: 1; overflow-y: auto; overflow-x: hidden;">
          
          
          <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            
            <!-- Free Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/music-icon.png" style="width: 40px; height: 40px;"></div>
                <h3 style="font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Free</h3>
                <div style="font-size: clamp(1.5rem, 4vw, 1.75rem); font-weight: 700; color: var(--text-primary);">$0<span style="font-size: clamp(0.75rem, 2vw, 0.85rem); font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>50 credits/day</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Basic music gen</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Standard quality</span>
                </li>
              </ul>
              <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 0.65rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                Current Plan
              </div>
            </div>

            <!-- Starter Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/video-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Starter</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$9.99<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">200</strong> media credits/mo</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">SORA 2</strong> video access</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>No watermarks</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Basic music gen</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>WAV conversion</span>
                </li>
              </ul>
              <button onclick="contactSupport('Starter')" style="width: 100%; padding: clamp(0.6rem, 2vw, 0.75rem); background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: clamp(0.8rem, 2.5vw, 0.9rem); transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Upgrade
              </button>
            </div>

            <!-- Studio Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/microphone-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Studio</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$19<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music (all models)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> WAV conversion</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>500 media credits/mo</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Lite videos (all resolutions)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Commercial license</span>
                </li>
              </ul>
              <button onclick="contactSupport('Studio')" style="width: 100%; padding: clamp(0.6rem, 2vw, 0.75rem); background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: clamp(0.8rem, 2.5vw, 0.9rem); transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Upgrade
              </button>
            </div>
            
            <!-- Creator Plan -->
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 46, 166, 0.05)); border: 2px solid var(--aetherwave-purple); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0.75rem; right: 0.75rem; background: var(--aetherwave-purple); color: white; font-size: 0.65rem; font-weight: 600; padding: 0.3rem 0.65rem; border-radius: 12px;">POPULAR</div>
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/camera1-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Creator</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$49<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music (all models)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> WAV conversion</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">2000</strong> media credits/mo</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Lite & Pro videos (all resolutions)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>All image engines</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Commercial license</span>
                </li>
              </ul>
              <button onclick="contactSupport('Creator')" style="width: 100%; padding: clamp(0.6rem, 2vw, 0.75rem); background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: clamp(0.8rem, 2.5vw, 0.9rem); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255, 46, 166, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                Upgrade
              </button>
            </div>
            
            <!-- All Access Pass -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/lightning-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">All Access</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$99<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music (all models)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> WAV conversion</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">5000</strong> media credits/mo (rate-limited)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Lite & Pro videos (all resolutions including 4K)</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>All image engines</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Commercial license</span>
                </li>
                <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">API access</strong> & priority support</span>
                </li>
              </ul>
              <button onclick="contactSupport('All Access')" style="width: 100%; padding: clamp(0.6rem, 2vw, 0.75rem); background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: clamp(0.8rem, 2.5vw, 0.9rem); transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Upgrade
              </button>
            </div>
          </div>
          
          <!-- Credit Bundles Section -->
          <div style="padding: 0 2rem 2rem 2rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">💎 One-Time Credit Bundles</h3>
              <p style="color: var(--text-muted); font-size: 0.9rem;">No subscription needed - purchase credits as you need them</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem;">
              
              <!-- Starter Bundle -->
              <div style="background: rgba(6, 182, 212, 0.05); border: 2px solid rgba(6, 182, 212, 0.3); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
                <div style="text-align: center; margin-bottom: 1.25rem;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">💎</div>
                  <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Starter Bundle</h3>
                  <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$10<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);"> one-time</span></div>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span><strong style="color: var(--text-primary);">250</strong> credits</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>Never expires</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>50 music generations</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>$0.04 per credit</span>
                  </li>
                </ul>
                <button onclick="purchaseBundle('Starter Bundle', 250, 10)" style="width: 100%; padding: 0.75rem; background: rgba(6, 182, 212, 0.2); color: var(--text-primary); border: 1px solid rgba(6, 182, 212, 0.4); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(6, 182, 212, 0.3)'; this.style.borderColor='var(--aetherwave-cyan)'" onmouseout="this.style.background='rgba(6, 182, 212, 0.2)'; this.style.borderColor='rgba(6, 182, 212, 0.4)'">
                  Purchase Now
                </button>
              </div>
              
              <!-- Power Bundle -->
              <div style="background: rgba(6, 182, 212, 0.05); border: 2px solid rgba(6, 182, 212, 0.3); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column; position: relative;">
                <div style="position: absolute; top: 0.75rem; right: 0.75rem; background: var(--aetherwave-cyan); color: white; font-size: 0.65rem; font-weight: 600; padding: 0.3rem 0.65rem; border-radius: 12px;">BEST VALUE</div>
                <div style="text-align: center; margin-bottom: 1.25rem;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">💎💎</div>
                  <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Power Bundle</h3>
                  <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$25<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);"> one-time</span></div>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span><strong style="color: var(--text-primary);">750</strong> credits</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>Never expires</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>150 music generations</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: clamp(0.75rem, 2vw, 0.85rem); padding: 0.3rem 0; display: flex; align-items: center; gap: 0.4rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span><strong style="color: var(--text-primary);">$0.033</strong> per credit</span>
                  </li>
                </ul>
                <button onclick="purchaseBundle('Power Bundle', 750, 25)" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, rgba(6, 182, 212, 0.4), rgba(6, 182, 212, 0.2)); color: var(--text-primary); border: 1px solid var(--aetherwave-cyan); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(6, 182, 212, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                  Purchase Now
                </button>
              </div>
              
            </div>
          </div>
          </div>
          
          <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: center; flex-shrink: 0;">
            <button onclick="closePaymentModal()" style="padding: 0.75rem 2rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--aetherwave-purple)'; this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-muted)'">
              Maybe Later
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function closePaymentModal() {
      const modal = document.getElementById('payment-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => modal.remove(), 300);
      }
    }
    
    function contactSupport(planName) {
      alert(`To upgrade to ${planName}, please contact Replit support or the application developer. Payment integration coming soon!`);
      closePaymentModal();
    }
    
    function purchaseBundle(bundleName, credits, price) {
      alert(`To purchase ${bundleName} (${credits} credits for $${price}), please contact the application developer. Payment integration coming soon!`);
      closePaymentModal();
    }
    
    window.showProfileModal = function showProfileModal() {
      console.log('Profile modal function called, currentUser:', currentUser);
      if (!currentUser) {
        showNotification('Please log in to view your profile');
        return;
      }
      
      const modal = document.createElement('div');
      modal.id = 'profile-modal';
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(13, 11, 21, 0.95);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.3s ease-out;
      `;
      
      const planNames = {
        'free': 'Free',
        'studio': 'Studio Member',
        'creator': 'Creator',
        'all_access': 'All Access Pass'
      };
      
      const planName = planNames[currentUser.subscriptionPlan] || 'Free';
      
      modal.innerHTML = `
        <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.4s ease-out; overflow: hidden;">
          <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background: url('/assets/header-panel_1761541736595.png') no-repeat center center; background-size: cover;">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem;">
              <img src="${currentUser.profileImageUrl || '/assets/icon-set/profile-icon.png'}" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--aetherwave-purple); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);">
              <div>
                <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                  ${currentUser.username || currentUser.email || 'User'}
                </h2>
                <p style="color: var(--text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">
                  ${currentUser.email || ''}
                </p>
              </div>
            </div>
          </div>
          
          <div style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 2rem;">
            
            <!-- Account Info -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/icon-set/star-icon.png" style="width: 20px; height: 20px;">
                Account Details
              </h3>
              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="display: grid; gap: 1rem;">
                  <div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Username</div>
                    <div style="color: var(--text-primary); font-weight: 500;">${currentUser.username || 'Not set'}</div>
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Email</div>
                    <div style="color: var(--text-primary); font-weight: 500;">${currentUser.email || 'Not set'}</div>
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">User ID</div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; font-family: monospace;">${currentUser.id}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Subscription Info -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/icon-set/lightning-icon.png" style="width: 20px; height: 20px;">
                Subscription Plan
              </h3>
              <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 46, 166, 0.05)); border: 2px solid var(--aetherwave-purple); border-radius: 12px; padding: 1.25rem;">
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                  ${planName}
                </div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                  ${currentUser.subscriptionPlan === 'free' ? 'Upgrade to unlock unlimited features' : 'Thank you for being a premium member!'}
                </div>
                <button onclick="closeProfileModal(); showPaymentModal();" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                  ${currentUser.subscriptionPlan === 'free' ? 'Upgrade Plan' : 'Manage Subscription'}
                </button>
              </div>
            </div>
            
            <!-- Credits Info -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/Coins_badge_1761542949252.png" style="width: 24px; height: 24px;">
                Credits Balance
              </h3>
              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                  ${userCredits.toLocaleString()} credits
                </div>
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.75rem;">
                  ${currentUser.subscriptionPlan === 'free' ? 'Resets daily at midnight' : 'Unlimited for your plan'}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.85rem;">
                  <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                    <div style="color: var(--text-muted); margin-bottom: 0.25rem;">Music Cost</div>
                    <div style="color: var(--text-primary); font-weight: 600;">5 credits</div>
                  </div>
                  <div style="padding: 0.75rem; background: rgba(255, 46, 166, 0.1); border-radius: 8px;">
                    <div style="color: var(--text-muted); margin-bottom: 0.25rem;">Image Cost</div>
                    <div style="color: var(--text-primary); font-weight: 600;">3 credits</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Free Band Generations -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                🎸
                Free Band Generations
              </h3>
              <div style="background: linear-gradient(135deg, rgba(255, 46, 166, 0.1), rgba(139, 92, 246, 0.1)); border: 2px solid var(--aetherwave-pink); border-radius: 12px; padding: 1.25rem;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                  ${currentUser.freeBandGenerations || 0} / 3 Free Bands
                </div>
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.75rem;">
                  Create virtual artists in GhostMusician RPG
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; font-size: 0.85rem;">
                  <div style="color: var(--text-muted); margin-bottom: 0.25rem;">After free bands</div>
                  <div style="color: var(--text-primary); font-weight: 600;">15 credits per band</div>
                </div>
              </div>
            </div>
            
            <!-- Preferences -->
            <div>
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/icon-set/microphone-icon.png" style="width: 20px; height: 20px;">
                Preferences
              </h3>
              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Default Vocal Gender</div>
                <div style="color: var(--text-primary); font-weight: 500; text-transform: capitalize;">
                  ${currentUser.vocalGenderPreference === 'm' ? 'Male' : currentUser.vocalGenderPreference === 'f' ? 'Female' : 'Male'}
                </div>
              </div>
            </div>
            
          </div>
          
          <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: space-between; flex-shrink: 0;">
            <a href="/api/logout" style="padding: 0.75rem 1.5rem; background: rgba(244, 63, 94, 0.1); color: rgb(244, 63, 94); border: 1px solid rgba(244, 63, 94, 0.3); border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-decoration: none; display: inline-block;" onmouseover="this.style.background='rgba(244, 63, 94, 0.2)'" onmouseout="this.style.background='rgba(244, 63, 94, 0.1)'">
              Logout
            </a>
            <button onclick="closeProfileModal()" style="padding: 0.75rem 2rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
              Close
            </button>

    const playIcon = card.querySelector('.play-icon');
    const pauseIcon = card.querySelector('.pause-icon');
    
    // Pause all other tracks
    this.audioElements.forEach((otherAudio, otherId) => {
      if (otherId !== trackId && !otherAudio.paused) {
        otherAudio.pause();
        const otherCard = document.querySelector(`[data-track-id="${otherId}"]`);
        if (otherCard) {
          const otherPlayIcon = otherCard.querySelector('.play-icon');
          const otherPauseIcon = otherCard.querySelector('.pause-icon');
          if (otherPlayIcon) otherPlayIcon.style.display = 'block';
          if (otherPauseIcon) otherPauseIcon.style.display = 'none';
        }
      }
    });
    
    if (audio.paused) {
      audio.play();
      if (playIcon) playIcon.style.display = 'none';
      if (pauseIcon) pauseIcon.style.display = 'block';
      this.currentTrack = trackId;
    } else {
      audio.pause();
      if (playIcon) playIcon.style.display = 'block';
      if (pauseIcon) pauseIcon.style.display = 'none';
    }
  },

  seek(trackId, event) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const percentage = x / rect.width;
    
    audio.currentTime = percentage * audio.duration;
  },

  previous(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    // If more than 3 seconds in, restart current track
    if (audio.currentTime > 3) {
      audio.currentTime = 0;
    } else {
      // Go to previous track
      const trackIds = Array.from(this.audioElements.keys());
      const currentIndex = trackIds.indexOf(trackId);
      if (currentIndex > 0) {
        this.togglePlay(trackIds[currentIndex - 1]);
      }
    }
  },

  next(trackId) {
    const trackIds = Array.from(this.audioElements.keys());
    const currentIndex = trackIds.indexOf(trackId);
    if (currentIndex < trackIds.length - 1) {
      this.togglePlay(trackIds[currentIndex + 1]);
    }
  },

  formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  },

  openDownloadModal(trackId, title, url) {
    this.downloadData = { trackId, title, url };
    this.selectedFormat = 'mp3';
    
    const modal = document.getElementById('download-modal');
    const modalTitle = document.getElementById('modal-track-title');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modal) modal.style.display = 'flex';
    
    // Reset download button text
    const downloadBtn = document.querySelector('[data-testid="button-modal-download"]');
    if (downloadBtn) downloadBtn.textContent = 'Download';
    
    // Reset selection UI
    document.querySelectorAll('.download-option').forEach(opt => {
      opt.style.background = 'rgba(139, 92, 246, 0.08)';
      opt.style.borderColor = 'var(--border-color)';
    });
    
    // Highlight MP3 by default
    const mp3Option = document.querySelector('[data-testid="option-mp3"]');
    if (mp3Option) {
      mp3Option.style.background = 'rgba(139, 92, 246, 0.15)';
      mp3Option.style.borderColor = 'var(--aetherwave-purple)';
    }
    
    // Add Pro badge to WAV option for free users
    const wavOption = document.querySelector('[data-testid="option-wav"]');
    if (wavOption && userPlanType === 'free') {
      // Add visual "locked" state
      wavOption.style.opacity = '0.6';
      wavOption.style.cursor = 'not-allowed';
      
      // Add Pro badge if not already present
      const wavTitle = wavOption.querySelector('.download-option-title');
      if (wavTitle && !wavTitle.querySelector('.pro-badge')) {
        const badge = document.createElement('span');
        badge.className = 'pro-badge';
        badge.textContent = 'PRO';
        badge.style.cssText = 'margin-left: 0.5rem; padding: 0.125rem 0.5rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; font-size: 0.65rem; font-weight: 700; border-radius: 4px; vertical-align: middle;';
        wavTitle.appendChild(badge);
      }
    } else if (wavOption && userPlanType !== 'free') {
      // Remove locked state for paid users
      wavOption.style.opacity = '1';
      wavOption.style.cursor = 'pointer';
      const badge = wavOption.querySelector('.pro-badge');
      if (badge) badge.remove();
    }
  },

  closeDownloadModal() {
    const modal = document.getElementById('download-modal');
    if (modal) modal.style.display = 'none';
  },

  selectFormat(format) {
    // Check if user is trying to select WAV on free plan
    if (format === 'wav' && userPlanType === 'free') {
      // Show upgrade notification
      const wavOption = document.querySelector('[data-testid="option-wav"]');
      if (wavOption) {
        // Visual feedback - shake animation
        wavOption.style.animation = 'shake 0.5s';
        setTimeout(() => {
          wavOption.style.animation = '';
        }, 500);
      }
      
      // Show upgrade tooltip
      showNotification('WAV downloads require Studio plan or higher. Upgrade to unlock lossless audio!', 'error');
      return; // Don't select WAV
    }
    
    this.selectedFormat = format;
    
    // Update UI to show selection
    document.querySelectorAll('.download-option').forEach(opt => {
      opt.style.background = 'rgba(139, 92, 246, 0.08)';
      opt.style.borderColor = 'var(--border-color)';
    });
    
    const selectedOption = document.querySelector(`[data-testid="option-${format}"]`);
    if (selectedOption) {
      selectedOption.style.background = 'rgba(139, 92, 246, 0.15)';
      selectedOption.style.borderColor = 'var(--aetherwave-purple)';
    }
  },

  async confirmDownload() {
    const { title, url } = this.downloadData;
    const filename = `${title}.${this.selectedFormat}`;
    
    const downloadBtn = document.querySelector('[data-testid="button-modal-download"]');
    
    try {
      // Show loading state on download button
      if (downloadBtn) downloadBtn.textContent = 'Downloading...';
      
      // Fetch the file as a blob to work around CORS restrictions
      const response = await fetch(url);
      if (!response.ok) throw new Error('Download failed');
      
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      
      // Create download link with blob URL
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(blobUrl);
      }, 100);
      
      // Reset button text before closing
      if (downloadBtn) downloadBtn.textContent = 'Download';
     

    
        // When Generate Album Art button is clicked, show the dropdown.
        document.addEventListener('click', function(e) {
        if (e.target && e.target.matches('.download-btn[onclick*="Generate Album Art"]')) {
    document.getElementById('album-art-style-container').style.display = 'block';
    document.getElementById('album-art-style').value = 'photorealistic';
                }
        });

    // Add message to chat
    function addMessage(content, type = 'user') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    messageDiv.innerHTML = `
    <div class="message-label">${type === 'user' ? 'You' : 'AetherWave AI'}</div>
    <div class="message-content">${content}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Send message to API
    async function sendMessage(message) {
    if (!message.trim()) return;

    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
    const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({
    message: message,
    provider: 'openai'
    })
    });

    if (!response.ok) {
    throw new Error('Failed to get response');
    }

    const data = await response.json();
    addMessage(data.message, 'assistant');

    } catch (error) {
    console.error('Chat error:', error);
    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
    } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    }
    }

    // Generate music
    async function generateMusic() {
    // Use the global isCustomMode variable instead of checkbox
    const model = musicModelHeader.value;
    const instrumental = musicInstrumental.checked;
    const vocalGender = document.getElementById('vocal-gender-value')?.value || 'm';
    const uploadUrl = document.getElementById('upload-url').value.trim();

    console.log('=== Generate Music Called ===');
    console.log('Custom Mode:', isCustomMode);
    console.log('Model:', model);
    console.log('Instrumental:', instrumental);
    console.log('Vocal Gender:', vocalGender);
    console.log('Upload URL:', uploadUrl);

    let requestBody = {
    model: model,
    instrumental: instrumental
    };

    // Add advanced options if available (optional parameters)
    const styleWeight = parseFloat(document.getElementById('style-weight')?.value);
    const weirdnessConstraint = parseFloat(document.getElementById('weirdness-constraint')?.value);
    const audioWeight = parseFloat(document.getElementById('audio-weight')?.value);
    
    if (!isNaN(styleWeight)) requestBody.styleWeight = styleWeight;
    if (!isNaN(weirdnessConstraint)) requestBody.weirdnessConstraint = weirdnessConstraint;
    if (!isNaN(audioWeight)) requestBody.audioWeight = audioWeight;

    if (isCustomMode) {
    // Custom Mode - validation depends on instrumental setting
    const title = musicTitle.value.trim();
    const style = musicStyle.value.trim();
    const lyrics = musicLyrics.value.trim();

    console.log('Custom Mode - Title:', title);
    console.log('Custom Mode - Style:', style);
    console.log('Custom Mode - Lyrics length:', lyrics.length);

    // Title and Style are always required in custom mode
    if (!title || !style) {
    alert('Please provide both Title and Style of Music for Custom Mode');
    return;
    }

    // Lyrics are optional in custom mode (even for non-instrumental tracks)
    // SUNO will generate lyrics automatically if not provided

    requestBody.customMode = true;
    requestBody.title = title;
    requestBody.style = style;
    requestBody.prompt = lyrics || ''; // Lyrics are optional, empty string if not provided
    
    // vocalGender is only effective when customMode is true
    requestBody.vocalGender = vocalGender;
    } else {
    // Non-custom Mode - prompt is always required
    const prompt = musicPromptSimple.value.trim();

    console.log('Non-custom Mode - Prompt:', prompt);

    if (!prompt) {
    alert('Please provide a Song Description');
    return;
    }

    requestBody.customMode = false;
    requestBody.prompt = prompt;
    
    // Note: vocalGender is NOT sent when customMode is false (per API docs)
    }

    // Determine endpoint based on uploadUrl
    let endpoint = '/api/generate-music';
    let actionText = 'Generating Your Music';
    
    if (uploadUrl) {
    endpoint = '/api/upload-cover-music';
    actionText = 'Covering Your Audio';
    requestBody.uploadUrl = uploadUrl;
    }

    generateMusicBtn.style.pointerEvents = 'none';
    generateMusicBtn.style.opacity = '0.5';
    musicResult.style.display = 'none';

    try {

    console.log(`Sending request to ${endpoint}:`, requestBody);

    const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    console.log('Response status:', response.status, response.statusText);

    const data = await response.json();
    console.log('Response data:', data);

    if (!response.ok) {
    // Handle insufficient credits
    if (response.status === 403 && data.error === 'Insufficient credits') {
      showPaymentModal();
      throw new Error(data.message || 'Insufficient credits');
    }
    // Handle other errors
    const errorMsg = data.error || 'Failed to generate music';
    const errorDetails = data.details || '';
    throw new Error(`${errorMsg}${errorDetails ? ': ' + errorDetails : ''}`);
    }
    
    // Refresh credits after successful generation start
    fetchUserCredits();

    // KIE.ai returns a taskId - we need to poll for results
    const musicTaskId = data.taskId;
    
    if (!musicTaskId) {
    throw new Error('No task ID returned from API');
    }

    // Show processing status
    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title"><img src="/assets/icon-set/music-icon.png" style="width: 20px; height: 20px; margin-right: 0.5rem; vertical-align: middle;"> ${actionText}...</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">This usually takes 30-40 seconds for streaming quality.</p>
    <div style="margin-top: 1rem; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
      <div style="width: 30%; height: 100%; background: var(--aetherwave-purple); animation: pulse 1.5s ease-in-out infinite;"></div>
    </div>
    </div>
    `;
    musicResult.style.display = 'block';

    // Poll for results
    let attempts = 0;
    const maxAttempts = 180; // 6 minutes max (180 * 2 seconds) - AI music takes 2-4 minutes
    const pollInterval = setInterval(async () => {
      attempts++;

      try {
        // On final attempt, ask backend to check if task is truly stuck
        const checkForTimeout = attempts >= maxAttempts ? '?checkForTimeout=true' : '';
        const statusResponse = await fetch(`/api/music-status/${musicTaskId}${checkForTimeout}`);
        const statusData = await statusResponse.json();

        console.log(`Poll attempt ${attempts}:`, statusData);

        // Check for EXPLICIT FAILURE from KIE.ai
        if (statusData.failed || statusData.status === 'FAILED') {
          clearInterval(pollInterval);
          console.log('🚫 KIE.ai reported task failed:', statusData.failureReason);

          // Request refund for failed generation
          const refundResponse = await fetch(`/api/music-refund/${musicTaskId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reason: 'failed' })
          });
          const refundData = await refundResponse.json();

          // Show failure + refund UI (Panel 3 style)
          const refundBox = refundData.creditsRefunded > 0 ? `
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
              <p style="color: #22c55e; font-weight: 600; margin: 0;">
                ✅ ${refundData.creditsRefunded} Credits Automatically Refunded
              </p>
              <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; margin-bottom: 0;">
                New balance: ${refundData.newBalance} credits
              </p>
            </div>
          ` : '';

          musicResult.innerHTML = `
            <div class="result-box" style="border-left: 4px solid #ef4444;">
              <div class="result-title" style="color: #ef4444;">❌ Music Generation Failed</div>
              <p style="margin-top: 0.75rem; line-height: 1.6;">
                The music generation service encountered an error: <strong>${statusData.failureReason || 'Unknown error'}</strong>
              </p>
              ${refundBox}
              <p style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85rem;">
                This can happen due to content filtering or service issues. Please try again with a different prompt.
              </p>
            </div>
          `;
          generateMusicBtn.style.pointerEvents = 'auto';
          generateMusicBtn.style.opacity = '1';
          if (refundData.creditsRefunded > 0) fetchUserCredits(); // Refresh balance
          return;
        }

        // Check for TIMEOUT (stuck in PENDING after 6 minutes)
        if (statusData.timeout || statusData.status === 'TIMEOUT') {
          clearInterval(pollInterval);
          console.log('⏱️ Task stuck in pending - processing timeout refund');

          // Request refund for timeout
          const refundResponse = await fetch(`/api/music-refund/${musicTaskId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reason: 'timeout' })
          });
          const refundData = await refundResponse.json();

          // Show timeout + refund UI (Panel 3 style)
          const refundBox = refundData.creditsRefunded > 0 ? `
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
              <p style="color: #22c55e; font-weight: 600; margin: 0;">
                ✅ ${refundData.creditsRefunded} Credits Automatically Refunded
              </p>
              <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; margin-bottom: 0;">
                New balance: ${refundData.newBalance} credits
              </p>
            </div>
          ` : '';

          musicResult.innerHTML = `
            <div class="result-box" style="border-left: 4px solid #ff9500;">
              <div class="result-title" style="color: #ff9500;">⏱️ Generation Timed Out</div>
              <p style="margin-top: 0.75rem; line-height: 1.6;">
                Your music generation took longer than expected (over 6 minutes). This usually means the service is experiencing high load.
              </p>
              ${refundBox}
              <p style="margin-top: 0.75rem; font-weight: 600;">💡 Try Again</p>
              <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">
                The service typically completes in 2-4 minutes. Please try again - it should work faster next time.
              </p>
            </div>
          `;
          generateMusicBtn.style.pointerEvents = 'auto';
          generateMusicBtn.style.opacity = '1';
          if (refundData.creditsRefunded > 0) fetchUserCredits(); // Refresh balance
          return;
        }

        // Update progress bar based on status
        const currentStatus = statusData.status || 'PENDING';
        let progressPercent = 20;
        let statusMessage = 'Starting generation...';

        if (currentStatus === 'TEXT_SUCCESS') {
          progressPercent = 60;
          statusMessage = 'Lyrics created! Generating audio...';
        } else if (currentStatus === 'FIRST_SUCCESS') {
          progressPercent = 85;
          statusMessage = 'First track ready! Finishing up...';
        } else if (currentStatus === 'SUCCESS') {
          progressPercent = 100;
          statusMessage = 'Complete!';
        } else {
          progressPercent = Math.min(20 + (attempts * 2), 50);
          statusMessage = `Processing... (${Math.floor(attempts * 2)}s)`;
        }

        musicResult.innerHTML = `
          <div class="result-box">
            <div class="result-title"><img src="/assets/icon-set/music-icon.png" style="width: 20px; height: 20px; margin-right: 0.5rem; vertical-align: middle;"> ${actionText}...</div>
            <p style="color: var(--aetherwave-pink); font-size: 0.9rem;">${statusMessage}</p>
            <p style="color: var(--text-muted); font-size: 0.8rem;">This usually takes 30-60 seconds. Max wait: 6 minutes with auto-refund.</p>
            <div style="margin-top: 1rem; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
              <div style="width: ${progressPercent}%; height: 100%; background: var(--aetherwave-purple); transition: width 0.5s ease;"></div>
            </div>
          </div>
        `;

        if (statusData.status === 'SUCCESS' && statusData.tracks && statusData.tracks.length > 0) {
          clearInterval(pollInterval);
          
          // Display all tracks with premium player (usually 2 variations)
          const tracksHTML = statusData.tracks.map((track, index) => `
            <div class="premium-track-card" data-track-id="${track.id}">
              <div class="track-content">
                <div class="track-artwork">
                  <img src="${track.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Crect fill=\'%238b5cf6\' width=\'80\' height=\'80\'/%3E%3C/svg%3E'}" alt="${track.title || 'Track'}" data-testid="img-track-art-${index}">
                  <div class="track-duration-badge" data-testid="text-duration-${index}">--:--</div>
                </div>
                <div class="track-info">
                  <div class="track-title" data-testid="text-track-title-${index}">${track.title || `Track ${index + 1}`}</div>
                  <div class="track-artist" data-testid="text-track-artist-${index}">AetherWave Studio</div>
                </div>
                <div class="track-controls">
                  <button class="control-btn control-btn-small" onclick="window.premiumPlayer.previous('${track.id}')" title="Previous" data-testid="button-previous-${index}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <button class="control-btn play-pause-btn" onclick="window.premiumPlayer.togglePlay('${track.id}')" data-testid="button-play-${index}">
                    <svg class="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                      <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                    </svg>
                  </button>
                  <button class="control-btn control-btn-small" onclick="window.premiumPlayer.next('${track.id}')" title="Next" data-testid="button-next-${index}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M13 19l7-7-7-7M6 19l7-7-7-7"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="track-progress-container">
                <div class="track-progress-bar" onclick="window.premiumPlayer.seek('${track.id}', event)" data-testid="progress-bar-${index}">
                  <div class="track-progress-fill" style="width: 0%"></div>
                </div>
                <div class="track-times">
                  <span class="current-time" data-testid="text-current-time-${index}">0:00</span>
                  <span class="total-time" data-testid="text-total-time-${index}">0:00</span>
                </div>
              </div>
              <div class="track-actions">
                <button class="action-btn" onclick="window.premiumPlayer.openDownloadModal('${track.id}', '${track.title || `Track ${index + 1}`}', '${track.streamAudioUrl || track.audioUrl}')" data-testid="button-download-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                  </svg>
                  Download
                </button>
                <button class="action-btn" onclick="generateVisualForTrack('${musicTaskId}', '${track.id}', '${track.title}', 'image')" data-testid="button-generate-art-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                  </svg>
                  Album Art
                </button>
              </div>
              <audio preload="metadata" src="${track.streamAudioUrl || track.audioUrl}" data-track-id="${track.id}"></audio>
              <div id="visual-result-${track.id}" style="margin-top: 0.5rem;"></div>
            </div>
          `).join('');

          musicResult.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 0;">
              ${tracksHTML}
            </div>
          `;
          
          // Initialize premium player after tracks are loaded
          setTimeout(() => {
            window.premiumPlayer.init();
          }, 100);
          
          generateMusicBtn.style.pointerEvents = 'auto';
          generateMusicBtn.style.opacity = '1';
        }
        // Note: Timeout handling is now done above when checkForTimeout=true is used
      } catch (pollError) {
        console.error('Polling error:', pollError);
        clearInterval(pollInterval);
        musicResult.innerHTML = `
          <div class="result-box" style="border-left: 4px solid #ef4444;">
            <div class="result-title" style="color: #ef4444;">Error</div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Failed to check generation status. Please try again.</p>
            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">${pollError.message}</p>
          </div>
        `;
        generateMusicBtn.style.pointerEvents = 'auto';
        generateMusicBtn.style.opacity = '1';
      }
    }, 2000); // Poll every 2 seconds

    } catch (error) {
    console.error('Music generation error:', error);
    let errorMessage = 'Unable to generate music. ';

    if (error.message.includes('Failed to fetch')) {
    errorMessage += 'Please check your internet connection.';
    } else if (error.message.includes('CORS')) {
    errorMessage += 'CORS policy error. Check API configuration.';
    } else {
    errorMessage += 'Please try again later.';
    }

    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">${errorMessage}</p>
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">Error: ${error.message}</p>
    </div>
    `;
    musicResult.style.display = 'block';
    } finally {
    generateMusicBtn.style.pointerEvents = 'auto';
    generateMusicBtn.style.opacity = '1';
    }
    }

    // Generate album art
    async function generateArt() {
    const prompt = artPrompt.value.trim();
    const style = artStyle.value;

    if (!prompt) {
    alert('Please describe your album art');
    return;
    }

    generateArtBtn.disabled = true;
    generateArtBtn.textContent = 'Generating...';
    artResult.style.display = 'none';

    try {
    const response = await fetch('/api/generate-art', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    credentials: 'include',
    body: JSON.stringify({
    prompt: prompt,
    style: style
    })
    });

    const data = await response.json();

    if (!response.ok) {
      // Check if credits were refunded (Panel 3 style refund UI)
      if (data.refunded && data.creditsRefunded !== undefined) {
        const refundBox = data.creditsRefunded > 0 ? `
          <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
            <p style="color: #22c55e; font-weight: 600; margin: 0;">
              ✅ ${data.creditsRefunded} Credits Automatically Refunded
            </p>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; margin-bottom: 0;">
              New balance: ${data.newBalance} credits
            </p>
          </div>
        ` : '';

        artResult.innerHTML = `
          <div class="result-box" style="border-left: 4px solid #ef4444;">
            <div class="result-title" style="color: #ef4444;">❌ Art Generation Failed</div>
            <p style="margin-top: 0.75rem; line-height: 1.6;">
              ${data.error || 'Failed to generate art'}
            </p>
            ${refundBox}
            <p style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85rem;">
              ${data.details || 'Please try again'}
            </p>
          </div>
        `;
        artResult.style.display = 'block';
        if (data.creditsRefunded > 0) fetchUserCredits(); // Refresh balance
        return;
      }

      throw new Error(data.error || 'Failed to generate art');
    }

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Generated Album Art</div>
    <img src="${data.imageUrl}" alt="Generated album art" class="generated-image" />
    <a href="${data.imageUrl}" download class="download-btn">Download Image</a>
    </div>
    `;
    artResult.style.display = 'block';

    } catch (error) {
    console.error('Art generation error:', error);
    artResult.innerHTML = `
    <div class="result-box" style="border-left: 4px solid #ef4444;">
    <div class="result-title" style="color: #ef4444;">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Failed to generate art. Please try again.</p>
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">${error.message}</p>
    </div>
    `;
    artResult.style.display = 'block';
    } finally {
    generateArtBtn.disabled = false;
    generateArtBtn.textContent = 'Generate Art';
    }
    }

    // Generate video with Seedance
    // Generate Media (Image or Video) with new use case system

async function generateMedia() {
    if (!selectedUseCase) {
        alert('Please select a use case first');
        return;
    }

    const prompt = enhancedPrompt.value.trim();
    if (!prompt) {
        alert('Please provide a prompt');
        return;
    }

    generateMediaBtn.disabled = true;
    const originalBtnText = generateMediaBtn.innerHTML;
    
    // Add processing class for both video and image generation
    generateMediaBtn.classList.add('processing');
    if (selectedMediaType === 'video') {
        generateMediaBtn.innerHTML = `⏳ Generating Video...`;
    } else {
        generateMediaBtn.innerHTML = `⏳ Generating ${selectedMediaType}...`;
    }
    
    mediaResult.style.display = 'none';

    try {
        if (selectedMediaType === 'video') {
            // Video generation with selected model (Seedance, VEO 3, or SORA 2)
            const videoModel = document.getElementById('media-video-model')?.value || 'seedance-lite';
            const aspectRatio = document.getElementById('media-aspect-ratio')?.value || '16:9';
            const resolution = document.getElementById('media-resolution')?.value || '480p';
            const duration = parseInt(document.getElementById('media-duration')?.value || '3');

            const requestBody = {
                prompt: prompt,
                model: videoModel,
                aspectRatio: aspectRatio,
                resolution: resolution,
                duration: duration,
                enableSafetyChecker: document.getElementById('media-safety-checker')?.checked ?? true
            };

            // Add uploaded image data if provided
            if (uploadedImageData) {
                requestBody.imageData = uploadedImageData;
                // Seedance Pro: Always reference mode (doesn't support first/last frame)
                // Seedance Lite & VEO: First-frame mode
                const isSeedancePro = videoModel === 'seedance-pro';
                requestBody.imageMode = isSeedancePro ? 'reference' : 'first-frame';
            }
            // Add second image data if provided (for Seedance Lite/VEO last frame only)
            // Seedance Pro doesn't support first/last frame mode
            if (uploadedLastFrameData && videoModel !== 'seedance-pro') {
                requestBody.endImageData = uploadedLastFrameData;
            }

            const modelName = videoModel.replace('_', ' ').toUpperCase();
            console.log(`Generating video with ${modelName}...`);

            // Use the correct endpoint based on the video provider
            const isSeedance = videoModel.startsWith('seedance');
            const endpoint = isSeedance ? '/api/generate-video-fal' : '/api/generate-video';

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate video');
            }

            // Display video result
            if (data.status === 'complete' && data.videoUrl) {
                displayMediaResult(data, 'video');
                return;
            } else {
                throw new Error('Video generated but no URL returned');
            }

        } else {
            // Image generation (Midjourney, DALL-E 3, or Fal.ai Nano Banana)
            const imageEngine = document.getElementById('media-image-engine').value;
            const aspectRatio = document.getElementById('media-image-aspect-ratio')?.value || '1:1';
            const useMidjourney = imageEngine === 'midjourney-ttapi';
            const useDallE = imageEngine === 'dall-e-3';
            
            // Midjourney path (ttapi.io)
            if (useMidjourney) {
                const selectedSpeed = document.getElementById('midjourney-speed')?.value || 'fast';
                const requestBody = {
                    prompt: prompt,
                    style: document.getElementById('media-image-style').value,
                    version: 'v7',
                    aspectRatio: aspectRatio,
                    speed: selectedSpeed
                };

                // Add reference image if uploaded (works with Midjourney)
                if (uploadedImageData) {
                    requestBody.referenceImage = uploadedImageData;
                    console.log('Using reference image for Midjourney generation');
                }

                // Show status message with estimated time
                const estimatedTime = selectedSpeed === 'turbo' ? '15-40 seconds' : selectedSpeed === 'relax' ? '90-180 seconds' : '30-60 seconds';
                const timeoutTime = selectedSpeed === 'turbo' ? '120 seconds' : '180 seconds';
                const creditCost = selectedSpeed === 'turbo' ? 6 : 3;
                
                mediaResult.innerHTML = `
                    <div class="result-box" style="border-left: 4px solid #8b5cf6;">
                        <div class="result-title" style="color: #8b5cf6;">🎨 Generating with Midjourney ${selectedSpeed === 'turbo' ? 'Turbo' : selectedSpeed === 'relax' ? 'Relax' : 'Fast'}</div>
                        <p style="margin-top: 0.75rem; line-height: 1.6;">
                            Creating high-quality image variants...
                        </p>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">⏱️ Est. Time:</span>
                                <span style="font-weight: 600;">${estimatedTime}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">⚡ Speed Mode:</span>
                                <span style="font-weight: 600;">${selectedSpeed === 'turbo' ? 'Turbo' : 'Fast'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">💰 Credits Used:</span>
                                <span style="font-weight: 600;">${creditCost} credits</span>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid rgba(139, 92, 246, 0.3); border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span style="color: var(--text-muted); font-size: 0.85rem;">Processing your request...</span>
                            </div>
                            <div style="width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                                <div class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); animation: progress-fill ${selectedSpeed === 'turbo' ? '60s' : '90s'} linear forwards;"></div>
                            </div>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.75rem; font-style: italic;">
                            ⚠️ Auto-timeout after ${timeoutTime} with full refund if delayed
                        </p>
                    </div>
                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                        @keyframes progress-fill {
                            to { width: 100%; }
                        }
                    </style>
                `;
                mediaResult.style.display = 'block';

                console.log('Generating images with Midjourney via ttapi.io...');

                const response = await fetch('/api/media/midjourney-ttapi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    // Handle timeout with credit refund (status 408)
                    if (response.status === 408 && data.timeout) {
                        // Build refund message (only show if credits were actually refunded)
                        const refundBox = data.creditsRefunded > 0 ? `
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
                                <p style="color: #22c55e; font-weight: 600; margin: 0;">
                                    ✅ ${data.creditsRefunded} Credits Refunded
                                </p>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; margin-bottom: 0;">
                                    New balance: ${data.newBalance} credits
                                </p>
                            </div>
                        ` : '';
                        
                        mediaResult.innerHTML = `
                            <div class="result-box" style="border-left: 4px solid #ff9500;">
                                <div class="result-title" style="color: #ff9500;">⏱️ Generation Timed Out</div>
                                <p style="margin-top: 0.75rem; line-height: 1.6;">
                                    Midjourney's servers are experiencing heavy load right now. 
                                    Your request timed out after ${data.timeoutSeconds} seconds.
                                </p>
                                ${refundBox}
                                <p style="margin-top: 0.75rem; font-weight: 600;">💡 Recommended Next Steps:</p>
                                <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
                                    <p style="margin: 0; line-height: 1.6;">
                                        <strong>Try Nano Banana</strong> - Our fastest image engine (5 seconds, 1 credit)<br>
                                        Delivers professional results instantly, perfect when you need speed!
                                    </p>
                                    <button onclick="document.getElementById('media-image-engine').value='nano-banana'; this.parentElement.parentElement.style.display='none';" 
                                            style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Switch to Nano Banana ⚡
                                    </button>
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.75rem; font-style: italic;">
                                    You can also try Midjourney again during off-peak hours when servers are less busy.
                                </p>
                            </div>
                        `;
                        mediaResult.style.display = 'block';
                        
                        // Update credits display
                        loadCreditsDisplay();
                        return;
                    }
                    
                    throw new Error(data.error || data.details || 'Failed to generate with Midjourney');
                }

                // Display all 4 Midjourney variants
                if (data.imageUrls && data.imageUrls.length > 0) {
                    const referenceLabel = data.hasReference ? ' (with Reference)' : '';
                    const imageGrid = data.imageUrls.map((url, idx) => 
                        `<div style="position: relative;">
                            <img src="${url}" alt="Midjourney variant ${idx + 1}" style="width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.open('${url}', '_blank')" />
                            <button onclick="downloadFile('${url}', 'aetherwave-midjourney-${idx + 1}.png')" class="download-btn" style="margin-top: 0.25rem; width: 100%; font-size: 0.8rem; padding: 0.5rem;">Download #${idx + 1}</button>
                        </div>`
                    ).join('');
                    
                    mediaResult.innerHTML = `
                        <div class="result-box">
                            <div class="result-title">✅ 4 Images Generated with Midjourney${referenceLabel}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 0.5rem;">
                                ${imageGrid}
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.75rem;">
                                Use Case: ${selectedUseCase} · Engine: Midjourney v7 · 4 variants generated
                            </p>
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; font-style: italic;">
                                Click any image to view full size
                            </p>
                        </div>
                    `;
                    mediaResult.style.display = 'block';
                    return;
                } else {
                    throw new Error('Midjourney completed but no images returned');
                }
            }
            
            // DALL-E 3 or Nano Banana path
            const requestBody = {
                prompt: prompt,
                style: document.getElementById('media-image-style').value,
                aspectRatio: aspectRatio,
                useDallE: useDallE
            };

            // Add reference image if uploaded (only works with Nano Banana)
            if (uploadedImageData && !useDallE) {
                requestBody.referenceImage = uploadedImageData;
                console.log('Using reference image for image generation');
            }

            console.log(`Generating image with ${useDallE ? 'DALL-E 3' : 'Fal.ai Nano Banana'}...`);

            const response = await fetch('/api/generate-art', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate image');
            }

            // Display image result
            if (data.imageUrl) {
                const engineName = data.model === 'dall-e-3' ? 'DALL-E 3' : 'Nano Banana';
                const referenceLabel = data.hasReference ? ' (with Reference)' : '';
                mediaResult.innerHTML = `
                    <div class="result-box">
                        <div class="result-title">✅ Image Generated with ${engineName}${referenceLabel}</div>
                        <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
                        ${data.description ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">AI: ${data.description}</p>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                            Use Case: ${selectedUseCase} · Engine: ${engineName} · Style: ${data.style}
                        </p>
                        ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">Revised: ${data.revisedPrompt}</p>` : ''}
                    </div>
                `;
                mediaResult.style.display = 'block';
                return;
            } else {
                throw new Error('Image generated but no URL returned');
            }
        }

    } catch (error) {
        console.error('Media generation error:', error);
        mediaResult.innerHTML = `
            <div class="result-box">
                <div class="result-title">Error</div>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate ${selectedMediaType}. ${error.message}</p>
            </div>
        `;
        mediaResult.style.display = 'block';
    } finally {
        generateMediaBtn.disabled = false;
        generateMediaBtn.classList.remove('processing');
        generateMediaBtn.innerHTML = originalBtnText;
    }
}
 
   
 

    // Display media result
    function displayMediaResult(data, type) {
    if (type === 'video') {
    const generationTime = data.timings ? ` (${Math.round(data.timings.inference / 1000)}s)` : '';
    
    // Determine the model display name and provider
    let modelDisplay = 'Seedance 1.0';
    let provider = 'Fal.ai';
    
    if (data.model) {
      if (data.model.startsWith('veo3')) {
        modelDisplay = 'VEO 3';
        provider = 'KIE.ai';
      } else if (data.model.includes('sora')) {
        modelDisplay = 'SORA 2';
        provider = 'KIE.ai';
      } else if (data.model.includes('seedance')) {
        modelDisplay = data.model;
        provider = 'Fal.ai';
      } else {
        modelDisplay = data.model;
        provider = 'Fal.ai';
      }
    }



      // Create modal HTML
      const modalHtml = `
        <div id="video-duration-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;">
          <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
            <h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1.1rem;">🎬 Animate Album Art</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">Choose animation duration for "${trackTitle}"</p>
            
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Duration</label>
              <select id="album-video-duration" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: var(--text-primary); font-size: 0.9rem;" ${isFree ? 'disabled' : ''}>
                <option value="5" selected>5 seconds (8 credits)</option>
                <option value="10">10 seconds (15 credits)</option>
              </select>
              ${isFree ? `<p style="color: #fbbf24; font-size: 0.75rem; margin-top: 0.5rem;">⚠️ Free accounts limited to 5 seconds</p>` : ''}
            </div>
            
            <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--accent-color);">
              <strong>Settings:</strong> Lite model, 480p resolution<br>
              <strong>Mode:</strong> Image-to-video (album art as first frame)
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="closeVideoDurationModal()" style="flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;" data-testid="button-cancel-video-duration">Cancel</button>
              <button onclick="confirmAlbumArtToVideo('${trackId}', '${trackTitle}', '${albumArtUrl}')" style="flex: 1; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem;" data-testid="button-confirm-video-duration">🎬 Animate</button>
            </div>
          </div>
        </div>
      `;
  
      
        const data = await response.json();
        console.log('Album art to video response:', data);

        if (!response.ok) {
          console.error('Video generation error response:', data);
          throw new Error(data.details || data.error || 'Failed to generate video from album art');
        }

        if (data.status === 'complete' && data.videoUrl) {
          // Store the video URL in media storage
          if (!window.mediaStorage[trackId]) {
            window.mediaStorage[trackId] = {};
          }
          window.mediaStorage[trackId].videoUrl = data.videoUrl;
          window.mediaStorage[trackId].videoDuration = duration;
          
          // Show video view
          toggleMediaView(trackId, true);
          
          // Update credits display
          if (data.creditsRemaining !== undefined) {
            updateCreditsDisplay(data.creditsRemaining);
          }
        } else {
          throw new Error('Video generation completed but no video URL returned');
        }
      } catch (error) {
        console.error('Album art to video error:', error);
        // Restore album art view on error
        toggleMediaView(trackId, false);
        // Show error message
        resultDiv.innerHTML += `<p style="color: #ff6b6b; font-size: 0.85rem; margin-top: 0.5rem; text-align: center;">❌ ${error.message}</p>`;
      }
    };




    // Event listeners - Chat
    if (sendBtn && chatInput) {
      sendBtn.addEventListener('click', () => {
        sendMessage(chatInput.value);
      });
    }

    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage(chatInput.value);
        }
      });
    }

    if (suggestionChips.length > 0 && chatInput) {
      suggestionChips.forEach(chip => {
        chip.addEventListener('click', () => {
          chatInput.value = chip.textContent;
          sendMessage(chip.textContent);
        });
      });
    }


  <!-- Quest Modal -->
  <div id="quest-modal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeQuestModal()">
    <div class="modal-content" style="max-width: 400px; width: 92%; margin: 0 auto;">
      <div class="modal-header">
        <div class="modal-title">🎁 Earn Free Credits!</div>
        <div class="modal-subtitle">Complete quests to earn 20 credits each (80 credits total)</div>
      </div>

      <div id="quest-list" style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
        <!-- Quests will be loaded here dynamically -->
        <div style="text-align: center; padding: 1.5rem; color: var(--text-muted);">
          Loading quests...
        </div>
      </div>

      <div style="text-align: center; font-size: 0.8rem; color: var(--text-muted); padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; line-height: 1.4;">
        <strong style="color: var(--text-primary);">Free Tier Credits:</strong> 100 welcome bonus + 20 credits/day (cap: 100)<br>
        Quest rewards can push you over the cap!
      </div>

      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="closeQuestModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- React SPA Mount Point -->
  <div id="root"></div>

  <script type="module">
    // Detect if this is a React SPA route
    const isReactRoute = window.location.pathname.startsWith('/ghost-musician') ||
                          window.location.pathname.startsWith('/upgrade') ||
                          window.location.pathname.startsWith('/buy-credits') ||
                          window.location.pathname.startsWith('/store') ||
                          window.location.pathname.startsWith('/video-generation');
    
    if (isReactRoute) {
      // Hide the AetherWave UI for React routes
      const bgContainer = document.querySelector('.bg-container');
      const appContainer = document.getElementById('app-container');
      if (bgContainer) bgContainer.style.display = 'none';
      if (appContainer) appContainer.style.display = 'none';
      
      // Load the React SPA
      import('/src/main.tsx');
    } else {
      // Remove the React root for AetherWave routes
      const root = document.getElementById('root');
      if (root) root.remove();
    }
  </script>

  <!-- Shared Navigation JavaScript -->
  <script src="/static/assets/js/navigation.js"></script>

  <!-- Tiled Background JavaScript -->
  <script src="/static/assets/js/tiled-background-v2.js"></script>

  <!-- Personalized Portal JavaScript -->
  <script src="/static/assets/js/personalized-portal.js"></script>

  <!-- Portal Functions -->
  <script>
  function scrollToTools() {
    // Scroll to the panels container where the AI tools are
    const panelsContainer = document.querySelector('.panels-container');
    if (panelsContainer) {
      panelsContainer.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  }

  // Add some portal entrance effects
  document.addEventListener('DOMContentLoaded', function() {
    const portalSection = document.querySelector('.portal-welcome-section');
    if (portalSection) {
      // Add entrance animation
      portalSection.style.opacity = '0';
      portalSection.style.transform = 'translateY(30px)';

      setTimeout(() => {
        portalSection.style.transition = 'opacity 1s ease, transform 1s ease';
        portalSection.style.opacity = '1';
        portalSection.style.transform = 'translateY(0)';
      }, 500);
    }
  });
  </script>

</body>
</html>