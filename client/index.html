<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AetherWave Studio - All Intelligence is Welcome Here</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
   /*:root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    } */
        :root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    }


    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--dark-bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    }

    /* Animated Background */
    .bg-container {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
    background: radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.15), transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(255, 46, 166, 0.12), transparent 50%);
    }

    .bg-grid {
    position: absolute;
    inset: 0;
    background-image:
    linear-gradient(var(--border-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
    0% { transform: translate(0, 0); }
    100% { transform: translate(60px, 60px); }
    }

    .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.4;
    animation: float 15s ease-in-out infinite;
    }

    .orb-1 {
    width: 400px;
    height: 400px;
    background: var(--aetherwave-pink);
    top: 10%;
    left: 10%;
    animation-delay: 0s;
    }

    .orb-2 {
    width: 300px;
    height: 300px;
    background: var(--aetherwave-purple);
    bottom: 20%;
    right: 15%;
    animation-delay: 5s;
    }

    @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Header */
    header {
    position: relative;
    z-index: 10;
    padding: .5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: blur(12px);
    background: url('/assets/header-panel_1761541736595.png') no-repeat center center, rgba(13, 11, 21, 0.8);
    background-size: cover;
    }

    .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    }

    .logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }
        .logo-icon2 {
    width: 75px;
    height: 75px;
    /*background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));*/
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }

    nav {
    display: flex;
    gap: 2rem;
    align-items: center;
    }

    nav a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.2s;
    }

    nav a:hover {
    color: var(--text-primary);
    }

    .nav-btn {
    padding: 0.5rem 1.25rem;
    background: var(--aetherwave-pink);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 46, 166, 0.4);
    }

    /* Main Content */
    main {
    position: relative;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
    min-height: 0;
    }

    .panels-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto 1fr;
    gap: 1.5rem;
    flex: 1;
    min-height: 0;
    position: relative;
    }

    .hero-text {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
    background: url('/assets/header-panel_1761541736595.png') no-repeat center center, linear-gradient(135deg, rgba(13, 11, 21, 0.98), rgba(20, 15, 35, 0.98));
    background-size: cover;
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    }
    
    .panel-music {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
    }
    
    .panel-chat {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
    }
    
    .panel-media {
      grid-column: 3 / 4;
      grid-row: 1 / 3;
    }

    @keyframes fadeInUp {
    from {
    opacity: 0;
    transform: translateY(20px);
    }
    to {
    opacity: 1;
    transform: translateY(0);
    }
    }

    h1 {
    font-size: clamp(1.5rem, 2.5vw, 2rem);
    font-weight: 700;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple), var(--text-primary));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
    }

    .subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.5;
    }

    /* Panel Styling */
    .panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: fadeInUp 0.8s ease-out 0.2s backwards;
    display: flex;
    flex-direction: column;
    }

    .panel-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: url('/assets/header-panel_1761541736595.png') no-repeat center center, rgba(13, 11, 21, 0.5);
    background-size: cover;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }
    
    .music-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .credits-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0;
      background: url('/assets/Coins_badge_1761542949252.png') no-repeat center center;
      background-size: 100% 100%;
      border: none;
      border-radius: 0;
      font-weight: 700;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
      min-height: 60px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.8));
    }
    
    .credits-indicator span {
      filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.9)) drop-shadow(0 0 2px rgba(0, 0, 0, 1));
    }
    
    .credits-indicator:hover {
      filter: brightness(1.2) drop-shadow(0 2px 8px rgba(0, 0, 0, 0.8));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 46, 166, 0.3);
    }
    
    .version-dropdown {
      padding: 0.5rem 1rem;
      background: var(--dark-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .version-dropdown:hover {
      border-color: var(--aetherwave-purple);
    }

    .panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    }

    .panel-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    }

    .panel-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    /* Chat Interface */
    .chat-messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    .message {
    animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
    }

    .message-label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    }

    .message-content {
    padding: 1rem 1.25rem;
    border-radius: 12px;
    line-height: 1.6;
    }

    .message.user .message-content {
    background: rgba(255, 46, 166, 0.1);
    border: 1px solid rgba(255, 46, 166, 0.3);
    margin-left: 2rem;
    }

    .message.assistant .message-content {
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    }

    .chat-input-area {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    background: rgba(13, 11, 21, 0.5);
    }

    /* Music Generation */
    .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }
    
    /* Gender Toggle Buttons */
    .gender-toggle-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    /* Premium Gradient Sliders */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
      margin: 0.5rem 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 46, 166, 0.5);
      transition: all 0.2s;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(255, 46, 166, 0.8);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px rgba(255, 46, 166, 0.5);
      transition: all 0.2s;
    }
    
    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(255, 46, 166, 0.8);
    }
    
    /* Slider value display */
    .slider-value-display {
      display: inline-block;
      min-width: 3rem;
      text-align: right;
      color: var(--aetherwave-purple);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .slider-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Premium Upload Audio Button */
    .premium-upload-btn {
      position: relative;
      padding: 0.75rem 2rem;
      background: linear-gradient(135deg, rgba(13, 11, 21, 0.95), rgba(20, 15, 35, 0.95));
      border: 2px solid transparent;
      border-radius: 24px;
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(24px);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .premium-upload-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 24px;
      padding: 2px;
      background: linear-gradient(135deg, #00f5ff, #ff2ea6);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 1;
      transition: opacity 0.3s;
    }
    
    .premium-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 24px rgba(255, 46, 166, 0.3),
        0 0 20px rgba(0, 245, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .premium-upload-btn:active {
      transform: translateY(0);
    }

    .form-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    }

    textarea {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: inset 0 0 2px rgba(139, 92, 246, 0.3);
    }

    textarea:focus {
    border-color: var(--aetherwave-pink);
    box-shadow: inset 0 0 2px rgba(255, 46, 166, 0.5);
    }

    select {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    }

    select:focus {
    border-color: var(--aetherwave-pink);
    }

    .btn-primary {
    padding: 0.75rem 2rem;
    background-color: transparent;
    background-image: url('/assets/Generate-image-btn.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
    border: none;
    border-radius: 0;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
    font-size: 0.95rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    height: 48px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    }

    .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.5);
    filter: brightness(1.1);
    }

    .btn-primary:active {
    background-image: url('/assets/Generate-image-btn-active.png');
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    transform: translateY(0);
    }
    
    .btn-primary.processing {
    background-image: url('/assets/Generate-image-btn-active.png');
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    animation: pinkPulse 2s ease-in-out infinite;
    transform: translateY(0);
    }

    .btn-primary:disabled:not(.processing) {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    filter: grayscale(0.3);
    }
    
    .btn-primary:disabled.processing {
    opacity: 1;
    cursor: wait;
    }

    /* Custom Video Generation Button */
    .btn-video-generate {
    padding: 1rem 2rem;
    background-color: transparent;
    background-image: url('/assets/Generate-video-btn.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
    border: none;
    border-radius: 0;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
    font-size: 1.1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    height: 56px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    position: relative;
    min-width: 200px;
    }

    .btn-video-generate:hover:not(.processing) {
    transform: translateY(-2px);
    filter: brightness(1.1);
    }

    .btn-video-generate:active {
    background-image: url('/assets/Generate-video-btn-active.png');
    background-size: contain;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    }
    
    .btn-video-generate.processing {
    background-image: url('/assets/Generate-video-btn-active.png');
    background-size: contain;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    animation: pinkPulse 2s ease-in-out infinite;
    }

    .btn-video-generate:disabled:not(.processing) {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    animation: none;
    filter: none;
    }

    .btn-video-generate:disabled.processing {
    opacity: 1;
    cursor: wait;
    }

    @keyframes pinkPulse {
    0%, 100% {
      filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.9)) drop-shadow(0 0 30px rgba(255, 46, 166, 0.6));
    }
    50% {
      filter: drop-shadow(0 0 22px rgba(255, 46, 166, 1)) drop-shadow(0 0 45px rgba(255, 46, 166, 0.8));
    }
    }

    .result-box {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-top: 0.5rem;
    }

    .result-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    }

    audio {
    width: 100%;
    margin-bottom: 0.5rem;
    }

    .generated-image {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    }

    .download-btn {
    padding: 0.5rem 1rem;
    background: rgba(139, 92, 246, 0.2);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    }

    .download-btn:hover {
    background: rgba(139, 92, 246, 0.3);
    border-color: var(--aetherwave-purple);
    }

    .input-wrapper {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    }

    input[type="text"] {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
    }

    input[type="text"]:focus {
    border-color: var(--aetherwave-pink);
    }

    input[type="text"]::placeholder {
    color: var(--text-muted);
    }

    .send-btn {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .send-btn:active {
    transform: translateY(0);
    }

    /* Suggested Prompts */
    .suggestions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
    }

    .suggestion-chip {
    padding: 0.4rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.75rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    }

    .suggestion-chip:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: var(--aetherwave-purple);
    color: var(--text-primary);
    }

    /* Use Case Cards */
    .use-case-card {
    position: relative;
    background: url('/assets/use-case-card-bg_1761537069997.png') no-repeat center center;
    background-size: 100% 100%;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem 0.4rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
    }

    .use-case-card:hover {
    border-color: var(--aetherwave-purple);
    filter: brightness(1.2);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
    }

    .use-case-card.selected {
        background: url('/assets/use-case-panel-1.gif') no-repeat;
        background-size: 100% 100%;
    border-color: var(--aetherwave-pink);
    filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 46, 166, 0.5));
    box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .use-case-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    filter: grayscale(0.3);
    transition: filter 0.3s ease;
    }

    .use-case-card:hover .use-case-icon {
    filter: grayscale(0);
    transform: scale(1.1);
    }

    .use-case-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
    }

    /* Tooltip Lightbox */
    .use-case-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: rgba(26, 22, 37, 0.98);
    border: 1px solid var(--aetherwave-purple);
    border-radius: 12px;
    padding: 1rem;
    width: 280px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 100;
    backdrop-filter: blur(12px);
    }

    .use-case-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--aetherwave-purple);
    }

    .use-case-card:hover .use-case-tooltip {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    pointer-events: auto;
    }

    .use-case-tooltip strong {
    display: block;
    color: var(--aetherwave-pink);
    font-size: 1rem;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip p {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip em {
    display: block;
    font-size: 0.75rem;
    color: var(--aetherwave-purple);
    font-style: italic;
    line-height: 1.4;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    }

    /* Media Type Toggle Buttons & Mode Toggle Buttons & Gender Toggle Buttons */
    .media-type-btn:hover,
    .mode-toggle-btn:hover,
    .gender-toggle-btn:hover {
    transform: translateY(-2px);
    filter: brightness(1.2);
    }

    .media-type-btn.active,
    .mode-toggle-btn.active,
    .gender-toggle-btn.active {
    background: url('/assets/Pick-btn-on_1761530040819.png') no-repeat center center !important;
    background-size: 100% 100% !important;
    color: #00F5A0 !important;
    filter: drop-shadow(0 0 15px rgba(255, 46, 166, 0.8));
    }

    /* Generate Music Button Glow */
    #generate-music-btn:active {
    filter: drop-shadow(0 0 20px rgba(255, 46, 166, 0.9)) brightness(1.2);
    transform: scale(0.98);
    }


    /* ===== PREMIUM AUDIO PLAYER (Option 2) ===== */
    
    .premium-track-card {
      background: linear-gradient(135deg, rgba(26, 22, 37, 0.9), rgba(13, 11, 21, 0.95));
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .premium-track-card:hover {
      transform: translateY(-2px);
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 12px 48px rgba(139, 92, 246, 0.2);
    }

    .track-content {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    .track-artwork {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    .track-artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .track-duration-badge {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-artist {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .track-progress-container {
      margin-top: 0.75rem;
    }

    .track-progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 2px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .track-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s linear;
      position: relative;
    }

    .track-progress-fill::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .track-progress-bar:hover .track-progress-fill::after {
      opacity: 1;
    }

    .track-times {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .track-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .control-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(255, 46, 166, 0.5);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn-small {
      width: 36px;
      height: 36px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: none;
    }

    .control-btn-small:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.5);
    }

    .track-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(139, 92, 246, 0.1);
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .premium-track-card:hover .track-actions {
      opacity: 1;
      max-height: 100px;
    }

    .action-btn {
      flex: 1;
      padding: 0.625rem 1rem;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .action-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-1px);
    }

    /* Download Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .download-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .download-option {
      padding: 1rem;
      background: rgba(139, 92, 246, 0.08);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .download-option:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--aetherwave-purple);
    }

    .download-option-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .download-option-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .download-option-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .modal-btn {
      flex: 1;
      padding: 0.875rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .modal-btn-secondary {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .modal-btn-secondary:hover {
      background: rgba(139, 92, 246, 0.25);
    }

    /* ============================================
       MOBILE-FIRST RESPONSIVE DESIGN
       ============================================ */
    
    /* Bottom Navigation for Mobile */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(13, 11, 21, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0;
      z-index: 999;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .mobile-bottom-nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 0.5rem;
    }
    
    .mobile-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.5rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      max-width: 120px;
      min-height: 44px;
      touch-action: manipulation;
    }
    
    .mobile-nav-btn img {
      width: 24px;
      height: 24px;
      opacity: 0.6;
      transition: all 0.2s;
    }
    
    .mobile-nav-btn.active {
      color: var(--aetherwave-purple);
    }
    
    .mobile-nav-btn.active img {
      opacity: 1;
      filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.6));
    }
    
    /* Tablet Breakpoint (768px - 1024px) */
    @media (max-width: 1024px) {
      /* Convert to two-column layout on tablets */
      .panels-container {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 1rem;
      }
      
      .hero-text {
        grid-column: 1 / 3;
        grid-row: 1 / 2;
        padding: 1.25rem 1.5rem;
      }
      
      .panel-music {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      
      .panel-chat {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
      }
      
      .panel-media {
        grid-column: 1 / 3;
        grid-row: 3 / 4;
      }
      
      /* Reduce padding */
      main {
        padding: 1rem;
      }
      
      header {
        padding: 0.5rem 1rem;
      }
      
      .panel-content {
        padding: 1rem;
      }
      
      /* Hide desktop nav links on tablets */
      nav a:not(.nav-btn) {
        display: none;
      }
    }
    
    /* Mobile Breakpoint (≤768px) */
    @media (max-width: 768px) {
      /* Fix body scrolling */
      body {
        min-height: 100dvh;
        overflow-x: hidden;
        overflow-y: auto;
      }
      
      /* Convert to single-column mobile layout */
      main {
        padding: 0.75rem 0.75rem 5rem 0.75rem;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }
      
      .panels-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: auto;
      }
      
      /* All panels stack vertically */
      .hero-text,
      .panel-music,
      .panel-chat,
      .panel-media {
        grid-column: unset;
        grid-row: unset;
        width: 100%;
      }
      
      /* Condense hero section on mobile */
      .hero-text {
        padding: 1rem;
        min-height: auto;
      }
      
      .hero-text h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      
      .subtitle {
        font-size: 0.85rem;
      }
      
      /* Hide panels by default on mobile */
      .panel-music,
      .panel-chat,
      .panel-media {
        display: none;
      }
      
      /* Show active panel */
      .panel-music.mobile-active,
      .panel-chat.mobile-active,
      .panel-media.mobile-active {
        display: flex;
      }
      
      /* Panel sizing for mobile */
      .panel {
        max-height: calc(100dvh - 200px);
        min-height: 400px;
      }
      
      .panel-content {
        padding: 1rem;
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Show mobile bottom nav */
      .mobile-bottom-nav {
        display: block;
      }
      
      
      /* Header adjustments */
      header {
        padding: 0.5rem 0.75rem;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .logo {
        font-size: 1rem;
        gap: 0.5rem;
      }
      
      .logo-icon2 {
        width: 40px;
        height: 40px;
      }
      
      .logo-icon2 img {
        width: 35px !important;
        height: 35px !important;
      }
      
      .logo span img {
        height: 28px !important;
      }
      
      /* Hide all nav links except auth */
      nav {
        gap: 0.5rem;
      }
      
      nav a:not(.nav-btn) {
        display: none;
      }
      
      #user-profile img {
        width: 32px !important;
        height: 32px !important;
      }
      
      /* Ensure minimum touch targets (44px) */
      button,
      .nav-btn,
      .btn-primary,
      .btn-secondary,
      input[type="button"],
      input[type="submit"],
      .credits-indicator {
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
      }
      
      /* Touch-friendly form elements */
      input[type="text"],
      input[type="number"],
      textarea,
      select {
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
        touch-action: manipulation;
      }
      
      /* Prevent overscroll on modals */
      .modal-overlay {
        overscroll-behavior: contain;
      }
      
      .modal-content {
        max-height: 90dvh;
        overflow-y: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Profile modal mobile optimization */
      #profile-modal .modal-content {
        width: 95%;
        max-width: 400px;
        padding: 1rem;
      }
      
      .profile-section {
        padding: 0.75rem;
      }
      
      /* Music generation form mobile */
      .form-group {
        gap: 0.5rem;
      }
      
      .form-group label {
        font-size: 0.9rem;
      }
      
      /* Media type buttons */
      .media-type-toggle {
        gap: 0.5rem;
      }
      
      .media-type-btn,
      .mode-toggle-btn,
      .gender-toggle-btn {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        min-height: 44px;
      }
      
      /* Use case grid mobile */
      .use-cases-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      .use-case-card {
        padding: 0.75rem;
      }
      
      .use-case-card img {
        width: 40px;
        height: 40px;
      }
      
      .use-case-name {
        font-size: 0.75rem;
      }
      
      /* Disable hover tooltips on mobile (use tap instead) */
      .use-case-tooltip {
        display: none;
      }
      
      /* Chat messages mobile */
      .message.user .message-content {
        margin-left: 0.5rem;
      }
      
      .message-content {
        padding: 0.875rem 1rem;
        font-size: 0.9rem;
      }
      
      /* Reduce animations on mobile for performance */
      .orb {
        opacity: 0.2;
        filter: blur(60px);
      }
      
      .bg-grid {
        opacity: 0.15;
      }
      
      /* Credits indicator mobile */
      .credits-indicator {
        min-width: 50px;
        min-height: 50px;
        font-size: 0.8rem;
      }
      
      /* Panel headers mobile */
      .panel-header {
        padding: 1rem;
      }
      
      .panel-title {
        font-size: 1rem;
      }
      
      .panel-description {
        font-size: 0.8rem;
      }
      
      /* Audio player mobile */
      audio {
        width: 100%;
        max-width: 100%;
      }
      
      /* Download buttons mobile */
      .download-btn,
      .btn-primary {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
      }
    }
    
    /* Extra small phones (≤375px) */
    @media (max-width: 375px) {
      .use-cases-grid {
        grid-template-columns: 1fr;
      }
      
      .mobile-nav-btn {
        font-size: 0.65rem;
        padding: 0.5rem 0.25rem;
      }
      
      .mobile-nav-btn img {
        width: 20px;
        height: 20px;
      }
    }

  </style>
</head>
<body>
  <div class="bg-container">
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
  </div>

  <header>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <a href="/" class="logo">
        <div class="logo-icon2">
          <img class="logo-icon2" src="/assets/Logo-SilverAlloy-Loop-1_1761279396703.gif" alt="AetherWave Logo" style="width: 50px; height: 50px; object-fit: contain;">
        </div>
        <span>
          <img src="/assets/aws-banner_1761542850665.png" alt="AetherWave Studio" style="height: 40px; object-fit: contain;">
        </span>
      </a>
    </div>
    <nav>
    <a href="https://ai-hub.aetherwavestudio.com">AI Hub</a>
    <a href="/playlists/">Playlists</a>
    <a href="/featured-artist/">Featured Artist</a>
    <a href="/virtual-artists/">Virtual Artists</a>
    <a href="/shop/">Shop</a>
    <div id="auth-section" style="display: flex; align-items: center; gap: 1rem;">
      <a href="/api/login" class="nav-btn" id="login-btn" data-testid="button-login">Login</a>
      <div id="user-profile" style="display: none; align-items: center; gap: 0.75rem;">
        <!-- Credits Badge -->
        <div class="credits-indicator" data-testid="credits-display" onclick="showPaymentModal()" title="Click to view plans and upgrade" style="display: none;">
          <span id="credits-count">0</span>
        </div>
        <!-- Quest Gift Box Icon -->
        <div id="quest-gift-icon" onclick="showQuestModal()" style="display: none; cursor: pointer; position: relative; width: 40px; height: 40px; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255, 46, 166, 0.3);" onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 4px 16px rgba(255, 46, 166, 0.5)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(255, 46, 166, 0.3)'" title="Earn free credits by completing quests!">
          <span style="font-size: 1.3rem;">🎁</span>
          <div id="quest-notification-badge" style="display: none; position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #ff2ea6; border-radius: 50%; border: 2px solid var(--dark-bg); font-size: 0.65rem; font-weight: 700; color: white; display: flex; align-items: center; justify-content: center;"></div>
        </div>
        <div id="profile-trigger" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.25rem 0.75rem; border-radius: 20px; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'" onmouseout="this.style.background='transparent'" data-testid="button-profile">
          <img id="user-avatar" src="/assets/icon-set/profile-icon.png" alt="User" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--aetherwave-purple);">
          <span id="user-name" style="color: var(--text-primary); font-size: 0.9rem;" data-testid="text-username"></span>
        </div>
        <a href="/api/logout" class="nav-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;" data-testid="button-logout">Logout</a>
      </div>
    </div>
    </nav>
  </header>

  <main>
    <div class="panels-container">
    <!-- Music Generation Panel -->
    <div class="panel panel-music">
    <div class="panel-header">
    <div class="music-panel-header">
      <select id="music-model-header" class="version-dropdown" data-testid="select-version">
        <option value="V5">v5 (Premium) ▼</option>
        <option value="V4_5PLUS">v4.5+ (Premium) ▼</option>
        <option value="V4_5">v4.5 (Premium) ▼</option>
        <option value="V4" selected>v4 (Free) ▼</option>
        <option value="V3_5">v3.5 (Free) ▼</option>
      </select>
    </div>
    <div style="margin-top: 0.5rem;">
      <div class="panel-title"><img src="/assets/icon-set/music-icon.png" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle;"> Music Generation</div>
      <div class="panel-description">Create AI-generated music Powered by SUNO</div>
    </div>
    </div>
    <div class="panel-content">
    <!-- Mode Toggle -->
    <div class="form-group">
    <!--<label class="form-label">Mode</label>-->
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
    <button class="mode-toggle-btn active" data-mode="simple" data-testid="button-mode-simple" style="flex: 1; padding: 1rem; background: url('/assets/Pick-btn_1761529942548.png') no-repeat center center; background-size: 100% 100%; border: none; border-radius: 50px; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
    Simple
    </button>
    <button class="mode-toggle-btn" data-mode="custom" data-testid="button-mode-custom" style="flex: 1; padding: 1rem; background: url('/assets/Pick-btn_1761529942548.png') no-repeat center center; background-size: 100% 100%; border: none; border-radius: 50px; color: var(--text-primary); font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
    Custom
    </button>
    </div>
    </div>

    <!-- Upload & Cover Audio File (Optional) -->
    <div class="form-group">
    <label class="form-label" id="upload-file-label">Audio File to Cover (Optional)</label>
    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
      <input type="file" id="upload-file" accept="audio/*,.mp3,.wav,.m4a,.ogg,.flac" style="display: none;" data-testid="input-upload-file">
      <button type="button" id="upload-file-btn" class="premium-upload-btn" data-testid="button-upload-file"><img src="/assets/icon-set/microphone-icon.png" style="width: 16px; height: 16px; margin-right: 0.5rem; vertical-align: middle; filter: brightness(0) invert(1);"> UPLOAD AUDIO</button>
      <span id="upload-file-name" style="color: var(--text-muted); font-size: 0.85rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 120px;">No file selected</span>
      <button type="button" id="clear-upload-btn" style="display: none; padding: 0.5rem 0.75rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.85rem;" data-testid="button-clear-upload">Clear</button>
    </div>
    <input type="hidden" id="upload-url" data-testid="hidden-upload-url">
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">Upload an audio file to cover it with a new style while keeping the melody. Max 8 minutes, max 10MB.</p>
    </div>

    <!-- Simple Mode Fields -->
    <div id="simple-mode-fields">
    <div class="form-group">
    <label class="form-label" id="simple-prompt-label">Song Description <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span></label>
    <textarea id="music-prompt-simple" maxlength="199" placeholder="Describe the style of music and the topic you want, AI will generate lyrics for you"></textarea>
    </div>
    </div>

    <!-- Custom Mode Fields -->
    <div id="custom-mode-fields" style="display: none;">
    <div class="form-group">
    <label class="form-label" id="custom-title-label">Title</label>
    <input type="text" id="music-title" placeholder="Song title" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    </div>
    <div class="form-group">
    <label class="form-label" id="custom-style-label">Style of Music</label>
    <input type="text" id="music-style" placeholder="e.g., ethereal, funk, dreamy, anthemic" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    </div>
    <div class="form-group">
    <label class="form-label" id="custom-lyrics-label">Lyrics <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span></label>
    <textarea id="music-lyrics" maxlength="3000" placeholder="Write your own lyrics, two verses (8 lines) for the best result" style="min-height: 120px;"></textarea>
    </div>
    </div>

<div id="advanced-options" style="display: none;">
  <details open>
    <summary style="cursor:pointer; font-weight:600; color:var(--aetherwave-purple); margin-bottom:1rem;">
      Advanced Options
    </summary>
    <div class="form-group">
      <label class="form-label">Vocal Gender 
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; opacity: 0.5;">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 16v-4"></path>
          <path d="M12 8h.01"></path>
        </svg>
      </label>
      <div class="gender-toggle-group">
        <button type="button" class="gender-toggle-btn active" data-gender="m" data-testid="button-gender-male" style="flex: 1; padding: 1rem; background: url('/assets/Pick-btn_1761529942548.png') no-repeat center center; background-size: 100% 100%; border: none; border-radius: 50px; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Male</button>
        <button type="button" class="gender-toggle-btn" data-gender="f" data-testid="button-gender-female" style="flex: 1; padding: 1rem; background: url('/assets/Pick-btn_1761529942548.png') no-repeat center center; background-size: 100% 100%; border: none; border-radius: 50px; color: var(--text-primary); font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Female</button>
      </div>
      <input type="hidden" id="vocal-gender-value" value="m">
    </div>
    <div class="form-group">
      <div class="slider-label-row">
        <label for="style-weight" class="form-label">Style Weight</label>
        <span class="slider-value-display" id="style-weight-value">65%</span>
      </div>
      <input type="range" id="style-weight" min="0" max="1" step="0.01" value="0.65">
    </div>
    <div class="form-group">
      <div class="slider-label-row">
        <label for="weirdness-constraint" class="form-label">Weirdness</label>
        <span class="slider-value-display" id="weirdness-constraint-value">65%</span>
      </div>
      <input type="range" id="weirdness-constraint" min="0" max="1" step="0.01" value="0.65">
    </div>
    <div class="form-group">
      <div class="slider-label-row">
        <label for="audio-weight" class="form-label">Audio Weight</label>
        <span class="slider-value-display" id="audio-weight-value">65%</span>
      </div>
      <input type="range" id="audio-weight" min="0" max="1" step="0.01" value="0.65">
    </div>
  </details>
</div>

    <!-- Make Instrumental Toggle -->
    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="music-instrumental" style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Make Instrumental</span>
    </label>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; margin-left: 1.5rem;">Create a song without lyrics</div>
    </div>

    <!-- Album Art Style Selector -->
    <!-- Wrap this dropdown in a container div -->
        <div id="album-art-style-container" style="display:none;">
        <label class="form-label">Album Art Style for auto-generated art</label>
        <select id="album-art-style">
    <option value="photorealistic" selected>Photorealistic</option>
    <option value="abstract">Abstract</option>
    <option value="cyberpunk">Cyberpunk</option>
    <option value="retro">Retro</option>
    <option value="minimal">Minimal</option>
    <option value="surreal">Surreal</option>
    <option value="cinematic">Cinematic</option>
    <option value="artistic">Artistic</option>
        </select>
        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
    Choose the visual style for Album Art
  </div>
</div>

    <img src="/assets/generation_1761528477757.gif" id="generate-music-btn" style="width: 400px; cursor: pointer; display: block;" alt="Generate Music">
    <div id="music-result" style="display: none;"></div>
    </div>
    </div>

    <!-- Hero Section -->
    <div class="hero-text">
    <h1>AI Music and Media Center</h1>
    <p class="subtitle">Create music, chat with AI, and generate album art - all in one creative studio</p>
    </div>

    <!-- Chat Panel -->
    <div class="panel panel-chat">
    <div class="panel-header">
    <div class="panel-title"><img src="/assets/icon-set/lightning-icon.png" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle;"> AetherWave AI</div>
    <div class="panel-description">Your creative companion</div>
    </div>
    <div class="panel-content">
    <div class="chat-messages">
    <div class="message assistant">
    <div class="message-label">AetherWave AI</div>
    <div class="message-content">
    Hello! I can help you create music, generate album art, or answer questions about AetherWave Studio. What would you like to create today?
    </div>
    </div>
    </div>
    </div>
    <div class="chat-input-area">
    <div class="input-wrapper">
    <input type="text" id="chat-input" placeholder="Ask me anything..." />
    <button class="send-btn" id="send-btn">Send</button>
    </div>
    <div class="suggestions">
    <div class="suggestion-chip">Prompts for Music</div>
    <div class="suggestion-chip">Lyric Generation</div>
    <div class="suggestion-chip">Album Art tips</div>
    </div>
    </div>
    </div>

    <!-- Visual Generation Panel -->
    <div class="panel panel-media">
    <div class="panel-header">
    <div class="panel-title"><img src="/assets/icon-set/camera1-icon.png" style="width: 24px; height: 24px; margin-right: 0.5rem; vertical-align: middle;"> AI Media Generator</div>
    <div class="panel-description">Create images and videos for your music career</div>
    </div>
    <div class="panel-content">

    <!-- Step 1: Media Type Selection -->
    <div id="media-type-selection">
    <div class="form-group">
    <label class="form-label">What do you want to create?</label>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
    <button class="media-type-btn active" data-type="image" style="flex: 1; padding: 1rem; background: url('/assets/Pick-btn_1761529942548.png') no-repeat center center; background-size: 100% 100%; border: none; border-radius: 50px; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
    📸 Image
    </button>
    <button class="media-type-btn" data-type="video" style="flex: 1; padding: 1rem; background: url('/assets/Pick-btn_1761529942548.png') no-repeat center center; background-size: 100% 100%; border: none; border-radius: 50px; color: var(--text-primary); font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
    🎥 Video
    </button>
    </div>
    </div>
    </div>

    <!-- Step 2: Use Case Selection -->
    <div id="use-case-selection" style="margin-top: 1.5rem;">
    <div class="form-group">
    <label class="form-label">Choose your use case</label>
    <div class="use-case-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">

    <!-- Band Profile Card -->
    <div class="use-case-card" data-use-case="band-profile" data-testid="card-use-case-band-profile">
    <div class="use-case-icon"><img src="/assets/icon-set/profile-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">Band Profile</div>
    <div class="use-case-tooltip">
    <strong>Band Profile</strong>
    <p>Professional artist photos for press kits, social media profiles, and promotional materials</p>
    <em>Example: "Indie rock band posing in urban alley with vintage instruments"</em>
    </div>
    </div>

    <!-- Live Photos Card -->
    <div class="use-case-card" data-use-case="live-photos" data-testid="card-use-case-live-photos">
    <div class="use-case-icon"><img src="/assets/icon-set/star-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">Live Photos</div>
    <div class="use-case-tooltip">
    <strong>Live Photos</strong>
    <p>Dynamic concert and performance shots with energy and atmosphere</p>
    <em>Example: "Singer performing on stage with dramatic lighting and crowd"</em>
    </div>
    </div>

    <!-- Live Video Card -->
    <div class="use-case-card" data-use-case="live-video">
    <div class="use-case-icon"><img src="/assets/icon-set/microphone-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">Live Video</div>
    <div class="use-case-tooltip">
    <strong>Live Video</strong>
    <p>Concert footage and performance clips for social media and promotion</p>
    <em>Example: "Guitarist shredding solo with flashing stage lights"</em>
    </div>
    </div>

    <!-- Production Video Card -->
    <div class="use-case-card" data-use-case="production-video">
    <div class="use-case-icon"><img src="/assets/icon-set/camera1-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">Production Video</div>
    <div class="use-case-tooltip">
    <strong>Production Video</strong>
    <p>Professional music videos with cinematic quality and storytelling</p>
    <em>Example: "Cinematic shots of artist walking through neon-lit city"</em>
    </div>
    </div>

    <!-- Backstage Pass Card -->
    <div class="use-case-card" data-use-case="backstage">
    <div class="use-case-icon"><img src="/assets/icon-set/star-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">Backstage Pass</div>
    <div class="use-case-tooltip">
    <strong>Backstage Pass</strong>
    <p>Behind-the-scenes content showing the artist life and creative process</p>
    <em>Example: "Band members relaxing in green room with instruments"</em>
    </div>
    </div>

    <!-- On The Road Card -->
    <div class="use-case-card" data-use-case="on-the-road">
    <div class="use-case-icon"><img src="/assets/icon-set/camera2-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">On The Road</div>
    <div class="use-case-tooltip">
    <strong>On The Road</strong>
    <p>Tour life, travel scenes, and adventure content for storytelling</p>
    <em>Example: "Tour bus driving through desert landscape at sunset"</em>
    </div>
    </div>

    <!-- Album Art Card -->
    <div class="use-case-card" data-use-case="album-art">
    <div class="use-case-icon"><img src="/assets/icon-set/music-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">Album Art</div>
    <div class="use-case-tooltip">
    <strong>Album Art</strong>
    <p>Square format cover art for singles, EPs, and full albums</p>
    <em>Example: "Abstract geometric shapes in vibrant neon colors"</em>
    </div>
    </div>

    <!-- News Reports Card -->
    <div class="use-case-card" data-use-case="news-reports">
    <div class="use-case-icon"><img src="/assets/icon-set/mail-icon.png" style="width: 40px; height: 40px;"></div>
    <div class="use-case-name">News Reports</div>
    <div class="use-case-tooltip">
    <strong>News Reports</strong>
    <p>Press-style imagery and announcement visuals for releases and events</p>
    <em>Example: "Breaking news style graphic with artist announcement"</em>
    </div>
    </div>

    </div>
    </div>
    </div>

    <!-- Step 3: Generation Settings (shown after use case selected) -->
    <div id="generation-settings" style="display: none; margin-top: 1.5rem;">

    <!-- Enhanced Prompt Preview -->
    <div class="form-group">
    <label class="form-label">AI Prompt (edit to customize)</label>
    <textarea id="enhanced-prompt" rows="4" placeholder="Your enhanced prompt will appear here..." style="font-family: monospace; font-size: 0.9rem;"></textarea>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">This is the full prompt sent to the AI. Feel free to edit it!</div>
    </div>

    <!-- User's Creative Input -->
    <div class="form-group">
    <label class="form-label">Your Vision (optional - add custom details)</label>
    <textarea id="user-vision" rows="2" placeholder="e.g., wearing leather jacket, vintage 80s aesthetic, purple color scheme..."></textarea>
    </div>

    <!-- Video Model Selection (SHOWN FIRST for video, BEFORE image uploaders) -->
    <div class="form-group" id="video-model-group" style="display: none;">
    <label class="form-label">🎬 Video Model</label>
    <select id="media-video-model">
    <option value="seedance-lite" selected>Seedance Lite (Free+)</option>
    <option value="seedance-pro-fast" data-plan="studio">Seedance Pro Fast (Studio+)</option>
    <option value="seedance-pro" data-plan="creator">Seedance Pro (Creator+ - Highest Quality)</option>
    <option value="sora2" data-plan="studio">Sora 2 Standard (Studio+ - OpenAI)</option>
    <option value="veo3_fast" data-plan="creator">Veo 3 Fast (Creator+ - Google)</option>
    </select>
    </div>

    <!-- Image Upload (Optional - shown for images OR for video reference) -->
    <div class="form-group" id="image-upload-group">
    <label class="form-label">
    <span id="image-upload-label">Reference Image (Optional)</span>
    <span id="image-label-hint" style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal; margin-left: 0.5rem;"></span>
    </label>
    <input type="file" id="media-image-upload" accept="image/*" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer;">
    </div>

    <!-- Image Preview for first uploader -->
    <div id="media-image-preview" style="display: none; margin-top: 0.5rem;">
    <img id="media-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);" />
    <button type="button" id="media-clear-image" class="download-btn" style="margin-top: 0.5rem; display: inline-block;">Clear Image</button>
    </div>

    <!-- Second Image Upload for VEO 3.1 Fast Last Frame (hidden by default) -->
    <div class="form-group" id="last-frame-upload-group" style="display: none; margin-top: 0.75rem;">
    <label class="form-label">
    <span>Upload Image (Optional)</span>
    <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal; margin-left: 0.5rem;">- Last frame</span>
    </label>
    <input type="file" id="media-last-frame-upload" accept="image/*" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer;">

    <!-- Preview for last frame image -->
    <div id="media-last-frame-preview" style="display: none; margin-top: 0.5rem;">
    <img id="media-last-frame-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);" />
    <button type="button" id="media-clear-last-frame" class="download-btn" style="margin-top: 0.5rem; display: inline-block;">Clear Last Frame Image</button>
    </div>
    </div>

    <!-- Image Mode Selection (shown only for video when image uploaded) -->
    <div id="image-mode-selection" style="display: none; margin-top: 0.75rem;">
    <label class="form-label">Image Mode</label>
    <select id="image-mode" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    <option value="reference">Style Reference</option>
    <option value="first-frame">First Frame</option>
    <option value="last-frame">Last Frame</option>
    </select>
    </div>

    <!-- Image Engine Selector (only for images, not videos) -->
    <div class="form-group" id="image-engine-group" style="display: block;">
    <label class="form-label">🎨 Image Engine</label>
    <select id="media-image-engine" data-testid="select-image-engine">
    <option value="nano-banana" selected>⚡ Nano Banana - Fast & Reliable (~5s, Free+)</option>
    <option value="dall-e-3" data-plan="studio">🎨 DALL-E 3 - High Quality (~10s, Studio+)</option>
    <option value="midjourney" data-plan="studio">🏆 Midjourney (KIE.ai) - Premium Quality (may have delays, Studio+)</option>
    <option value="midjourney-ttapi" data-plan="studio">🚀 Midjourney (ttapi.io) - NEW! Test Provider (Studio+)</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
      <span id="engine-description">Nano Banana: Lightning-fast generation with professional results</span>
    </div>
    </div>

    <!-- Midjourney Speed Selector (only shown when Midjourney is selected) -->
    <div class="form-group" id="midjourney-speed-group" style="display: none;">
    <label class="form-label">⚡ Generation Speed</label>
    <select id="midjourney-speed" data-testid="select-midjourney-speed">
    <option value="fast" selected>Fast (~60-90s, 3 credits)</option>
    <option value="turbo">Turbo (~15-60s, 6 credits)</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Turbo is 2x faster but costs 2x more credits</div>
    </div>

    <!-- Image Aspect Ratio Selector (only for images, not videos) -->
    <div class="form-group" id="image-aspect-ratio-group" style="display: block;">
    <label class="form-label">📐 Aspect Ratio</label>
    <select id="media-image-aspect-ratio" data-testid="select-image-aspect-ratio">
    <option value="1:1" selected>1:1 (Square)</option>
    <option value="16:9">16:9 (Landscape)</option>
    <option value="9:16">9:16 (Portrait)</option>
    <option value="4:3">4:3 (Classic Landscape)</option>
    <option value="3:4">3:4 (Classic Portrait)</option>
    </select>
    </div>

    <!-- Image Style Selector (only for images, not videos) -->
    <div class="form-group" id="image-style-group" style="display: block;">
    <label class="form-label">Image Style</label>
    <select id="media-image-style">
    <option value="photorealistic">Photorealistic</option>
    <option value="abstract">Abstract</option>
    <option value="cyberpunk">Cyberpunk</option>
    <option value="retro">Retro</option>
    <option value="minimal">Minimal</option>
    <option value="surreal">Surreal</option>
    <option value="cinematic">Cinematic</option>
    <option value="artistic">Artistic</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Choose the visual style for your generated image</div>
    </div>

    <!-- Seedance: Resolution -->
    <div class="form-group" id="video-resolution-group" style="display: none;">
    <label class="form-label">Resolution (Seedance only)</label>
    <select id="media-resolution">
    <option value="480p" selected>480p (Fastest)</option>
    <option value="720p">720p (Balanced)</option>
    <option value="1080p">1080p (High Quality)</option>
    <option value="4k" data-exclude-lite data-exclude-pro-fast data-plan="creator">4K (Ultra Quality, Pro only)</option>
    </select>
    </div>

    <!-- VEO/SORA: Aspect Ratio -->
    <div class="form-group" id="video-aspect-ratio-group" style="display: none;">
    <label class="form-label">Aspect Ratio</label>
    <select id="media-aspect-ratio">
    <option value="16:9" selected>16:9 (Landscape - YouTube)</option>
    <option value="9:16">9:16 (Portrait - TikTok/Reels)</option>
    <option value="1:1" data-exclude-veo3>1:1 (Square - Instagram)</option>
    <option value="4:3" data-exclude-veo3>4:3 (Classic)</option>
    <option value="21:9" data-exclude-veo3>21:9 (Cinematic)</option>
    <option value="auto">Auto (Model decides)</option>
    </select>
    </div>

    <!-- Duration -->
    <div class="form-group" id="video-duration-group" style="display: none;">
    <label class="form-label">Duration</label>
    <select id="media-duration">
    <option value="3" data-exclude-lite>3 seconds</option>
    <option value="5" selected>5 seconds</option>
    <option value="8">8 seconds</option>
    <option value="10">10 seconds</option>
    </select>
    <div id="credit-cost-preview" style="font-size: 0.85rem; color: var(--accent-color); margin-top: 0.5rem; font-weight: 600;"></div>
    </div>

    <!-- Advanced Settings (collapsible) - HIDDEN -->
    <div class="form-group" style="display: none;">
    <details>
    <summary style="cursor: pointer; font-weight: 600; color: var(--accent-color); margin-bottom: 1rem;">⚙️ Advanced Settings</summary>

    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="media-safety-checker" checked style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Enable Safety Checker</span>
    </label>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; margin-left: 1.5rem;">Uncheck if getting false rejections</div>
    </div>
    </details>
    </div>

    <!-- Generate Button -->
    <button id="generate-media-btn" data-testid="button-generate-media" style="width: 100%;">
    🎨 Generate <span id="media-type-label">Image</span>
    </button>

    <!-- Back Button -->
    <button class="download-btn" id="back-to-use-cases" data-testid="button-back-to-use-cases" style="width: 100%; margin-top: 0.5rem;">
    ← Back to Use Cases
    </button>
    </div>

    <!-- Results Display -->
    <div id="media-result" style="display: none; margin-top: 1.5rem;"></div>
    </div>
    </div>
    </div>
  </main>

  <!-- Mobile Bottom Navigation -->
  <div class="mobile-bottom-nav" id="mobile-bottom-nav">
    <div class="mobile-bottom-nav-items">
      <button class="mobile-nav-btn active" data-panel="music" data-testid="mobile-nav-music">
        <img src="/assets/icon-set/music-icon.png" alt="Music">
        <span>Music</span>
      </button>
      <button class="mobile-nav-btn" data-panel="chat" data-testid="mobile-nav-chat">
        <img src="/assets/icon-set/mail-icon.png" alt="Chat">
        <span>Chat</span>
      </button>
      <button class="mobile-nav-btn" data-panel="media" data-testid="mobile-nav-media">
        <img src="/assets/icon-set/camera1-icon.png" alt="Media">
        <span>Media</span>
      </button>
    </div>
  </div>

  <script>
    // Error handling wrapper
    window.addEventListener('error', (e) => {
    console.error('Global error:', e.message, e.filename, e.lineno, e.colno);
    });

    // Global user state
    let currentUser = null;
    let userCredits = 0;

    // Check authentication status and update UI
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/user', { credentials: 'include' });
        if (response.ok) {
          const user = await response.json();
          
          // Store user data globally for profile modal
          currentUser = user;
          
          // Fetch user credits
          const creditsResponse = await fetch('/api/user/credits', { credentials: 'include' });
          if (creditsResponse.ok) {
            const creditsData = await creditsResponse.json();
            userCredits = creditsData.credits || 0;
          }
          
          // User is logged in
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('user-profile').style.display = 'flex';
          
          // Truncate username to 20 characters
          const fullName = user.firstName || user.email || 'User';
          const displayName = fullName.length > 20 ? fullName.substring(0, 20) + '...' : fullName;
          document.getElementById('user-name').textContent = displayName;
          
          // Always use the profile icon
          document.getElementById('user-avatar').src = '/assets/icon-set/profile-icon.png';
          document.getElementById('user-avatar').alt = user.firstName || user.email || 'User';
          
          // Load user's vocal gender preference
          if (user.vocalGenderPreference) {
            const genderBtn = document.querySelector(`.gender-toggle-btn[data-gender="${user.vocalGenderPreference}"]`);
            if (genderBtn) {
              document.querySelectorAll('.gender-toggle-btn').forEach(b => b.classList.remove('active'));
              genderBtn.classList.add('active');
              document.getElementById('vocal-gender-value').value = user.vocalGenderPreference;
            }
          }
          
          // Attach event listener to profile trigger (after profile section is shown)
          const profileTrigger = document.getElementById('profile-trigger');
          if (profileTrigger && !profileTrigger.hasAttribute('data-listener-attached')) {
            profileTrigger.addEventListener('click', function() {
              console.log('Profile trigger clicked');
              if (window.showProfileModal) {
                window.showProfileModal();
              } else {
                console.error('showProfileModal function not found');
              }
            });
            profileTrigger.setAttribute('data-listener-attached', 'true');
            console.log('Profile trigger event listener attached');
          }
        } else {
          // User not logged in
          document.getElementById('login-btn').style.display = 'inline-block';
          document.getElementById('user-profile').style.display = 'none';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Show login button on error
        document.getElementById('login-btn').style.display = 'inline-block';
        document.getElementById('user-profile').style.display = 'none';
      }
    }

    // Check auth on page load
    checkAuth();

    // Mobile Navigation Controller
    function initMobileNavigation() {
      const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
      const panels = {
        music: document.querySelector('.panel-music'),
        chat: document.querySelector('.panel-chat'),
        media: document.querySelector('.panel-media')
      };
      
      // Set initial active panel (music)
      if (window.innerWidth <= 768) {
        panels.music.classList.add('mobile-active');
        panels.chat.classList.remove('mobile-active');
        panels.media.classList.remove('mobile-active');
      }
      
      // Handle mobile nav clicks
      mobileNavBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const targetPanel = this.getAttribute('data-panel');
          
          // Update button states
          mobileNavBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update panel visibility (only on mobile)
          if (window.innerWidth <= 768) {
            Object.keys(panels).forEach(key => {
              if (key === targetPanel) {
                panels[key].classList.add('mobile-active');
                panels[key].scrollIntoView({ behavior: 'smooth', block: 'start' });
              } else {
                panels[key].classList.remove('mobile-active');
              }
            });
          }
        });
      });
      
      // Handle window resize - clean up mobile classes on desktop
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          if (window.innerWidth > 768) {
            // Desktop mode - remove mobile-active classes
            Object.values(panels).forEach(panel => {
              panel.classList.remove('mobile-active');
            });
          } else {
            // Mobile mode - ensure one panel is active
            const hasActive = Array.from(Object.values(panels)).some(p => p.classList.contains('mobile-active'));
            if (!hasActive) {
              panels.music.classList.add('mobile-active');
            }
          }
        }, 250);
      });
    }
    
    // Initialize mobile navigation on page load
    initMobileNavigation();

    // Credit Management
    let userPlanType = 'free';
    
    async function fetchUserCredits() {
      try {
        const response = await fetch('/api/user/credits', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          userCredits = data.credits;
          userPlanType = data.planType;
          updateCreditsDisplay();
          
          // Apply quality restrictions based on media type
          if (selectedMediaType === 'video') {
            applyVideoQualityRestrictions();
          } else {
            applyImageEngineRestrictions();
          }
          
          // Auto-check for daily reset
          await checkDailyReset();
        } else if (response.status === 401) {
          // User not authenticated - hide credits display
          const creditsIndicator = document.querySelector('.credits-indicator');
          if (creditsIndicator) {
            creditsIndicator.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Failed to fetch credits:', error);
        // Hide credits on error
        const creditsIndicator = document.querySelector('.credits-indicator');
        if (creditsIndicator) {
          creditsIndicator.style.display = 'none';
        }
      }
    }
    
    async function checkDailyReset() {
      try {
        const response = await fetch('/api/user/credits/check-reset', { method: 'POST', credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          if (data.resetOccurred) {
            userCredits = data.credits;
            updateCreditsDisplay();
            showNotification('Daily credits reset! You now have 50 credits.', 'success');
          }
        }
      } catch (error) {
        console.error('Failed to check daily reset:', error);
      }
    }
    
    function updateCreditsDisplay() {
      const creditsElement = document.getElementById('credits-count');
      const creditsIndicator = document.querySelector('.credits-indicator');
      const questGiftIcon = document.getElementById('quest-gift-icon');

      if (creditsElement && creditsIndicator) {
        // Show the indicator
        creditsIndicator.style.display = 'flex';

        if (userPlanType === 'studio' || userPlanType === 'creator' || userPlanType === 'all_access') {
          creditsElement.textContent = '∞';
          creditsIndicator.title = 'Unlimited music credits - Click to view plans';
          // Hide quest icon for paid users
          if (questGiftIcon) questGiftIcon.style.display = 'none';
        } else {
          creditsElement.textContent = userCredits;
          creditsIndicator.title = `${userCredits} credits remaining - Click to upgrade`;
          // Show quest icon for free users
          if (questGiftIcon) questGiftIcon.style.display = 'flex';
          // Load and check for uncompleted quests
          loadQuests();
        }
      }
    }

    // ===== QUEST SYSTEM FUNCTIONS =====

    let userQuests = [];

    async function loadQuests() {
      try {
        const response = await fetch('/api/quests');
        if (!response.ok) throw new Error('Failed to load quests');

        const data = await response.json();
        userQuests = data.quests;

        // Update notification badge
        const uncompletedCount = userQuests.filter(q => !q.completed).length;
        const badge = document.getElementById('quest-notification-badge');
        if (badge) {
          if (uncompletedCount > 0) {
            badge.textContent = uncompletedCount;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }

        return data;
      } catch (error) {
        console.error('Error loading quests:', error);
        return null;
      }
    }

    async function showQuestModal() {
      const modal = document.getElementById('quest-modal');
      const questList = document.getElementById('quest-list');

      modal.style.display = 'flex';

      // Load quests
      const data = await loadQuests();
      if (!data) {
        questList.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            Failed to load quests. Please try again later.
          </div>
        `;
        return;
      }

      // Render quests
      questList.innerHTML = userQuests.map(quest => {
        const completed = quest.completed;
        const icon = getQuestIcon(quest.type);
        const buttonText = completed ? '✓ Completed' : `Complete (+${quest.reward} credits)`;
        const buttonDisabled = completed ? 'disabled' : '';
        const questUrl = getQuestUrl(quest.type);

        return `
          <div style="background: ${completed ? 'rgba(46, 213, 115, 0.1)' : 'rgba(139, 92, 246, 0.1)'}; border: 2px solid ${completed ? 'rgba(46, 213, 115, 0.3)' : 'rgba(139, 92, 246, 0.3)'}; border-radius: 12px; padding: 1.25rem; display: flex; align-items: center; gap: 1rem;">
            <div style="font-size: 2rem; flex-shrink: 0;">${icon}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 0.25rem;">
                ${quest.name}
              </div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                ${quest.description}
              </div>
            </div>
            <div style="text-align: right; flex-shrink: 0;">
              <div style="font-size: 1.1rem; font-weight: 700; color: var(--aetherwave-pink); margin-bottom: 0.5rem;">
                +${quest.reward}
              </div>
              ${completed ?
                `<button style="padding: 0.5rem 1rem; background: rgba(46, 213, 115, 0.2); border: 1px solid rgba(46, 213, 115, 0.5); border-radius: 8px; color: #2ed573; font-weight: 600; font-size: 0.85rem; cursor: not-allowed;" disabled>${buttonText}</button>` :
                `<a href="${questUrl}" target="_blank" onclick="setTimeout(() => completeQuest('${quest.type}'), 2000)" style="display: inline-block; padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 0.85rem; cursor: pointer; text-decoration: none; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 46, 166, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">${buttonText}</a>`
              }
            </div>
          </div>
        `;
      }).join('');
    }

    function closeQuestModal() {
      const modal = document.getElementById('quest-modal');
      modal.style.display = 'none';
    }

    function getQuestIcon(type) {
      const icons = {
        twitter_follow: '🐦',
        discord_join: '💬',
        facebook_follow: '👍',
        tiktok_follow: '🎵'
      };
      return icons[type] || '⭐';
    }

    function getQuestUrl(type) {
      const urls = {
        twitter_follow: 'https://x.com/aetherwave_ai',
        discord_join: 'https://discord.gg/BVRHUfZS',
        facebook_follow: 'https://facebook.com/AetherWaveStudio',
        tiktok_follow: 'https://tiktok.com/@AetherWaveStudio'
      };
      return urls[type] || '#';
    }

    async function completeQuest(questType) {
      try {
        const response = await fetch('/api/quests/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ questType })
        });

        if (!response.ok) {
          const data = await response.json();
          showNotification(data.error || 'Failed to complete quest', 'error');
          return;
        }

        const data = await response.json();
        userCredits = data.newBalance;
        updateCreditsDisplay();
        showNotification(data.message, 'success');

        // Reload quest modal
        showQuestModal();

      } catch (error) {
        console.error('Error completing quest:', error);
        showNotification('Failed to complete quest', 'error');
      }
    }

    // ===== END QUEST SYSTEM =====

    function applyVideoQualityRestrictions() {
      const videoModel = document.getElementById('media-video-model');
      const resolution = document.getElementById('media-resolution');
      const duration = document.getElementById('media-duration');

      // Check if elements exist before accessing them
      if (!videoModel || !resolution || !duration) {
        console.warn('Video quality restriction elements not found');
        return;
      }

      if (userPlanType === 'free') {
        // Free accounts can only use lowest settings
        videoModel.value = 'seedance-lite';
        resolution.value = '480p';
        duration.value = '5';

        // Disable all dropdowns
        videoModel.disabled = true;
        resolution.disabled = true;
        duration.disabled = true;

        // Add visual indicator
        videoModel.style.opacity = '0.6';
        resolution.style.opacity = '0.6';
        duration.style.opacity = '0.6';

        // Add tooltips
        videoModel.title = 'Upgrade to access higher quality models';
        resolution.title = 'Upgrade to access higher resolutions';
        duration.title = 'Upgrade to access longer durations';
      } else {
        // Paid accounts can use all settings
        videoModel.disabled = false;
        resolution.disabled = false;
        duration.disabled = false;

        videoModel.style.opacity = '1';
        resolution.style.opacity = '1';
        duration.style.opacity = '1';

        videoModel.title = '';
        resolution.title = '';
        duration.title = '';
      }
    }

    function applyImageEngineRestrictions() {
      const imageEngine = document.getElementById('media-image-engine');

      // Check if element exists
      if (!imageEngine) {
        return;
      }

      if (userPlanType === 'free') {
        // Free accounts can only use Nano Banana
        imageEngine.value = 'nano-banana';
        
        // Disable DALL-E 3 and Midjourney options
        const dallE3Option = imageEngine.querySelector('option[value="dall-e-3"]');
        if (dallE3Option) {
          dallE3Option.disabled = true;
        }
        
        const midjourneyOption = imageEngine.querySelector('option[value="midjourney"]');
        if (midjourneyOption) {
          midjourneyOption.disabled = true;
        }
      } else {
        // Paid accounts (Studio+) can use all engines
        const dallE3Option = imageEngine.querySelector('option[value="dall-e-3"]');
        if (dallE3Option) {
          dallE3Option.disabled = false;
        }
        
        const midjourneyOption = imageEngine.querySelector('option[value="midjourney"]');
        if (midjourneyOption) {
          midjourneyOption.disabled = false;
        }
      }

      // Trigger visibility update for Midjourney speed selector
      updateMidjourneySpeedVisibility();
    }

    function updateMidjourneySpeedVisibility() {
      const imageEngine = document.getElementById('media-image-engine');
      const speedGroup = document.getElementById('midjourney-speed-group');
      
      if (imageEngine && speedGroup) {
        const isMidjourney = imageEngine.value === 'midjourney' || imageEngine.value === 'midjourney-ttapi';
        speedGroup.style.display = isMidjourney ? 'block' : 'none';
      }
    }

    function updateEngineDescription() {
      const imageEngine = document.getElementById('media-image-engine');
      const descriptionEl = document.getElementById('engine-description');
      
      if (!imageEngine || !descriptionEl) return;
      
      const descriptions = {
        'nano-banana': 'Nano Banana: Lightning-fast generation (~5s) with professional results. Best for quick iterations!',
        'dall-e-3': 'DALL-E 3: High-quality, creative AI images with precise prompt following (~10s)',
        'midjourney': 'Midjourney (KIE.ai): Premium artistic quality, but may experience server delays. Try Nano Banana for instant results!',
        'midjourney-ttapi': 'Midjourney (ttapi.io): NEW test provider! Same quality as KIE.ai, compare performance yourself.'
      };
      
      descriptionEl.textContent = descriptions[imageEngine.value] || descriptions['nano-banana'];
      
      // Highlight warning for Midjourney KIE.ai
      if (imageEngine.value === 'midjourney') {
        descriptionEl.style.color = '#ff9500';
      } else if (imageEngine.value === 'midjourney-ttapi') {
        descriptionEl.style.color = '#22c55e'; // Green for new/test
      } else {
        descriptionEl.style.color = 'var(--text-muted)';
      }
    }

    // Add event listener for image engine changes
    const imageEngineSelector = document.getElementById('media-image-engine');
    if (imageEngineSelector) {
      imageEngineSelector.addEventListener('change', function() {
        updateMidjourneySpeedVisibility();
        updateEngineDescription();
      });
    }
    
    
    async function deductCredits(amount = 5) {
      try {
        const response = await fetch('/api/user/credits/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount })
        });
        
        if (!response.ok) {
          const data = await response.json();
          if (response.status === 403) {
            // Insufficient credits - show payment modal
            showPaymentModal();
            throw new Error('Insufficient credits');
          }
          throw new Error(data.message || 'Failed to deduct credits');
        }
        
        const data = await response.json();
        userCredits = data.credits;
        updateCreditsDisplay();
        return true;
      } catch (error) {
        console.error('Failed to deduct credits:', error);
        throw error;
      }
    }
    
    function showPaymentModal() {
      const modal = document.createElement('div');
      modal.id = 'payment-modal';
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(13, 11, 21, 0.95);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.3s ease-out;
      `;
      
      modal.innerHTML = `
        <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.4s ease-out; overflow: hidden;">
          <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
            <h2 style="font-size: 1.75rem; font-weight: 700; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
              Upgrade Your Plan
            </h2>
            <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.95rem;">
              You've run out of credits! Choose a plan to continue creating amazing content.
            </p>
          </div>
          
          <div style="flex: 1; overflow-y: auto; overflow-x: hidden;">
          
          
          <div style="padding: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem;">
            
            <!-- Free Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/music-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Free</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$0<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>50 credits/day</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Basic music gen</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Standard quality</span>
                </li>
              </ul>
              <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 0.65rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                Current Plan
              </div>
            </div>

            <!-- Starter Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/video-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Starter</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$9.99<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">200</strong> media credits/mo</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">SORA 2</strong> video access</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>No watermarks</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Basic music gen</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>WAV conversion</span>
                </li>
              </ul>
              <button onclick="contactSupport('Starter')" style="width: 100%; padding: 0.75rem; background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Upgrade
              </button>
            </div>

            <!-- Studio Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/microphone-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Studio</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$19<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music (all models)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> WAV conversion</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>500 media credits/mo</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Lite videos (all resolutions)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Commercial license</span>
                </li>
              </ul>
              <button onclick="contactSupport('Studio')" style="width: 100%; padding: 0.75rem; background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Upgrade
              </button>
            </div>
            
            <!-- Creator Plan -->
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 46, 166, 0.05)); border: 2px solid var(--aetherwave-purple); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0.75rem; right: 0.75rem; background: var(--aetherwave-purple); color: white; font-size: 0.65rem; font-weight: 600; padding: 0.3rem 0.65rem; border-radius: 12px;">POPULAR</div>
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/camera1-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Creator</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$49<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music (all models)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> WAV conversion</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">2000</strong> media credits/mo</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Lite & Pro videos (all resolutions)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>All image engines</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Commercial license</span>
                </li>
              </ul>
              <button onclick="contactSupport('Creator')" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255, 46, 166, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                Upgrade
              </button>
            </div>
            
            <!-- All Access Pass -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="margin-bottom: 0.5rem;"><img src="/assets/icon-set/lightning-icon.png" style="width: 48px; height: 48px;"></div>
                <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">All Access</h3>
                <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$99<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music (all models)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> WAV conversion</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">5000</strong> media credits/mo (rate-limited)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Lite & Pro videos (all resolutions including 4K)</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>All image engines</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>Commercial license</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">API access</strong> & priority support</span>
                </li>
              </ul>
              <button onclick="contactSupport('All Access')" style="width: 100%; padding: 0.75rem; background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Upgrade
              </button>
            </div>
          </div>
          
          <!-- Credit Bundles Section -->
          <div style="padding: 0 2rem 2rem 2rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">💎 One-Time Credit Bundles</h3>
              <p style="color: var(--text-muted); font-size: 0.9rem;">No subscription needed - purchase credits as you need them</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem;">
              
              <!-- Starter Bundle -->
              <div style="background: rgba(6, 182, 212, 0.05); border: 2px solid rgba(6, 182, 212, 0.3); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column;">
                <div style="text-align: center; margin-bottom: 1.25rem;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">💎</div>
                  <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Starter Bundle</h3>
                  <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$10<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);"> one-time</span></div>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span><strong style="color: var(--text-primary);">250</strong> credits</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>Never expires</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>50 music generations</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>$0.04 per credit</span>
                  </li>
                </ul>
                <button onclick="purchaseBundle('Starter Bundle', 250, 10)" style="width: 100%; padding: 0.75rem; background: rgba(6, 182, 212, 0.2); color: var(--text-primary); border: 1px solid rgba(6, 182, 212, 0.4); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(6, 182, 212, 0.3)'; this.style.borderColor='var(--aetherwave-cyan)'" onmouseout="this.style.background='rgba(6, 182, 212, 0.2)'; this.style.borderColor='rgba(6, 182, 212, 0.4)'">
                  Purchase Now
                </button>
              </div>
              
              <!-- Power Bundle -->
              <div style="background: rgba(6, 182, 212, 0.05); border: 2px solid rgba(6, 182, 212, 0.3); border-radius: 16px; padding: 1.5rem; display: flex; flex-direction: column; position: relative;">
                <div style="position: absolute; top: 0.75rem; right: 0.75rem; background: var(--aetherwave-cyan); color: white; font-size: 0.65rem; font-weight: 600; padding: 0.3rem 0.65rem; border-radius: 12px;">BEST VALUE</div>
                <div style="text-align: center; margin-bottom: 1.25rem;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">💎💎</div>
                  <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Power Bundle</h3>
                  <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">$25<span style="font-size: 0.85rem; font-weight: 400; color: var(--text-muted);"> one-time</span></div>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0 0 1.25rem 0; flex: 1;">
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span><strong style="color: var(--text-primary);">750</strong> credits</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>Never expires</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span>150 music generations</span>
                  </li>
                  <li style="color: var(--text-muted); font-size: 0.85rem; padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--aetherwave-cyan);">✓</span>
                    <span><strong style="color: var(--text-primary);">$0.033</strong> per credit</span>
                  </li>
                </ul>
                <button onclick="purchaseBundle('Power Bundle', 750, 25)" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, rgba(6, 182, 212, 0.4), rgba(6, 182, 212, 0.2)); color: var(--text-primary); border: 1px solid var(--aetherwave-cyan); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(6, 182, 212, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                  Purchase Now
                </button>
              </div>
              
            </div>
          </div>
          </div>
          
          <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: center; flex-shrink: 0;">
            <button onclick="closePaymentModal()" style="padding: 0.75rem 2rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--aetherwave-purple)'; this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-muted)'">
              Maybe Later
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function closePaymentModal() {
      const modal = document.getElementById('payment-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => modal.remove(), 300);
      }
    }
    
    function contactSupport(planName) {
      alert(`To upgrade to ${planName}, please contact Replit support or the application developer. Payment integration coming soon!`);
      closePaymentModal();
    }
    
    function purchaseBundle(bundleName, credits, price) {
      alert(`To purchase ${bundleName} (${credits} credits for $${price}), please contact the application developer. Payment integration coming soon!`);
      closePaymentModal();
    }
    
    window.showProfileModal = function showProfileModal() {
      console.log('Profile modal function called, currentUser:', currentUser);
      if (!currentUser) {
        showNotification('Please log in to view your profile');
        return;
      }
      
      const modal = document.createElement('div');
      modal.id = 'profile-modal';
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(13, 11, 21, 0.95);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.3s ease-out;
      `;
      
      const planNames = {
        'free': 'Free',
        'studio': 'Studio Member',
        'creator': 'Creator',
        'all_access': 'All Access Pass'
      };
      
      const planName = planNames[currentUser.subscriptionPlan] || 'Free';
      
      modal.innerHTML = `
        <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.4s ease-out; overflow: hidden;">
          <div style="padding: 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background: url('/assets/header-panel_1761541736595.png') no-repeat center center; background-size: cover;">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem;">
              <img src="${currentUser.profileImageUrl || '/assets/icon-set/profile-icon.png'}" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--aetherwave-purple); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);">
              <div>
                <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                  ${currentUser.username || currentUser.email || 'User'}
                </h2>
                <p style="color: var(--text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">
                  ${currentUser.email || ''}
                </p>
              </div>
            </div>
          </div>
          
          <div style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 2rem;">
            
            <!-- Account Info -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/icon-set/star-icon.png" style="width: 20px; height: 20px;">
                Account Details
              </h3>
              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="display: grid; gap: 1rem;">
                  <div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Username</div>
                    <div style="color: var(--text-primary); font-weight: 500;">${currentUser.username || 'Not set'}</div>
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Email</div>
                    <div style="color: var(--text-primary); font-weight: 500;">${currentUser.email || 'Not set'}</div>
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">User ID</div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; font-family: monospace;">${currentUser.id}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Subscription Info -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/icon-set/lightning-icon.png" style="width: 20px; height: 20px;">
                Subscription Plan
              </h3>
              <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 46, 166, 0.05)); border: 2px solid var(--aetherwave-purple); border-radius: 12px; padding: 1.25rem;">
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                  ${planName}
                </div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                  ${currentUser.subscriptionPlan === 'free' ? 'Upgrade to unlock unlimited features' : 'Thank you for being a premium member!'}
                </div>
                <button onclick="closeProfileModal(); showPaymentModal();" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                  ${currentUser.subscriptionPlan === 'free' ? 'Upgrade Plan' : 'Manage Subscription'}
                </button>
              </div>
            </div>
            
            <!-- Credits Info -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/Coins_badge_1761542949252.png" style="width: 24px; height: 24px;">
                Credits Balance
              </h3>
              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                  ${userCredits.toLocaleString()} credits
                </div>
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.75rem;">
                  ${currentUser.subscriptionPlan === 'free' ? 'Resets daily at midnight' : 'Unlimited for your plan'}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.85rem;">
                  <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                    <div style="color: var(--text-muted); margin-bottom: 0.25rem;">Music Cost</div>
                    <div style="color: var(--text-primary); font-weight: 600;">5 credits</div>
                  </div>
                  <div style="padding: 0.75rem; background: rgba(255, 46, 166, 0.1); border-radius: 8px;">
                    <div style="color: var(--text-muted); margin-bottom: 0.25rem;">Image Cost</div>
                    <div style="color: var(--text-primary); font-weight: 600;">3 credits</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Preferences -->
            <div>
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <img src="/assets/icon-set/microphone-icon.png" style="width: 20px; height: 20px;">
                Preferences
              </h3>
              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Default Vocal Gender</div>
                <div style="color: var(--text-primary); font-weight: 500; text-transform: capitalize;">
                  ${currentUser.vocalGenderPreference === 'm' ? 'Male' : currentUser.vocalGenderPreference === 'f' ? 'Female' : 'Male'}
                </div>
              </div>
            </div>
            
          </div>
          
          <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: space-between; flex-shrink: 0;">
            <a href="/api/logout" style="padding: 0.75rem 1.5rem; background: rgba(244, 63, 94, 0.1); color: rgb(244, 63, 94); border: 1px solid rgba(244, 63, 94, 0.3); border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-decoration: none; display: inline-block;" onmouseover="this.style.background='rgba(244, 63, 94, 0.2)'" onmouseout="this.style.background='rgba(244, 63, 94, 0.1)'">
              Logout
            </a>
            <button onclick="closeProfileModal()" style="padding: 0.75rem 2rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
              Close
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    window.closeProfileModal = function closeProfileModal() {
      const modal = document.getElementById('profile-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => modal.remove(), 300);
      }
    }
    
    // Verify functions are set on window object
    console.log('Profile modal functions initialized:', {
      showProfileModal: typeof window.showProfileModal,
      closeProfileModal: typeof window.closeProfileModal
    });
    
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? 'rgba(74, 222, 128, 0.15)' : 'rgba(139, 92, 246, 0.15)'};
        border: 1px solid ${type === 'success' ? 'rgba(74, 222, 128, 0.3)' : 'rgba(139, 92, 246, 0.3)'};
        color: var(--text-primary);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(12px);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Show confirmation dialog that requires acknowledgment
    function showConfirmationDialog(message, type = 'warning') {
      return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(4px);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.2s ease-out;
        `;

        // Create dialog
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
          border: 1px solid rgba(139, 92, 246, 0.3);
          border-radius: 16px;
          padding: 2rem;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(20px);
        `;

        // Warning icon and message
        dialog.innerHTML = `
          <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="font-size: 2rem; flex-shrink: 0;">⚠️</div>
            <div>
              <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary); font-size: 1.25rem;">Important Notice</h3>
              <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">${message}</p>
            </div>
          </div>
          <button id="confirm-dialog-btn" style="
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.8), rgba(59, 130, 246, 0.8));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
            I Understand
          </button>
        `;

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Handle confirmation
        const confirmBtn = dialog.querySelector('#confirm-dialog-btn');
        confirmBtn.addEventListener('click', () => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(true);
          }, 200);
        });
      });
    }



    // Fetch credits on page load
    setTimeout(() => {
      fetchUserCredits();
    }, 500);

        const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
        let selectedMediaType = document.querySelector('.media-type-btn.active').dataset.type;

// ...rest of your code, using mediaTypeBtns...


    // Chat functionality
    const chatMessages = document.querySelector('.chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionChips = document.querySelectorAll('.suggestion-chip');

    // Music generation - Elements
    const modeToggleBtns = document.querySelectorAll('.mode-toggle-btn');
    let isCustomMode = false; // Simple is default
    const simpleModeFields = document.getElementById('simple-mode-fields');
    const customModeFields = document.getElementById('custom-mode-fields');
    const musicPromptSimple = document.getElementById('music-prompt-simple');
    const musicTitle = document.getElementById('music-title');
    const musicStyle = document.getElementById('music-style');
    const musicLyrics = document.getElementById('music-lyrics');
    const musicModelHeader = document.getElementById('music-model-header');
    const musicInstrumental = document.getElementById('music-instrumental');
    const generateMusicBtn = document.getElementById('generate-music-btn');
    const musicResult = document.getElementById('music-result');
    const simpleCharCount = document.getElementById('simple-char-count');
    const customCharCount = document.getElementById('custom-char-count');



        // Place this near other helper functions or at top, after DOM ready
        async function handleImageInput(fileInput, urlInput) {
        const file = fileInput.files[0];
        if (file) {
    return new Promise((resolve, reject) => {
     const reader = new FileReader();
     reader.onload = e => resolve(e.target.result);
     reader.onerror = e => reject(e);
     reader.readAsDataURL(file);
    });
  }
  // If no file, but URL provided
  if (urlInput.value && urlInput.value.trim() !== '') {
    return urlInput.value.trim();
  }
  return null;
}

    // Mode Toggle Buttons
    const advancedOptions = document.getElementById('advanced-options');
    
    if (modeToggleBtns.length > 0 && simpleModeFields && customModeFields) {
      modeToggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // Remove active from all buttons
          modeToggleBtns.forEach(b => b.classList.remove('active'));
          // Add active to clicked button
          this.classList.add('active');
          
          // Update mode based on button clicked
          const mode = this.dataset.mode;
          isCustomMode = (mode === 'custom');
          
          // Toggle fields visibility
          if (isCustomMode) {
            simpleModeFields.style.display = 'none';
            customModeFields.style.display = 'block';
            if (advancedOptions) advancedOptions.style.display = 'block';
          } else {
            simpleModeFields.style.display = 'block';
            customModeFields.style.display = 'none';
            if (advancedOptions) advancedOptions.style.display = 'none';
          }
        });
      });
    }
    
    // Set initial visibility (Simple mode by default)
    if (simpleModeFields && customModeFields) {
      simpleModeFields.style.display = 'block';
      customModeFields.style.display = 'none';
      if (advancedOptions) advancedOptions.style.display = 'none';
    }

// Gender Toggle Button Logic
const genderToggleBtns = document.querySelectorAll('.gender-toggle-btn');
const vocalGenderValue = document.getElementById('vocal-gender-value');

if (genderToggleBtns.length > 0 && vocalGenderValue) {
  genderToggleBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active from all buttons
      genderToggleBtns.forEach(b => b.classList.remove('active'));
      // Add active to clicked button
      this.classList.add('active');
      // Update hidden input value
      vocalGenderValue.value = this.dataset.gender;
    });
  });
}

// Slider live value update logic (with percentage display)
['style-weight', 'weirdness-constraint', 'audio-weight'].forEach(function(id) {
  const slider = document.getElementById(id);
  const output = document.getElementById(id + '-value');
  if (slider && output) {
    slider.addEventListener('input', function() {
      const percentage = Math.round(slider.value * 100);
      output.textContent = percentage + '%';
    });
  }
});

// Function to update required field indicators (red asterisks)
function updateRequiredFields() {
  const uploadUrl = document.getElementById('upload-url').value.trim();
  // Use the global isCustomMode variable instead of checkbox
  const isInstrumental = musicInstrumental.checked;
  
  // Get label elements
  const simpleLabelEl = document.getElementById('simple-prompt-label');
  const titleLabelEl = document.getElementById('custom-title-label');
  const styleLabelEl = document.getElementById('custom-style-label');
  const lyricsLabelEl = document.getElementById('custom-lyrics-label');
  
  // Reset all labels to base text
  simpleLabelEl.innerHTML = 'Song Description <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span>';
  titleLabelEl.textContent = 'Title';
  styleLabelEl.textContent = 'Style of Music';
  lyricsLabelEl.innerHTML = 'Lyrics <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span>';
  
  // Apply red asterisk to required fields
  const asterisk = '<span style="color: #ff2ea6; margin-left: 0.25rem;">*</span>';
  
  if (!isCustomMode) {
    // Non-custom mode: prompt is always required
    simpleLabelEl.innerHTML = 'Song Description' + asterisk + ' <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span>';
  } else {
    // Custom mode
    // Title and Style are always required in custom mode
    titleLabelEl.innerHTML = 'Title' + asterisk;
    styleLabelEl.innerHTML = 'Style of Music' + asterisk;
    
    // Lyrics only required if NOT instrumental
    if (!isInstrumental) {
      lyricsLabelEl.innerHTML = 'Lyrics' + asterisk + ' <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span>';
    }
  }
  
  // Update character counters after HTML changes
  const simpleCount = musicPromptSimple.value.length;
  const customCount = musicLyrics.value.length;
  const simpleCharCountEl = document.getElementById('simple-char-count');
  const customCharCountEl = document.getElementById('custom-char-count');
  if (simpleCharCountEl) simpleCharCountEl.textContent = `(${simpleCount}/199)`;
  if (customCharCountEl) customCharCountEl.textContent = `(${customCount}/3000)`;
}

// Update required fields on mode/instrumental changes
if (modeToggleBtns.length > 0) {
  modeToggleBtns.forEach(btn => {
    btn.addEventListener('click', updateRequiredFields);
  });
}
if (musicInstrumental) {
  musicInstrumental.addEventListener('change', updateRequiredFields);
}

// Update on file upload/clear
const uploadUrlHidden = document.getElementById('upload-url');
if (uploadUrlHidden) {
  const observer = new MutationObserver(updateRequiredFields);
  observer.observe(uploadUrlHidden, { attributes: true, attributeFilter: ['value'] });
}

// Initial update
updateRequiredFields();

// ===== PREMIUM PLAYER CONTROLLER =====
window.premiumPlayer = {
  currentTrack: null,
  audioElements: new Map(),
  downloadData: {},
  selectedFormat: 'mp3',

  init() {
    // Get all audio elements and set up event listeners
    const audioElements = document.querySelectorAll('audio[data-track-id]');
    
    audioElements.forEach(audio => {
      const trackId = audio.getAttribute('data-track-id');
      this.audioElements.set(trackId, audio);
      
      // Set up event listeners for this audio element
      audio.addEventListener('loadedmetadata', () => this.onMetadataLoaded(trackId));
      audio.addEventListener('timeupdate', () => this.onTimeUpdate(trackId));
      audio.addEventListener('ended', () => this.onTrackEnded(trackId));
    });
  },

  onMetadataLoaded(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const duration = audio.duration;
    const durationBadge = card.querySelector('.track-duration-badge');
    const totalTime = card.querySelector('.total-time');
    
    const formattedDuration = this.formatTime(duration);
    if (durationBadge) durationBadge.textContent = formattedDuration;
    if (totalTime) totalTime.textContent = formattedDuration;
  },

  onTimeUpdate(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const progress = (audio.currentTime / audio.duration) * 100;
    const progressFill = card.querySelector('.track-progress-fill');
    const currentTimeEl = card.querySelector('.current-time');
    
    if (progressFill) progressFill.style.width = `${progress}%`;
    if (currentTimeEl) currentTimeEl.textContent = this.formatTime(audio.currentTime);
  },

  onTrackEnded(trackId) {
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const playIcon = card.querySelector('.play-icon');
    const pauseIcon = card.querySelector('.pause-icon');
    
    if (playIcon) playIcon.style.display = 'block';
    if (pauseIcon) pauseIcon.style.display = 'none';
  },

  togglePlay(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const playIcon = card.querySelector('.play-icon');
    const pauseIcon = card.querySelector('.pause-icon');
    
    // Pause all other tracks
    this.audioElements.forEach((otherAudio, otherId) => {
      if (otherId !== trackId && !otherAudio.paused) {
        otherAudio.pause();
        const otherCard = document.querySelector(`[data-track-id="${otherId}"]`);
        if (otherCard) {
          const otherPlayIcon = otherCard.querySelector('.play-icon');
          const otherPauseIcon = otherCard.querySelector('.pause-icon');
          if (otherPlayIcon) otherPlayIcon.style.display = 'block';
          if (otherPauseIcon) otherPauseIcon.style.display = 'none';
        }
      }
    });
    
    if (audio.paused) {
      audio.play();
      if (playIcon) playIcon.style.display = 'none';
      if (pauseIcon) pauseIcon.style.display = 'block';
      this.currentTrack = trackId;
    } else {
      audio.pause();
      if (playIcon) playIcon.style.display = 'block';
      if (pauseIcon) pauseIcon.style.display = 'none';
    }
  },

  seek(trackId, event) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const percentage = x / rect.width;
    
    audio.currentTime = percentage * audio.duration;
  },

  previous(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    // If more than 3 seconds in, restart current track
    if (audio.currentTime > 3) {
      audio.currentTime = 0;
    } else {
      // Go to previous track
      const trackIds = Array.from(this.audioElements.keys());
      const currentIndex = trackIds.indexOf(trackId);
      if (currentIndex > 0) {
        this.togglePlay(trackIds[currentIndex - 1]);
      }
    }
  },

  next(trackId) {
    const trackIds = Array.from(this.audioElements.keys());
    const currentIndex = trackIds.indexOf(trackId);
    if (currentIndex < trackIds.length - 1) {
      this.togglePlay(trackIds[currentIndex + 1]);
    }
  },

  formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  },

  openDownloadModal(trackId, title, url) {
    this.downloadData = { trackId, title, url };
    this.selectedFormat = 'mp3';
    
    const modal = document.getElementById('download-modal');
    const modalTitle = document.getElementById('modal-track-title');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modal) modal.style.display = 'flex';
    
    // Reset download button text
    const downloadBtn = document.querySelector('[data-testid="button-modal-download"]');
    if (downloadBtn) downloadBtn.textContent = 'Download';
    
    // Reset selection UI
    document.querySelectorAll('.download-option').forEach(opt => {
      opt.style.background = 'rgba(139, 92, 246, 0.08)';
      opt.style.borderColor = 'var(--border-color)';
    });
    
    // Highlight MP3 by default
    const mp3Option = document.querySelector('[data-testid="option-mp3"]');
    if (mp3Option) {
      mp3Option.style.background = 'rgba(139, 92, 246, 0.15)';
      mp3Option.style.borderColor = 'var(--aetherwave-purple)';
    }
    
    // Add Pro badge to WAV option for free users
    const wavOption = document.querySelector('[data-testid="option-wav"]');
    if (wavOption && userPlanType === 'free') {
      // Add visual "locked" state
      wavOption.style.opacity = '0.6';
      wavOption.style.cursor = 'not-allowed';
      
      // Add Pro badge if not already present
      const wavTitle = wavOption.querySelector('.download-option-title');
      if (wavTitle && !wavTitle.querySelector('.pro-badge')) {
        const badge = document.createElement('span');
        badge.className = 'pro-badge';
        badge.textContent = 'PRO';
        badge.style.cssText = 'margin-left: 0.5rem; padding: 0.125rem 0.5rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; font-size: 0.65rem; font-weight: 700; border-radius: 4px; vertical-align: middle;';
        wavTitle.appendChild(badge);
      }
    } else if (wavOption && userPlanType !== 'free') {
      // Remove locked state for paid users
      wavOption.style.opacity = '1';
      wavOption.style.cursor = 'pointer';
      const badge = wavOption.querySelector('.pro-badge');
      if (badge) badge.remove();
    }
  },

  closeDownloadModal() {
    const modal = document.getElementById('download-modal');
    if (modal) modal.style.display = 'none';
  },

  selectFormat(format) {
    // Check if user is trying to select WAV on free plan
    if (format === 'wav' && userPlanType === 'free') {
      // Show upgrade notification
      const wavOption = document.querySelector('[data-testid="option-wav"]');
      if (wavOption) {
        // Visual feedback - shake animation
        wavOption.style.animation = 'shake 0.5s';
        setTimeout(() => {
          wavOption.style.animation = '';
        }, 500);
      }
      
      // Show upgrade tooltip
      showNotification('WAV downloads require Studio plan or higher. Upgrade to unlock lossless audio!', 'error');
      return; // Don't select WAV
    }
    
    this.selectedFormat = format;
    
    // Update UI to show selection
    document.querySelectorAll('.download-option').forEach(opt => {
      opt.style.background = 'rgba(139, 92, 246, 0.08)';
      opt.style.borderColor = 'var(--border-color)';
    });
    
    const selectedOption = document.querySelector(`[data-testid="option-${format}"]`);
    if (selectedOption) {
      selectedOption.style.background = 'rgba(139, 92, 246, 0.15)';
      selectedOption.style.borderColor = 'var(--aetherwave-purple)';
    }
  },

  async confirmDownload() {
    const { title, url } = this.downloadData;
    const filename = `${title}.${this.selectedFormat}`;
    
    const downloadBtn = document.querySelector('[data-testid="button-modal-download"]');
    
    try {
      // Show loading state on download button
      if (downloadBtn) downloadBtn.textContent = 'Downloading...';
      
      // Fetch the file as a blob to work around CORS restrictions
      const response = await fetch(url);
      if (!response.ok) throw new Error('Download failed');
      
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      
      // Create download link with blob URL
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(blobUrl);
      }, 100);
      
      // Reset button text before closing
      if (downloadBtn) downloadBtn.textContent = 'Download';
      
      this.closeDownloadModal();
    } catch (error) {
      console.error('Download error:', error);
      
      // Reset button text on error
      if (downloadBtn) downloadBtn.textContent = 'Download';
      
      alert('Download failed. Please try again or right-click and "Save As".');
      this.closeDownloadModal();
    }
  }
};


    // Character counter for Simple Mode
    if (musicPromptSimple && simpleCharCount) {
      musicPromptSimple.addEventListener('input', () => {
        const charCount = musicPromptSimple.value.length;
        simpleCharCount.textContent = `(${charCount}/199)`;
      });
    }

    // Character counter for Custom Mode Lyrics
    if (musicLyrics && customCharCount) {
      musicLyrics.addEventListener('input', () => {
        const charCount = musicLyrics.value.length;
        customCharCount.textContent = `(${charCount}/3000)`;
      });
    }

    // NEW Visual Generation System - Use Case Based
    //const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
    const useCaseCards = document.querySelectorAll('.use-case-card');
    const generationSettings = document.getElementById('generation-settings');
    const enhancedPrompt = document.getElementById('enhanced-prompt');
    const userVision = document.getElementById('user-vision');
    const mediaImageUpload = document.getElementById('media-image-upload');
    const mediaImagePreview = document.getElementById('media-image-preview');
    const mediaPreviewImg = document.getElementById('media-preview-img');
    const mediaClearImage = document.getElementById('media-clear-image');
    const imageModeSelection = document.getElementById('image-mode-selection');
    const imageMode = document.getElementById('image-mode');
    const mediaVideoModel = document.getElementById('media-video-model');
    const mediaResolution = document.getElementById('media-resolution');
    const mediaDuration = document.getElementById('media-duration');
    const mediaSafetyChecker = document.getElementById('media-safety-checker');
    const generateMediaBtn = document.getElementById('generate-media-btn');
    const generateArtBtn = document.getElementById('generate-art-btn');
    const mediaTypeLabel = document.getElementById('media-type-label');
    const backToUseCases = document.getElementById('back-to-use-cases');
    const mediaResult = document.getElementById('media-result');
    const videoSettingsGroup = document.getElementById('video-settings-group');
    const videoResolutionGroup = document.getElementById('video-resolution-group');
    const videoDurationGroup = document.getElementById('video-duration-group');
    const imageStyleGroup = document.getElementById('image-style-group');
    const mediaImageStyle = document.getElementById('media-image-style');
    
    // OLD video generation elements (for compatibility)
    const generateVideoBtn = document.getElementById('generate-video-btn');
    const videoPrompt = document.getElementById('video-prompt');
    const videoModel = document.getElementById('video-model');
    const videoResolution = document.getElementById('video-resolution');
    const videoDuration = document.getElementById('video-duration');
    const videoCameraFixed = document.getElementById('video-camera-fixed');
    const videoSafetyChecker = document.getElementById('video-safety-checker');
    const artResult = document.getElementById('art-result');

    // State management'
    let selectedUseCase = null;
    let uploadedImageData = null;
    
    // Initialize button class and label based on default media type
    if (generateMediaBtn && mediaTypeLabel) {
        mediaTypeLabel.textContent = selectedMediaType === 'image' ? 'Image' : 'Video';
        generateMediaBtn.className = selectedMediaType === 'video' ? 'btn-video-generate' : 'btn-primary';
        if (selectedMediaType === 'image') {
            generateMediaBtn.style.padding = '1rem';
            generateMediaBtn.style.fontSize = '1.1rem';
            generateMediaBtn.style.fontWeight = '600';
        }
    }





    // Prompt templates for each use case
    const promptTemplates = {
    'band-profile': {
    image: 'Professional artist portrait photography: {vision}. Studio lighting, high quality, detailed, press kit worthy, promotional photo style.',
    video: 'Cinematic portrait footage: {vision}. Professional lighting, slow camera movement, artist posing confidently, high production value.'
    },
    'live-photos': {
    image: 'Live concert photography: {vision}. Dynamic stage lighting, energetic performance, crowd atmosphere, professional music photography.',
    video: 'Live performance footage: {vision}. Concert stage with dramatic lighting, energetic movement, crowd energy, professional concert videography.'
    },
    'live-video': {
    image: 'Concert performance shot: {vision}. Stage lights, live music energy, performance intensity, concert photography.',
    video: 'Live concert performance: {vision}. Dynamic camera angles, stage lighting effects, musician performing live, concert film quality.'
    },
    'production-video': {
    image: 'Cinematic music video still: {vision}. Professional cinematography, artistic composition, music video aesthetic, high production value.',
    video: 'Professional music video production: {vision}. Cinematic camera work, artistic storytelling, high-quality cinematography, music video style.'
    },
    'backstage': {
    image: 'Behind-the-scenes music photography: {vision}. Candid backstage moments, authentic artist life, documentary photography style.',
    video: 'Backstage documentary footage: {vision}. Behind-the-scenes access, authentic moments, candid artist interactions, documentary style.'
    },
    'on-the-road': {
    image: 'Tour life photography: {vision}. Travel documentary style, authentic road moments, touring musician lifestyle, candid shots.',
    video: 'Tour documentary footage: {vision}. Travel scenes, road life, touring musician journey, documentary cinematography.'
    },
    'album-art': {
    image: 'Album cover art design: {vision}. Square format, artistic composition, professional album artwork, high-quality graphic design.',
    video: 'Animated album artwork: {vision}. Square format, artistic motion graphics, professional album art animation, looping visual.'
    },
    'news-reports': {
    image: 'Music news press image: {vision}. Professional news photography, press release quality, announcement graphic style.',
    video: 'Music news announcement video: {vision}. News report style, professional presentation, press announcement format.'
    }
    };

    
        // When Generate Album Art button is clicked, show the dropdown.
        document.addEventListener('click', function(e) {
        if (e.target && e.target.matches('.download-btn[onclick*="Generate Album Art"]')) {
    document.getElementById('album-art-style-container').style.display = 'block';
    document.getElementById('album-art-style').value = 'photorealistic';
                }
        });

        // Media type toggle
    if (mediaTypeBtns.length > 0) {
      mediaTypeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
    mediaTypeBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedMediaType = btn.dataset.type;
    mediaTypeLabel.textContent = selectedMediaType === 'image' ? 'Image' : 'Video';
        
    // Update button class based on media type
    generateMediaBtn.className = selectedMediaType === 'video' ? 'btn-video-generate' : 'btn-primary';
    if (selectedMediaType === 'image') {
      generateMediaBtn.style.padding = '1rem';
      generateMediaBtn.style.fontSize = '1.1rem';
      generateMediaBtn.style.fontWeight = '600';
    }

    // Show/hide video-specific settings and image-specific settings
    const videoModelGroup = document.getElementById('video-model-group');
    const videoResolutionGroup = document.getElementById('video-resolution-group');
    const videoAspectRatioGroup = document.getElementById('video-aspect-ratio-group');
    const videoDurationGroup = document.getElementById('video-duration-group');
    const imageStyleGroup = document.getElementById('image-style-group');

    if (selectedMediaType === 'video') {
    // Show video model selector FIRST
    if (videoModelGroup) videoModelGroup.style.display = 'block';
    // Hide resolution/aspect/duration until model is selected (handled by model change event)
    if (imageStyleGroup) imageStyleGroup.style.display = 'none';

    // Trigger model change to show appropriate fields
    const videoModelSelect = document.getElementById('media-video-model');
    if (videoModelSelect) {
      videoModelSelect.dispatchEvent(new Event('change'));
    }
    } else {
    // Image mode: hide all video fields, show image style
    if (videoModelGroup) videoModelGroup.style.display = 'none';
    if (videoResolutionGroup) videoResolutionGroup.style.display = 'none';
    if (videoAspectRatioGroup) videoAspectRatioGroup.style.display = 'none';
    if (videoDurationGroup) videoDurationGroup.style.display = 'none';
    if (imageStyleGroup) imageStyleGroup.style.display = 'block';
    }
        // Call updateMediaInputs whenever media type is toggled
        mediaTypeBtns.forEach(btn => {
        btn.addEventListener('click', updateMediaInputs);
        });
    // Update enhanced prompt if use case already selected
    if (selectedUseCase) {
    updateEnhancedPrompt();
    }
        });
      });
    }

    // Use case selection
    if (useCaseCards.length > 0) {
      useCaseCards.forEach(card => {
        card.addEventListener('click', () => {
    useCaseCards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedUseCase = card.dataset.useCase;



    // Show generation settings
    generationSettings.style.display = 'block';

    // Update enhanced prompt
    updateEnhancedPrompt();

    // Scroll to settings
    setTimeout(() => {
    generationSettings.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
        });
      });
    }

    // Update enhanced prompt based on use case and user vision
    function updateEnhancedPrompt() {
    if (!selectedUseCase) return;

    const template = promptTemplates[selectedUseCase][selectedMediaType];
    const vision = userVision.value.trim() || 'artist/band';
    const finalPrompt = template.replace('{vision}', vision);

    enhancedPrompt.value = finalPrompt;
    }

    // User vision input updates prompt
    if (userVision) {
      userVision.addEventListener('input', updateEnhancedPrompt);
    }

    // Back button
    if (backToUseCases) {
      backToUseCases.addEventListener('click', () => {
        if (generationSettings) generationSettings.style.display = 'none';
        useCaseCards.forEach(c => c.classList.remove('selected'));
        selectedUseCase = null;
        if (enhancedPrompt) enhancedPrompt.value = '';
        if (userVision) userVision.value = '';
        if (mediaResult) mediaResult.style.display = 'none';
      });
    }

    // Handle image upload for media generator
    if (mediaImageUpload) {
      mediaImageUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
    alert('Invalid image format. Please use JPG, PNG, WEBP, or GIF.');
    mediaImageUpload.value = '';
    return;
    }

    // Check file size (max 5MB for better compatibility)
    if (file.size > 5 * 1024 * 1024) {
    alert('Image file is too large. Please use an image under 5MB.');
    mediaImageUpload.value = '';
    return;
    }

    // Read file as base64 and validate dimensions
    const reader = new FileReader();
    reader.onload = (event) => {
    const img = new Image();
    img.onload = () => {
    // Check dimensions (recommend 720p or less for best results)
    const maxDimension = 1920;
    if (img.width > maxDimension || img.height > maxDimension) {
    if (!confirm(`Image is ${img.width}x${img.height}. Large images may fail. Continue anyway?`)) {
    mediaImageUpload.value = '';
    return;
    }
    }

    // Check aspect ratio (warn if unusual)
    const aspectRatio = img.width / img.height;
    if (aspectRatio < 0.5 || aspectRatio > 2) {
    if (!confirm(`Unusual aspect ratio (${img.width}x${img.height}). May not work well. Continue?`)) {
    mediaImageUpload.value = '';
    return;
    }
    }

    uploadedImageData = event.target.result;
    mediaPreviewImg.src = uploadedImageData;
    mediaImagePreview.style.display = 'block';

    // Show second image uploader for Seedance and VEO 3.1 Fast (same workflow)
    if (selectedMediaType === 'video') {
      const currentModel = mediaVideoModel?.value || 'seedance-lite';
      const isSeedance = currentModel.startsWith('seedance');
      const isVeo3Fast = currentModel === 'veo3_fast';

      // Hide image mode dropdown - auto-determined by uploaded images
      imageModeSelection.style.display = 'none';

      // Show second uploader (last frame) for Seedance LITE and VEO 3.1 Fast only
      // Seedance Pro only supports reference mode (no first/last frame)
      const isSeedanceLite = currentModel === 'seedance-lite';
      const lastFrameUploadGroup = document.getElementById('last-frame-upload-group');
      if ((isSeedanceLite || isVeo3Fast) && uploadedImageData) {
        if (lastFrameUploadGroup) lastFrameUploadGroup.style.display = 'block';
      } else {
        if (lastFrameUploadGroup) lastFrameUploadGroup.style.display = 'none';
      }
    }
    };
    img.src = event.target.result;
    };
    reader.onerror = () => {
    alert('Failed to read image file. Please try again.');
    };
    reader.readAsDataURL(file);
      });
    }

    // Clear uploaded image
    if (mediaClearImage) {
      mediaClearImage.addEventListener('click', () => {
        uploadedImageData = null;
        if (mediaImageUpload) mediaImageUpload.value = '';
        if (mediaImagePreview) mediaImagePreview.style.display = 'none';
        if (mediaPreviewImg) mediaPreviewImg.src = '';
        if (imageModeSelection) imageModeSelection.style.display = 'none';

        // Hide and clear second uploader (last frame)
        const lastFrameUploadGroup = document.getElementById('last-frame-upload-group');
        if (lastFrameUploadGroup) lastFrameUploadGroup.style.display = 'none';
        const lastFrameUpload = document.getElementById('media-last-frame-upload');
        if (lastFrameUpload) lastFrameUpload.value = '';
        const lastFramePreview = document.getElementById('media-last-frame-preview');
        if (lastFramePreview) lastFramePreview.style.display = 'none';

        // Reset first image label to default
        const imageLabelHint = document.getElementById('image-label-hint');
        if (imageLabelHint) {
          imageLabelHint.textContent = '- First frame or reference';
        }
      });
    }

    // Handle last frame image upload for VEO 3.1 Fast
    let uploadedLastFrameData = null;
    const lastFrameUpload = document.getElementById('media-last-frame-upload');
    const lastFramePreview = document.getElementById('media-last-frame-preview');
    const lastFramePreviewImg = document.getElementById('media-last-frame-preview-img');
    const clearLastFrameBtn = document.getElementById('media-clear-last-frame');

    if (lastFrameUpload) {
      lastFrameUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
        if (!validTypes.includes(file.type)) {
          alert('Invalid image format. Please use JPG, PNG, WEBP, or GIF.');
          lastFrameUpload.value = '';
          return;
        }

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image file is too large. Please use an image under 5MB.');
          lastFrameUpload.value = '';
          return;
        }

        // Read and preview the last frame image
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            uploadedLastFrameData = event.target.result;
            lastFramePreviewImg.src = uploadedLastFrameData;
            lastFramePreview.style.display = 'block';

            // Change first image uploader label to "First frame"
            const imageLabelHint = document.getElementById('image-label-hint');
            if (imageLabelHint) {
              imageLabelHint.textContent = '- First frame';
            }
          };
          img.src = event.target.result;
        };
        reader.onerror = () => {
          alert('Failed to read image file. Please try again.');
        };
        reader.readAsDataURL(file);
      });
    }

    // Clear last frame image
    if (clearLastFrameBtn) {
      clearLastFrameBtn.addEventListener('click', () => {
        uploadedLastFrameData = null;
        if (lastFrameUpload) lastFrameUpload.value = '';
        if (lastFramePreview) lastFramePreview.style.display = 'none';
        if (lastFramePreviewImg) lastFramePreviewImg.src = '';

        // Change first image uploader label back to default
        const imageLabelHint = document.getElementById('image-label-hint');
        if (imageLabelHint) {
          imageLabelHint.textContent = '- First frame or reference';
        }
      });
    }

    // Handle model change to show/hide last frame uploader and filter aspect ratios
    if (mediaVideoModel) {
      mediaVideoModel.addEventListener('change', () => {
        const currentModel = mediaVideoModel.value;
        const isVeo3Fast = currentModel === 'veo3_fast';
        const isSeedanceLite = currentModel === 'seedance-lite';
        const isSeedanceProFast = currentModel === 'seedance-pro-fast';
        const isSeedancePro = currentModel === 'seedance-pro';
        const lastFrameUploadGroup = document.getElementById('last-frame-upload-group');
        const imageLabelHint = document.getElementById('image-label-hint');
        const aspectRatioSelect = document.getElementById('media-aspect-ratio');

        // Show last frame uploader for VEO 3.1 Fast, Seedance LITE, and Seedance PRO FAST (Pro doesn't support it)
        if ((isVeo3Fast || isSeedanceLite || isSeedanceProFast) && uploadedImageData && selectedMediaType === 'video') {
          if (lastFrameUploadGroup) lastFrameUploadGroup.style.display = 'block';
        } else {
          if (lastFrameUploadGroup) lastFrameUploadGroup.style.display = 'none';
          // Update label based on model
          if (imageLabelHint) {
            if (isSeedancePro) {
              imageLabelHint.textContent = '- Reference only';
            } else if (isSeedanceProFast) {
              imageLabelHint.textContent = '- First frame';
            } else {
              imageLabelHint.textContent = '- First frame or reference';
            }
          }
        }

        // Filter aspect ratio options for VEO 3.1 Fast (only 16:9, 9:16, auto)
        if (aspectRatioSelect) {
          const options = aspectRatioSelect.querySelectorAll('option');
          const currentValue = aspectRatioSelect.value;

          options.forEach(option => {
            if (isVeo3Fast && option.hasAttribute('data-exclude-veo3')) {
              option.style.display = 'none';
              option.disabled = true;
            } else {
              option.style.display = '';
              option.disabled = false;
            }
          });

          // If current selection is not allowed for VEO 3 Fast, reset to 16:9
          if (isVeo3Fast && aspectRatioSelect.querySelector(`option[value="${currentValue}"]`)?.hasAttribute('data-exclude-veo3')) {
            aspectRatioSelect.value = '16:9';
          }
        }
      });
    }

    // Handle audio file upload for music cover
    const uploadFileInput = document.getElementById('upload-file');
    const uploadFileBtn = document.getElementById('upload-file-btn');
    const uploadFileName = document.getElementById('upload-file-name');
    const clearUploadBtn = document.getElementById('clear-upload-btn');

    if (uploadFileBtn && uploadFileInput) {
      uploadFileBtn.addEventListener('click', () => {
        uploadFileInput.click();
      });
    }

    if (uploadFileInput) {
      uploadFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file type
    const validTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac', 'audio/x-m4a'];
    const validExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
    const hasValidType = validTypes.includes(file.type) || validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
    
    if (!hasValidType) {
      alert('Invalid audio format. Please use MP3, WAV, M4A, OGG, or FLAC.');
      uploadFileInput.value = '';
      return;
    }

    // Check file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Audio file is too large. Please use a file under 10MB.');
      uploadFileInput.value = '';
      return;
    }

    // Show uploading status
    uploadFileBtn.disabled = true;
    uploadFileBtn.textContent = 'Uploading...';
    uploadFileName.textContent = 'Uploading file...';

    try {
      // Upload file to server
      const formData = new FormData();
      formData.append('audio', file);

      const response = await fetch('/api/upload-audio', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.details || 'Failed to upload audio file');
      }

      const data = await response.json();
      
      // Store the URL in hidden field
      uploadUrlHidden.value = data.url;
      uploadFileName.textContent = file.name;
      clearUploadBtn.style.display = 'block';
      
    } catch (error) {
      console.error('Upload error:', error);
      alert('Failed to upload audio file: ' + error.message);
      uploadFileInput.value = '';
      uploadUrlHidden.value = '';
      uploadFileName.textContent = 'No file selected';
    } finally {
      uploadFileBtn.disabled = false;
      uploadFileBtn.textContent = 'Choose Audio File';
    }
      });
    }

    if (clearUploadBtn) {
      clearUploadBtn.addEventListener('click', () => {
        if (uploadFileInput) uploadFileInput.value = '';
        if (uploadUrlHidden) uploadUrlHidden.value = '';
        if (uploadFileName) uploadFileName.textContent = 'No file selected';
        clearUploadBtn.style.display = 'none';
      });
    }

    // Helper function to download images (bypasses CORS and preview issues)
    window.downloadFile = async function(url, filename) {
    try {
    console.log('Downloading file:', url);
    
    // Use backend proxy to download external images (bypasses CORS)
    const proxyUrl = `/api/download-image?url=${encodeURIComponent(url)}&filename=${encodeURIComponent(filename)}`;
    
    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = proxyUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Download initiated for:', filename);
    } catch (error) {
    console.error('Download failed:', error);
    alert('Download failed. Please try again or right-click and select "Save Image As..."');
    }
    }

    // Helper function to download videos (prevents opening in same window)
    window.downloadVideo = async function(url, filename) {
    try {
    console.log('Downloading video:', url);
    
    // Fetch the video as a blob
    const response = await fetch(url);
    if (!response.ok) throw new Error('Download failed');
    
    const blob = await response.blob();
    const blobUrl = window.URL.createObjectURL(blob);
    
    // Create download link with blob URL
    const link = document.createElement('a');
    link.href = blobUrl;
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    
    // Cleanup
    setTimeout(() => {
      document.body.removeChild(link);
      window.URL.revokeObjectURL(blobUrl);
    }, 100);
    
    console.log('Video download initiated for:', filename);
    } catch (error) {
    console.error('Video download failed:', error);
    alert('Download failed. Please try again or right-click the video and select "Save Video As..."');
    }
    }

    // Add message to chat
    function addMessage(content, type = 'user') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    messageDiv.innerHTML = `
    <div class="message-label">${type === 'user' ? 'You' : 'AetherWave AI'}</div>
    <div class="message-content">${content}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Send message to API
    async function sendMessage(message) {
    if (!message.trim()) return;

    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
    const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({
    message: message,
    provider: 'openai'
    })
    });

    if (!response.ok) {
    throw new Error('Failed to get response');
    }

    const data = await response.json();
    addMessage(data.message, 'assistant');

    } catch (error) {
    console.error('Chat error:', error);
    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
    } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    }
    }

    // Generate music
    async function generateMusic() {
    // Use the global isCustomMode variable instead of checkbox
    const model = musicModelHeader.value;
    const instrumental = musicInstrumental.checked;
    const vocalGender = document.getElementById('vocal-gender-value')?.value || 'm';
    const uploadUrl = document.getElementById('upload-url').value.trim();

    console.log('=== Generate Music Called ===');
    console.log('Custom Mode:', isCustomMode);
    console.log('Model:', model);
    console.log('Instrumental:', instrumental);
    console.log('Vocal Gender:', vocalGender);
    console.log('Upload URL:', uploadUrl);

    let requestBody = {
    model: model,
    instrumental: instrumental
    };

    // Add advanced options if available (optional parameters)
    const styleWeight = parseFloat(document.getElementById('style-weight')?.value);
    const weirdnessConstraint = parseFloat(document.getElementById('weirdness-constraint')?.value);
    const audioWeight = parseFloat(document.getElementById('audio-weight')?.value);
    
    if (!isNaN(styleWeight)) requestBody.styleWeight = styleWeight;
    if (!isNaN(weirdnessConstraint)) requestBody.weirdnessConstraint = weirdnessConstraint;
    if (!isNaN(audioWeight)) requestBody.audioWeight = audioWeight;

    if (isCustomMode) {
    // Custom Mode - validation depends on instrumental setting
    const title = musicTitle.value.trim();
    const style = musicStyle.value.trim();
    const lyrics = musicLyrics.value.trim();

    console.log('Custom Mode - Title:', title);
    console.log('Custom Mode - Style:', style);
    console.log('Custom Mode - Lyrics length:', lyrics.length);

    // Title and Style are always required in custom mode
    if (!title || !style) {
    alert('Please provide both Title and Style of Music for Custom Mode');
    return;
    }

    // Lyrics are optional in custom mode (even for non-instrumental tracks)
    // SUNO will generate lyrics automatically if not provided

    requestBody.customMode = true;
    requestBody.title = title;
    requestBody.style = style;
    requestBody.prompt = lyrics || ''; // Lyrics are optional, empty string if not provided
    
    // vocalGender is only effective when customMode is true
    requestBody.vocalGender = vocalGender;
    } else {
    // Non-custom Mode - prompt is always required
    const prompt = musicPromptSimple.value.trim();

    console.log('Non-custom Mode - Prompt:', prompt);

    if (!prompt) {
    alert('Please provide a Song Description');
    return;
    }

    requestBody.customMode = false;
    requestBody.prompt = prompt;
    
    // Note: vocalGender is NOT sent when customMode is false (per API docs)
    }

    // Determine endpoint based on uploadUrl
    let endpoint = '/api/generate-music';
    let actionText = 'Generating Your Music';
    
    if (uploadUrl) {
    endpoint = '/api/upload-cover-music';
    actionText = 'Covering Your Audio';
    requestBody.uploadUrl = uploadUrl;
    }

    generateMusicBtn.style.pointerEvents = 'none';
    generateMusicBtn.style.opacity = '0.5';
    musicResult.style.display = 'none';

    try {

    console.log(`Sending request to ${endpoint}:`, requestBody);

    const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    console.log('Response status:', response.status, response.statusText);

    const data = await response.json();
    console.log('Response data:', data);

    if (!response.ok) {
    // Handle insufficient credits
    if (response.status === 403 && data.error === 'Insufficient credits') {
      showPaymentModal();
      throw new Error(data.message || 'Insufficient credits');
    }
    // Handle other errors
    const errorMsg = data.error || 'Failed to generate music';
    const errorDetails = data.details || '';
    throw new Error(`${errorMsg}${errorDetails ? ': ' + errorDetails : ''}`);
    }
    
    // Refresh credits after successful generation start
    fetchUserCredits();

    // KIE.ai returns a taskId - we need to poll for results
    const musicTaskId = data.taskId;
    
    if (!musicTaskId) {
    throw new Error('No task ID returned from API');
    }

    // Show processing status
    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title"><img src="/assets/icon-set/music-icon.png" style="width: 20px; height: 20px; margin-right: 0.5rem; vertical-align: middle;"> ${actionText}...</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">This usually takes 30-40 seconds for streaming quality.</p>
    <div style="margin-top: 1rem; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
      <div style="width: 30%; height: 100%; background: var(--aetherwave-purple); animation: pulse 1.5s ease-in-out infinite;"></div>
    </div>
    </div>
    `;
    musicResult.style.display = 'block';

    // Poll for results
    let attempts = 0;
    const maxAttempts = 180; // 6 minutes max (180 * 2 seconds) - AI music takes 2-4 minutes
    const pollInterval = setInterval(async () => {
      attempts++;
      
      try {
        const statusResponse = await fetch(`/api/music-status/${musicTaskId}`);
        const statusData = await statusResponse.json();
        
        console.log(`Poll attempt ${attempts}:`, statusData);
        
        // Update progress bar based on status
        const currentStatus = statusData.status || 'PENDING';
        let progressPercent = 20;
        let statusMessage = 'Starting generation...';
        
        if (currentStatus === 'TEXT_SUCCESS') {
          progressPercent = 60;
          statusMessage = 'Lyrics created! Generating audio...';
        } else if (currentStatus === 'FIRST_SUCCESS') {
          progressPercent = 85;
          statusMessage = 'First track ready! Finishing up...';
        } else if (currentStatus === 'SUCCESS') {
          progressPercent = 100;
          statusMessage = 'Complete!';
        } else {
          progressPercent = Math.min(20 + (attempts * 2), 50);
          statusMessage = `Processing... (${Math.floor(attempts * 2)}s)`;
        }
        
        musicResult.innerHTML = `
          <div class="result-box">
            <div class="result-title"><img src="/assets/icon-set/music-icon.png" style="width: 20px; height: 20px; margin-right: 0.5rem; vertical-align: middle;"> ${actionText}...</div>
            <p style="color: var(--aetherwave-pink); font-size: 0.9rem;">${statusMessage}</p>
            <p style="color: var(--text-muted); font-size: 0.8rem;">This usually takes 30-60 seconds</p>
            <div style="margin-top: 1rem; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
              <div style="width: ${progressPercent}%; height: 100%; background: var(--aetherwave-purple); transition: width 0.5s ease;"></div>
            </div>
          </div>
        `;
        
        if (statusData.status === 'SUCCESS' && statusData.tracks && statusData.tracks.length > 0) {
          clearInterval(pollInterval);
          
          // Display all tracks with premium player (usually 2 variations)
          const tracksHTML = statusData.tracks.map((track, index) => `
            <div class="premium-track-card" data-track-id="${track.id}">
              <div class="track-content">
                <div class="track-artwork">
                  <img src="${track.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Crect fill=\'%238b5cf6\' width=\'80\' height=\'80\'/%3E%3C/svg%3E'}" alt="${track.title || 'Track'}" data-testid="img-track-art-${index}">
                  <div class="track-duration-badge" data-testid="text-duration-${index}">--:--</div>
                </div>
                <div class="track-info">
                  <div class="track-title" data-testid="text-track-title-${index}">${track.title || `Track ${index + 1}`}</div>
                  <div class="track-artist" data-testid="text-track-artist-${index}">AetherWave Studio</div>
                </div>
                <div class="track-controls">
                  <button class="control-btn control-btn-small" onclick="window.premiumPlayer.previous('${track.id}')" title="Previous" data-testid="button-previous-${index}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <button class="control-btn play-pause-btn" onclick="window.premiumPlayer.togglePlay('${track.id}')" data-testid="button-play-${index}">
                    <svg class="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                      <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                    </svg>
                  </button>
                  <button class="control-btn control-btn-small" onclick="window.premiumPlayer.next('${track.id}')" title="Next" data-testid="button-next-${index}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M13 19l7-7-7-7M6 19l7-7-7-7"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="track-progress-container">
                <div class="track-progress-bar" onclick="window.premiumPlayer.seek('${track.id}', event)" data-testid="progress-bar-${index}">
                  <div class="track-progress-fill" style="width: 0%"></div>
                </div>
                <div class="track-times">
                  <span class="current-time" data-testid="text-current-time-${index}">0:00</span>
                  <span class="total-time" data-testid="text-total-time-${index}">0:00</span>
                </div>
              </div>
              <div class="track-actions">
                <button class="action-btn" onclick="window.premiumPlayer.openDownloadModal('${track.id}', '${track.title || `Track ${index + 1}`}', '${track.streamAudioUrl || track.audioUrl}')" data-testid="button-download-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                  </svg>
                  Download
                </button>
                <button class="action-btn" onclick="generateVisualForTrack('${musicTaskId}', '${track.id}', '${track.title}', 'image')" data-testid="button-generate-art-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                  </svg>
                  Album Art
                </button>
              </div>
              <audio preload="metadata" src="${track.streamAudioUrl || track.audioUrl}" data-track-id="${track.id}"></audio>
              <div id="visual-result-${track.id}" style="margin-top: 0.5rem;"></div>
            </div>
          `).join('');

          musicResult.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 0;">
              ${tracksHTML}
            </div>
          `;
          
          // Initialize premium player after tracks are loaded
          setTimeout(() => {
            window.premiumPlayer.init();
          }, 100);
          
          generateMusicBtn.style.pointerEvents = 'auto';
          generateMusicBtn.style.opacity = '1';
        } else if (attempts >= maxAttempts) {
          clearInterval(pollInterval);
          throw new Error('Generation timeout - please try again');
        }
      } catch (pollError) {
        console.error('Polling error:', pollError);
        clearInterval(pollInterval);
        musicResult.innerHTML = `
          <div class="result-box">
            <div class="result-title">Error</div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Failed to retrieve music. Please try again.</p>
          </div>
        `;
        generateMusicBtn.style.pointerEvents = 'auto';
        generateMusicBtn.style.opacity = '1';
      }
    }, 2000); // Poll every 2 seconds

    } catch (error) {
    console.error('Music generation error:', error);
    let errorMessage = 'Unable to generate music. ';

    if (error.message.includes('Failed to fetch')) {
    errorMessage += 'Please check your internet connection.';
    } else if (error.message.includes('CORS')) {
    errorMessage += 'CORS policy error. Check API configuration.';
    } else {
    errorMessage += 'Please try again later.';
    }

    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">${errorMessage}</p>
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">Error: ${error.message}</p>
    </div>
    `;
    musicResult.style.display = 'block';
    } finally {
    generateMusicBtn.style.pointerEvents = 'auto';
    generateMusicBtn.style.opacity = '1';
    }
    }

    // Generate album art
    async function generateArt() {
    const prompt = artPrompt.value.trim();
    const style = artStyle.value;

    if (!prompt) {
    alert('Please describe your album art');
    return;
    }

    generateArtBtn.disabled = true;
    generateArtBtn.textContent = 'Generating...';
    artResult.style.display = 'none';

    try {
    const response = await fetch('/api/generate-art', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    credentials: 'include',
    body: JSON.stringify({
    prompt: prompt,
    style: style
    })
    });

    if (!response.ok) {
    throw new Error('Failed to generate art');
    }

    const data = await response.json();

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Generated Album Art</div>
    <img src="${data.imageUrl}" alt="Generated album art" class="generated-image" />
    <a href="${data.imageUrl}" download class="download-btn">Download Image</a>
    </div>
    `;
    artResult.style.display = 'block';

    } catch (error) {
    console.error('Art generation error:', error);
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Album art generation is coming soon! We're setting up the image AI integration.</p>
    </div>
    `;
    artResult.style.display = 'block';
    } finally {
    generateArtBtn.disabled = false;
    generateArtBtn.textContent = 'Generate Art';
    }
    }

    // Generate video with Seedance
    // Generate Media (Image or Video) with new use case system

async function generateMedia() {
    if (!selectedUseCase) {
        alert('Please select a use case first');
        return;
    }

    const prompt = enhancedPrompt.value.trim();
    if (!prompt) {
        alert('Please provide a prompt');
        return;
    }

    generateMediaBtn.disabled = true;
    const originalBtnText = generateMediaBtn.innerHTML;
    
    // Add processing class for both video and image generation
    generateMediaBtn.classList.add('processing');
    if (selectedMediaType === 'video') {
        generateMediaBtn.innerHTML = `⏳ Generating Video...`;
    } else {
        generateMediaBtn.innerHTML = `⏳ Generating ${selectedMediaType}...`;
    }
    
    mediaResult.style.display = 'none';

    try {
        if (selectedMediaType === 'video') {
            // Video generation with selected model (Seedance, VEO 3, or SORA 2)
            const videoModel = document.getElementById('media-video-model')?.value || 'seedance-lite';
            const aspectRatio = document.getElementById('media-aspect-ratio')?.value || '16:9';
            const resolution = document.getElementById('media-resolution')?.value || '480p';
            const duration = parseInt(document.getElementById('media-duration')?.value || '3');

            const requestBody = {
                prompt: prompt,
                model: videoModel,
                aspectRatio: aspectRatio,
                resolution: resolution,
                duration: duration,
                enableSafetyChecker: document.getElementById('media-safety-checker')?.checked ?? true
            };

            // Add uploaded image data if provided
            if (uploadedImageData) {
                requestBody.imageData = uploadedImageData;
                // Seedance Pro: Always reference mode (doesn't support first/last frame)
                // Seedance Lite & VEO: First-frame mode
                const isSeedancePro = videoModel === 'seedance-pro';
                requestBody.imageMode = isSeedancePro ? 'reference' : 'first-frame';
            }
            // Add second image data if provided (for Seedance Lite/VEO last frame only)
            // Seedance Pro doesn't support first/last frame mode
            if (uploadedLastFrameData && videoModel !== 'seedance-pro') {
                requestBody.endImageData = uploadedLastFrameData;
            }

            const modelName = videoModel.replace('_', ' ').toUpperCase();
            console.log(`Generating video with ${modelName}...`);

            // Use the correct endpoint based on the video provider
            const isSeedance = videoModel.startsWith('seedance');
            const endpoint = isSeedance ? '/api/generate-video-fal' : '/api/generate-video';

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate video');
            }

            // Display video result
            if (data.status === 'complete' && data.videoUrl) {
                displayMediaResult(data, 'video');
                return;
            } else {
                throw new Error('Video generated but no URL returned');
            }

        } else {
            // Image generation (Midjourney, DALL-E 3, or Fal.ai Nano Banana)
            const imageEngine = document.getElementById('media-image-engine').value;
            const aspectRatio = document.getElementById('media-image-aspect-ratio')?.value || '1:1';
            const useMidjourney = imageEngine === 'midjourney';
            const useMidjourneyTtapi = imageEngine === 'midjourney-ttapi';
            const useDallE = imageEngine === 'dall-e-3';
            
            // Midjourney path (KIE.ai or ttapi.io)
            if (useMidjourney || useMidjourneyTtapi) {
                const selectedSpeed = document.getElementById('midjourney-speed')?.value || 'fast';
                const requestBody = {
                    prompt: prompt,
                    style: document.getElementById('media-image-style').value,
                    version: 'v7',
                    aspectRatio: aspectRatio,
                    speed: selectedSpeed
                };

                // Add reference image if uploaded (works with Midjourney)
                if (uploadedImageData) {
                    requestBody.referenceImage = uploadedImageData;
                    console.log('Using reference image for Midjourney generation');
                }

                // Show status message with estimated time
                const estimatedTime = selectedSpeed === 'turbo' ? '15-60 seconds' : '60-90 seconds';
                const timeoutTime = selectedSpeed === 'turbo' ? '120 seconds' : '180 seconds';
                const creditCost = selectedSpeed === 'turbo' ? 6 : 3;
                const providerName = useMidjourneyTtapi ? 'ttapi.io' : 'KIE.ai';
                
                mediaResult.innerHTML = `
                    <div class="result-box" style="border-left: 4px solid ${useMidjourneyTtapi ? '#22c55e' : '#8b5cf6'};">
                        <div class="result-title" style="color: ${useMidjourneyTtapi ? '#22c55e' : '#8b5cf6'};">🎨 Generating with Midjourney ${selectedSpeed === 'turbo' ? 'Turbo' : 'Fast'} (${providerName})</div>
                        <p style="margin-top: 0.75rem; line-height: 1.6;">
                            Creating high-quality image variants...
                        </p>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">⏱️ Est. Time:</span>
                                <span style="font-weight: 600;">${estimatedTime}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">⚡ Speed Mode:</span>
                                <span style="font-weight: 600;">${selectedSpeed === 'turbo' ? 'Turbo' : 'Fast'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">💰 Credits Used:</span>
                                <span style="font-weight: 600;">${creditCost} credits</span>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid rgba(139, 92, 246, 0.3); border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span style="color: var(--text-muted); font-size: 0.85rem;">Processing your request...</span>
                            </div>
                            <div style="width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                                <div class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); animation: progress-fill ${selectedSpeed === 'turbo' ? '60s' : '90s'} linear forwards;"></div>
                            </div>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.75rem; font-style: italic;">
                            ⚠️ Auto-timeout after ${timeoutTime} with full refund if delayed
                        </p>
                    </div>
                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                        @keyframes progress-fill {
                            to { width: 100%; }
                        }
                    </style>
                `;
                mediaResult.style.display = 'block';

                const providerLog = useMidjourneyTtapi ? 'ttapi.io' : 'KIE.ai';
                console.log(`Generating images with Midjourney via ${providerLog}...`);

                const endpoint = useMidjourneyTtapi ? '/api/media/midjourney-ttapi' : '/api/generate-midjourney';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    // Handle timeout with credit refund (status 408)
                    if (response.status === 408 && data.timeout) {
                        // Build refund message (only show if credits were actually refunded)
                        const refundBox = data.creditsRefunded > 0 ? `
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
                                <p style="color: #22c55e; font-weight: 600; margin: 0;">
                                    ✅ ${data.creditsRefunded} Credits Refunded
                                </p>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; margin-bottom: 0;">
                                    New balance: ${data.newBalance} credits
                                </p>
                            </div>
                        ` : '';
                        
                        mediaResult.innerHTML = `
                            <div class="result-box" style="border-left: 4px solid #ff9500;">
                                <div class="result-title" style="color: #ff9500;">⏱️ Generation Timed Out</div>
                                <p style="margin-top: 0.75rem; line-height: 1.6;">
                                    Midjourney's servers are experiencing heavy load right now. 
                                    Your request timed out after ${data.timeoutSeconds} seconds.
                                </p>
                                ${refundBox}
                                <p style="margin-top: 0.75rem; font-weight: 600;">💡 Recommended Next Steps:</p>
                                <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
                                    <p style="margin: 0; line-height: 1.6;">
                                        <strong>Try Nano Banana</strong> - Our fastest image engine (5 seconds, 1 credit)<br>
                                        Delivers professional results instantly, perfect when you need speed!
                                    </p>
                                    <button onclick="document.getElementById('media-image-engine').value='nano-banana'; this.parentElement.parentElement.style.display='none';" 
                                            style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Switch to Nano Banana ⚡
                                    </button>
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.75rem; font-style: italic;">
                                    You can also try Midjourney again during off-peak hours when servers are less busy.
                                </p>
                            </div>
                        `;
                        mediaResult.style.display = 'block';
                        
                        // Update credits display
                        loadCreditsDisplay();
                        return;
                    }
                    
                    throw new Error(data.error || data.details || 'Failed to generate with Midjourney');
                }

                // Display all 4 Midjourney variants
                if (data.imageUrls && data.imageUrls.length > 0) {
                    const referenceLabel = data.hasReference ? ' (with Reference)' : '';
                    const imageGrid = data.imageUrls.map((url, idx) => 
                        `<div style="position: relative;">
                            <img src="${url}" alt="Midjourney variant ${idx + 1}" style="width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.open('${url}', '_blank')" />
                            <button onclick="downloadFile('${url}', 'aetherwave-midjourney-${idx + 1}.png')" class="download-btn" style="margin-top: 0.25rem; width: 100%; font-size: 0.8rem; padding: 0.5rem;">Download #${idx + 1}</button>
                        </div>`
                    ).join('');
                    
                    mediaResult.innerHTML = `
                        <div class="result-box">
                            <div class="result-title">✅ 4 Images Generated with Midjourney${referenceLabel}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 0.5rem;">
                                ${imageGrid}
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.75rem;">
                                Use Case: ${selectedUseCase} · Engine: Midjourney v7 · 4 variants generated
                            </p>
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; font-style: italic;">
                                Click any image to view full size
                            </p>
                        </div>
                    `;
                    mediaResult.style.display = 'block';
                    return;
                } else {
                    throw new Error('Midjourney completed but no images returned');
                }
            }
            
            // DALL-E 3 or Nano Banana path
            const requestBody = {
                prompt: prompt,
                style: document.getElementById('media-image-style').value,
                aspectRatio: aspectRatio,
                useDallE: useDallE
            };

            // Add reference image if uploaded (only works with Nano Banana)
            if (uploadedImageData && !useDallE) {
                requestBody.referenceImage = uploadedImageData;
                console.log('Using reference image for image generation');
            }

            console.log(`Generating image with ${useDallE ? 'DALL-E 3' : 'Fal.ai Nano Banana'}...`);

            const response = await fetch('/api/generate-art', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate image');
            }

            // Display image result
            if (data.imageUrl) {
                const engineName = data.model === 'dall-e-3' ? 'DALL-E 3' : 'Nano Banana';
                const referenceLabel = data.hasReference ? ' (with Reference)' : '';
                mediaResult.innerHTML = `
                    <div class="result-box">
                        <div class="result-title">✅ Image Generated with ${engineName}${referenceLabel}</div>
                        <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
                        ${data.description ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">AI: ${data.description}</p>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                            Use Case: ${selectedUseCase} · Engine: ${engineName} · Style: ${data.style}
                        </p>
                        ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">Revised: ${data.revisedPrompt}</p>` : ''}
                    </div>
                `;
                mediaResult.style.display = 'block';
                return;
            } else {
                throw new Error('Image generated but no URL returned');
            }
        }

    } catch (error) {
        console.error('Media generation error:', error);
        mediaResult.innerHTML = `
            <div class="result-box">
                <div class="result-title">Error</div>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate ${selectedMediaType}. ${error.message}</p>
            </div>
        `;
        mediaResult.style.display = 'block';
    } finally {
        generateMediaBtn.disabled = false;
        generateMediaBtn.classList.remove('processing');
        generateMediaBtn.innerHTML = originalBtnText;
    }
}
 
   
 

    // Display media result
    function displayMediaResult(data, type) {
    if (type === 'video') {
    const generationTime = data.timings ? ` (${Math.round(data.timings.inference / 1000)}s)` : '';
    
    // Determine the model display name and provider
    let modelDisplay = 'Seedance 1.0';
    let provider = 'Fal.ai';
    
    if (data.model) {
      if (data.model.startsWith('veo3')) {
        modelDisplay = 'VEO 3';
        provider = 'KIE.ai';
      } else if (data.model.includes('sora')) {
        modelDisplay = 'SORA 2';
        provider = 'KIE.ai';
      } else if (data.model.includes('seedance')) {
        modelDisplay = data.model;
        provider = 'Fal.ai';
      } else {
        modelDisplay = data.model;
        provider = 'Fal.ai';
      }
    }

    mediaResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">✅ Video Generated with ${provider} ${modelDisplay}${generationTime}</div>
    <video controls autoplay loop src="${data.videoUrl}" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;"></video>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadVideo('${data.videoUrl}', 'aetherwave-${selectedUseCase}.mp4')" class="download-btn" style="cursor: pointer;">Download Video</button>
    ${data.seed ? `<span class="download-btn" style="cursor: default;">Seed: ${data.seed}</span>` : ''}
    </div>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
    Use Case: ${selectedUseCase} · Model: ${modelDisplay}
    </p>
    </div>
    `;
    } else if (type === 'image') {
    mediaResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">✅ Image Generated with DALL-E 3</div>
    <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
    </div>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
    Use Case: ${selectedUseCase} · Style: ${data.style}
    </p>
    ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">DALL-E Revision: ${data.revisedPrompt}</p>` : ''}
    </div>
    `;
    }

    mediaResult.style.display = 'block';
    }

    // Event listener for generate button
    if (generateMediaBtn) {
      generateMediaBtn.addEventListener('click', generateMedia);
    }

    // OLD VIDEO GENERATION (keep for compatibility with music track buttons)
    async function generateVideo() {
    const prompt = videoPrompt.value.trim();
    const modelVersion = videoModel.value;
    const resolution = videoResolution.value;
    const duration = videoDuration.value;
    const cameraFixed = videoCameraFixed.checked;
    const safetyChecker = videoSafetyChecker.checked;

    if (!prompt) {
    alert('Please describe your video');
    return;
    }

    if (generateVideoBtn) {
      generateVideoBtn.disabled = true;
      generateVideoBtn.textContent = 'Generating with Seedance...';
    }
    if (artResult) {
      artResult.style.display = 'none';
    }

    try {
    const requestBody = {
    prompt: prompt,
    modelVersion: modelVersion,
    resolution: resolution,
    duration: duration,
    cameraFixed: cameraFixed,
    enableSafetyChecker: safetyChecker
    };

    // Add uploaded image data if provided (for image-to-video)
    if (uploadedImageData) {
    requestBody.imageData = uploadedImageData;
    }

    // Try Fal.ai first (more reliable)
    let response = await fetch('/api/generate-video-fal', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    let data = await response.json();
    let usingFallback = false;

    // If Fal.ai fails, fallback to KIE.AI
    if (!response.ok && data.error?.includes('Fal.ai API key not configured')) {
    console.log('Fal.ai not configured, falling back to KIE.AI...');
    usingFallback = true;

    response = await fetch('/api/generate-video', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    data = await response.json();
    }

    // Handle Fal.ai response (synchronous - video ready immediately)
    if (!usingFallback && response.ok && data.status === 'complete') {
    displayVideoResult(data);
    return;
    }

    // Handle KIE.AI response (async - need to poll)
    if (usingFallback && response.status === 202) {
    // Video generation started - poll for completion
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title"><img src="/assets/icon-set/camera1-icon.png" style="width: 20px; height: 20px; margin-right: 0.5rem; vertical-align: middle;"> Generating Video with Seedance 1.0 (KIE.AI)</div>
    <p style="color: var(--accent-color); font-size: 0.9rem;">Video generation started! This may take 5-10 minutes.</p>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">Model: ${data.model || 'Seedance 1.0 Lite'}</p>
    <p style="color: var(--text-muted); font-size: 0.85rem;">Resolution: ${data.resolution || '720p'}</p>
    <p style="color: var(--text-muted); font-size: 0.85rem;">Duration: ${data.duration || '5'}s</p>
    </div>
    `;
    artResult.style.display = 'block';

    // Poll for completion
    pollVideoStatus(data.taskId);
    return;
    }

    if (!response.ok) {
    throw new Error(data.error || data.details || 'Failed to generate video');
    }

    // If video is ready
    if (data.videoUrl) {
    displayVideoResult(data);
    }

    } catch (error) {
    console.error('Video generation error:', error);
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate video. ${error.message}</p>
    </div>
    `;
    if (artResult) {
      artResult.style.display = 'block';
    }
    } finally {
    if (generateVideoBtn) {
      generateVideoBtn.disabled = false;
      generateVideoBtn.textContent = 'Generate Video with Seedance 1.0';
    }
    }
    }

    // Removed pollVideoStatus() - no longer needed with Fal.ai synchronous API

    // Display video result
    function displayVideoResult(data) {
    const provider = data.model?.includes('fal-ai') ? 'Fal.ai' : 'KIE.AI';
    const modelName = data.model || 'Seedance 1.0';

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">✅ Generated Video (${provider})</div>
    <video controls autoplay loop style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    Your browser does not support the video tag.
    </video>
    ${data.coverUrl ? `<img src="${data.coverUrl}" alt="Video thumbnail" style="display: none;">` : ''}
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadVideo('${data.videoUrl}', 'seedance-video.mp4')" class="download-btn" style="cursor: pointer;">Download Video</button>
    ${data.seed ? `<span class="download-btn" style="cursor: default;">Seed: ${data.seed}</span>` : ''}
    </div>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">
    ${data.resolution ? `Resolution: ${data.resolution} · ` : ''}
    ${data.duration ? `Duration: ${data.duration}s · ` : ''}
    Model: ${modelName}
    ${data.timings ? ` · Generated in ${Math.round(data.timings.inference / 1000)}s` : ''}
    </p>
    </div>
    `;
    artResult.style.display = 'block';
    }

    // Album Art Modal Controller
    window.albumArtModal = {
      trackId: null,
      trackTitle: null,
      selectedStyle: 'photorealistic',

      open: function(trackId, trackTitle) {
        this.trackId = trackId;
        this.trackTitle = trackTitle;
        this.selectedStyle = 'photorealistic';
        document.getElementById('album-art-track-title').textContent = `Style for "${trackTitle}"`;
        document.getElementById('album-art-modal').style.display = 'flex';
        
        // Clear artist name input
        const artistInput = document.getElementById('album-art-artist-name');
        if (artistInput) artistInput.value = '';
        
        // Reset all styles and select photorealistic by default
        this.updateSelection();
      },

      close: function() {
        document.getElementById('album-art-modal').style.display = 'none';
        this.trackId = null;
        this.trackTitle = null;
      },

      selectStyle: function(style, evt) {
        this.selectedStyle = style;
        this.updateSelection();
      },

      updateSelection: function() {
        // Reset all options
        document.querySelectorAll('#album-art-modal .download-option').forEach(opt => {
          opt.style.backgroundColor = '';
          const checkmark = opt.querySelector('.style-checkmark');
          if (checkmark) checkmark.style.display = 'none';
        });
        
        // Highlight selected option
        const selectedOption = document.querySelector(`#album-art-modal .download-option[data-style="${this.selectedStyle}"]`);
        if (selectedOption) {
          selectedOption.style.backgroundColor = 'rgba(139, 92, 246, 0.15)';
          selectedOption.style.borderColor = 'rgba(139, 92, 246, 0.5)';
          const checkmark = selectedOption.querySelector('.style-checkmark');
          if (checkmark) checkmark.style.display = 'block';
        }
      },

      generate: async function() {
        if (!this.trackId || !this.trackTitle) return;
        
        const trackId = this.trackId;
        const trackTitle = this.trackTitle;
        const style = this.selectedStyle;
        
        // Get artist name from input
        const artistInput = document.getElementById('album-art-artist-name');
        const artistName = artistInput ? artistInput.value.trim() : '';
        
        this.close();
        
        // Now call the actual generation function with artist name
        await window.generateAlbumArtForTrack(trackId, trackTitle, style, artistName);
      }
    };

    // Generate album art for a specific track with selected style
    window.generateAlbumArtForTrack = async function(trackId, trackTitle, style, artistName = '') {
      const resultDiv = document.getElementById(`visual-result-${trackId}`);
      resultDiv.innerHTML = `<p style="color: var(--accent-color); font-size: 0.9rem;">🎨 Generating ${style} album art with DALL-E 3...</p>`;

      try {
        // Build prompt with artist name if provided
        let artPrompt = `Album cover art for the song "${trackTitle}". Music-themed, artistic, vibrant, professional album artwork design`;
        
        if (artistName) {
          artPrompt += `. The artist name is "${artistName}" - include this artist name prominently on the album cover`;
        }

        console.log('Generating album art with prompt:', artPrompt, 'Style:', style, 'Artist:', artistName || 'none');

        const response = await fetch('/api/generate-art', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            prompt: artPrompt,
            style: style,
            useDallE: true  // Panel 1 uses DALL-E 3 for professional album art
          })
        });

        if (!response.ok) {
          const data = await response.json();
          console.error('Album art generation error:', data);
          throw new Error(data.error || data.details || 'Failed to generate album art');
        }

        const data = await response.json();
        console.log('Album art generated successfully:', data);

        // DALL-E returns image synchronously - display immediately
        if (data.imageUrl) {
          // Store in mediaStorage for toggling
          window.mediaStorage[trackId] = {
            trackTitle: trackTitle,
            albumArtUrl: data.imageUrl,
            artStyle: style,
            videoUrl: null
          };
          
          // Use the toggle function to display album art
          toggleMediaView(trackId, false);
        } else {
          throw new Error('Album art generated but no image URL returned');
        }
      } catch (error) {
        console.error('Album art generation error:', error);
        resultDiv.innerHTML = `<p style="color: #ff6b6b; font-size: 0.9rem;">Error: ${error.message}</p>`;
      }
    };

    // Store album art and video data for toggling
    window.mediaStorage = window.mediaStorage || {};

    // Toggle between album art and video view
    window.toggleMediaView = function(trackId, showVideo) {
      const data = window.mediaStorage[trackId];
      if (!data) return;

      const resultDiv = document.getElementById(`visual-result-${trackId}`);
      
      if (showVideo && data.videoUrl) {
        // Get video duration from storage (default to 5s for backward compatibility)
        const videoDuration = data.videoDuration || window.mediaStorage[trackId]?.videoDuration || '5';
        
        // Show video view
        resultDiv.innerHTML = `
          <div style="text-align: center;">
            <p style="color: #4ade80; font-size: 0.9rem; margin-bottom: 0.5rem;">🎬 Album Art Video (${videoDuration}s Seedance)</p>
            <video controls autoplay loop style="width: 100%; max-width: 100%; border-radius: 8px;" data-testid="video-album-art-${trackId}">
              <source src="${data.videoUrl}" type="video/mp4">
            </video>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
              <button onclick="downloadVideo('${data.videoUrl}', '${data.trackTitle}-video.mp4')" class="download-btn" style="flex: 1; min-width: 120px; cursor: pointer;" data-testid="button-download-video-${trackId}">📥 Download Video</button>
              <button onclick="toggleMediaView('${trackId}', false)" class="download-btn" style="flex: 1; min-width: 120px; cursor: pointer;" data-testid="button-show-art-${trackId}">🖼️ Show Album Art</button>
            </div>
          </div>
        `;
      } else if (data.albumArtUrl) {
        // Show album art view
        resultDiv.innerHTML = `
          <div style="text-align: center;">
            <p style="color: #4ade80; font-size: 0.9rem; margin-bottom: 0.5rem;">✅ Album art complete! (DALL-E 3 - ${data.artStyle})</p>
            <img src="${data.albumArtUrl}" alt="Album art for ${data.trackTitle}" style="width: 100%; max-width: 100%; border-radius: 8px;" data-testid="img-album-art-${trackId}">
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
              <button onclick="downloadFile('${data.albumArtUrl}', '${data.trackTitle}-album-art.png')" class="download-btn" style="flex: 1; min-width: 120px; cursor: pointer;" data-testid="button-download-image-${trackId}">📥 Download Image</button>
              ${data.videoUrl ? `<button onclick="toggleMediaView('${trackId}', true)" class="btn-primary" style="flex: 1; min-width: 120px; cursor: pointer;" data-testid="button-show-video-${trackId}">▶️ Show Video</button>` : `<button onclick="showAlbumArtVideoDurationPicker('${trackId}', '${data.trackTitle}', '${data.albumArtUrl}')" class="btn-primary" style="flex: 1; min-width: 120px; cursor: pointer;" data-testid="button-turn-into-video-${trackId}">🎬 Turn into Video</button>`}
            </div>
          </div>
        `;
      }
    };

    // Show duration picker modal for album art to video conversion
    window.showAlbumArtVideoDurationPicker = function(trackId, trackTitle, albumArtUrl) {
      const isFree = userPlan === 'free';
      
      // Create modal HTML
      const modalHtml = `
        <div id="video-duration-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;">
          <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
            <h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1.1rem;">🎬 Animate Album Art</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">Choose animation duration for "${trackTitle}"</p>
            
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Duration</label>
              <select id="album-video-duration" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: var(--text-primary); font-size: 0.9rem;" ${isFree ? 'disabled' : ''}>
                <option value="5" selected>5 seconds (8 credits)</option>
                <option value="10">10 seconds (15 credits)</option>
              </select>
              ${isFree ? `<p style="color: #fbbf24; font-size: 0.75rem; margin-top: 0.5rem;">⚠️ Free accounts limited to 5 seconds</p>` : ''}
            </div>
            
            <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--accent-color);">
              <strong>Settings:</strong> Lite model, 480p resolution<br>
              <strong>Mode:</strong> Image-to-video (album art as first frame)
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="closeVideoDurationModal()" style="flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;" data-testid="button-cancel-video-duration">Cancel</button>
              <button onclick="confirmAlbumArtToVideo('${trackId}', '${trackTitle}', '${albumArtUrl}')" style="flex: 1; padding: 0.75rem; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem;" data-testid="button-confirm-video-duration">🎬 Animate</button>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };
    
    // Close duration picker modal
    window.closeVideoDurationModal = function() {
      const modal = document.getElementById('video-duration-modal');
      if (modal) modal.remove();
    };
    
    // Confirm and start album art to video conversion
    window.confirmAlbumArtToVideo = function(trackId, trackTitle, albumArtUrl) {
      const durationSelect = document.getElementById('album-video-duration');
      const duration = durationSelect ? durationSelect.value : '3';
      
      // Close modal
      closeVideoDurationModal();
      
      // Start conversion
      turnAlbumArtIntoVideo(trackId, trackTitle, albumArtUrl, duration);
    };

    // Turn album art into video using Seedance image-to-video
    window.turnAlbumArtIntoVideo = async function(trackId, trackTitle, albumArtUrl, duration = '3') {
      const resultDiv = document.getElementById(`visual-result-${trackId}`);
      
      // Show loading state
      resultDiv.innerHTML = `
        <div style="text-align: center;">
          <img src="${albumArtUrl}" alt="Album art" style="width: 100%; max-width: 100%; border-radius: 8px; opacity: 0.6;">
          <p style="color: var(--accent-color); font-size: 0.9rem; margin-top: 0.75rem;">🎬 Animating album art (${duration}s)...</p>
          <p style="color: var(--text-muted); font-size: 0.8rem;">Using Seedance image-to-video (Lite, 480p)</p>
        </div>
      `;

      try {
        const response = await fetch('/api/generate-video-fal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            prompt: `Animated music video for "${trackTitle}", dynamic camera movement, cinematic effects`,
            imageUrl: albumArtUrl,
            imageMode: 'first-frame',  // Use album art as the first frame
            modelVersion: 'lite',
            resolution: '480p',
            duration: duration,
            enableSafetyChecker: true
          })
        });

        const data = await response.json();
        console.log('Album art to video response:', data);

        if (!response.ok) {
          console.error('Video generation error response:', data);
          throw new Error(data.details || data.error || 'Failed to generate video from album art');
        }

        if (data.status === 'complete' && data.videoUrl) {
          // Store the video URL in media storage
          if (!window.mediaStorage[trackId]) {
            window.mediaStorage[trackId] = {};
          }
          window.mediaStorage[trackId].videoUrl = data.videoUrl;
          window.mediaStorage[trackId].videoDuration = duration;
          
          // Show video view
          toggleMediaView(trackId, true);
          
          // Update credits display
          if (data.creditsRemaining !== undefined) {
            updateCreditsDisplay(data.creditsRemaining);
          }
        } else {
          throw new Error('Video generation completed but no video URL returned');
        }
      } catch (error) {
        console.error('Album art to video error:', error);
        // Restore album art view on error
        toggleMediaView(trackId, false);
        // Show error message
        resultDiv.innerHTML += `<p style="color: #ff6b6b; font-size: 0.85rem; margin-top: 0.5rem; text-align: center;">❌ ${error.message}</p>`;
      }
    };

    // Generate visual (album art) for a specific track - opens album art style modal
    window.generateVisualForTrack = async function(musicTaskId, trackId, trackTitle, type) {
      // Only album art generation is supported in Panel 1
      // Video generation is now exclusively through "Turn into Video" after album art is created
      if (type === 'image') {
        window.albumArtModal.open(trackId, trackTitle);
      }
    };

    // Event listeners - Chat
    if (sendBtn && chatInput) {
      sendBtn.addEventListener('click', () => {
        sendMessage(chatInput.value);
      });
    }

    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage(chatInput.value);
        }
      });
    }

    if (suggestionChips.length > 0 && chatInput) {
      suggestionChips.forEach(chip => {
        chip.addEventListener('click', () => {
          chatInput.value = chip.textContent;
          sendMessage(chip.textContent);
        });
      });
    }

    // Event listeners - Music
    if (generateMusicBtn) {
      generateMusicBtn.addEventListener('click', generateMusic);
    }

    // Event listeners - Visual (Art/Video)
    if (generateArtBtn) {
      generateArtBtn.addEventListener('click', generateArt);
    }
    // Removed old generateVideoBtn listener - video generation now uses unified media generation system
        
         // --- Place this block last ---
 

function updateMediaInputs() {
  const isVideo = selectedMediaType === "video";

  // Show/hide video-specific controls
  const videoModelGroup = document.getElementById('video-model-group');
  const aspectRatioGroup = document.getElementById('video-aspect-ratio-group');
  const resolutionGroup = document.getElementById('video-resolution-group');
  const durationGroup = document.getElementById('video-duration-group');
  const imageEngineGroup = document.getElementById('image-engine-group');
  const imageAspectRatioGroup = document.getElementById('image-aspect-ratio-group');
  const imageStyleGroup = document.getElementById('image-style-group');
  const imageUploadGroup = document.getElementById('image-upload-group');
  const imageUploadLabel = document.getElementById('image-upload-label');
  const imageLabelHint = document.getElementById('image-label-hint');

  // For video mode: show model selector, hide image engine/style/aspect ratio
  // For image mode: hide video fields, show image engine/style/aspect ratio
  if (videoModelGroup) videoModelGroup.style.display = isVideo ? 'block' : 'none';
  if (imageEngineGroup) imageEngineGroup.style.display = isVideo ? 'none' : 'block';
  if (imageAspectRatioGroup) imageAspectRatioGroup.style.display = isVideo ? 'none' : 'block';
  if (imageStyleGroup) imageStyleGroup.style.display = isVideo ? 'none' : 'block';

  // Update image upload label based on mode
  if (isVideo) {
    // Video mode: label changes based on video model (handled by video model change event)
    if (imageUploadLabel) imageUploadLabel.textContent = 'Upload Image (Optional)';
  } else {
    // Image mode: always "Reference Image"
    if (imageUploadLabel) imageUploadLabel.textContent = 'Reference Image (Optional)';
    if (imageLabelHint) imageLabelHint.textContent = '';
  }

  // Image upload is always visible (used for both images and video reference)
  if (imageUploadGroup) imageUploadGroup.style.display = 'block';

  // Resolution/aspect/duration are shown/hidden by video model change handler
  // So we don't need to touch them here

  // Update credit cost preview when inputs change
  if (isVideo) {
    updateCreditCostPreview();
  }
}

// Calculate and display credit cost for video generation
function updateCreditCostPreview() {
  const model = document.getElementById('media-video-model')?.value || 'seedance-lite';
  const resolution = document.getElementById('media-resolution')?.value || '480p';
  const duration = parseInt(document.getElementById('media-duration')?.value || '3');
  const previewEl = document.getElementById('credit-cost-preview');

  if (!previewEl) return;

  // Calculate cost per second based on model (same logic as server/routes.ts)
  let costPerSecond = 0;

  // Premium KIE.ai models (resolution-independent)
  if (model === 'veo3_fast') {
    costPerSecond = 0.0375; // $0.30/8s
  } else if (model === 'sora2') {
    costPerSecond = 0.015; // $0.15/10s
  } else if (model === 'sora2_pro') {
    costPerSecond = 0.045; // $0.45/10s
  } else if (model === 'sora2_pro_hd') {
    costPerSecond = 0.10; // $1/10s
  }
  // Seedance models (resolution-dependent)
  else if (model === 'seedance-lite') {
    if (resolution === '480p') costPerSecond = 0.010;
    else if (resolution === '720p') costPerSecond = 0.0225;
    else if (resolution === '1080p') costPerSecond = 0.050;
    else if (resolution === '4k') costPerSecond = 0.100;
  } else if (model === 'seedance-pro-fast') {
    // Pro Fast: Token-based pricing (API cost, 50% markup applied below)
    if (resolution === '480p') costPerSecond = 0.00922;   // 9,220 tokens/sec at $1.0/million
    else if (resolution === '720p') costPerSecond = 0.0216;  // 21,600 tokens/sec at $1.0/million
    else if (resolution === '1080p') costPerSecond = 0.0486; // 48,600 tokens/sec at $1.0/million
  } else if (model === 'seedance-pro') {
    if (resolution === '480p') costPerSecond = 0.020;
    else if (resolution === '720p') costPerSecond = 0.045;
    else if (resolution === '1080p') costPerSecond = 0.100;
    else if (resolution === '4k') costPerSecond = 0.200;
  }

  // Calculate total cost with 50% margin
  const apiCost = costPerSecond * duration;
  const totalCost = apiCost * 1.5;
  const credits = Math.ceil(totalCost / 0.01);

  // Display cost
  previewEl.innerHTML = `💳 Estimated cost: <strong>${credits} credits</strong> ($${totalCost.toFixed(2)})`;
}

mediaTypeBtns.forEach(btn => {
  btn.addEventListener('click', function() {
    mediaTypeBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedMediaType = btn.dataset.type;
    
    // Update button text and class immediately
    if (mediaTypeLabel) {
      mediaTypeLabel.textContent = selectedMediaType === 'image' ? 'Image' : 'Video';
    }
    if (generateMediaBtn) {
      generateMediaBtn.className = selectedMediaType === 'video' ? 'btn-video-generate' : 'btn-primary';
      if (selectedMediaType === 'image') {
        generateMediaBtn.style.padding = '1rem';
        generateMediaBtn.style.fontSize = '1.1rem';
        generateMediaBtn.style.fontWeight = '600';
      }
    }
    
    updateMediaInputs();

    // Apply quality restrictions for free accounts
    if (selectedMediaType === 'video') {
      applyVideoQualityRestrictions();
    } else {
      applyImageEngineRestrictions();
    }
  });
});

// Add event listeners for credit cost preview updates
const videoModelSelect = document.getElementById('media-video-model');
const resolutionSelect = document.getElementById('media-resolution');
const durationSelect = document.getElementById('media-duration');

if (videoModelSelect) {
  videoModelSelect.addEventListener('change', async () => {
    const model = videoModelSelect.value;
    const isSeedance = model.startsWith('seedance');
    const isVEO = model.startsWith('veo');
    const isSORA = model.startsWith('sora');

    const resolutionGroup = document.getElementById('video-resolution-group');
    const aspectRatioGroup = document.getElementById('video-aspect-ratio-group');
    const durationGroup = document.getElementById('video-duration-group');
    const durationSelect = document.getElementById('media-duration');
    const aspectRatioSelect = document.getElementById('media-aspect-ratio');
    const imageModeSelection = document.getElementById('image-mode-selection');
    const imageLabel = document.getElementById('image-label-hint');

    // Show warning for SORA 2 Pro HD about long generation times
    if (model === 'sora2_pro_hd') {
      await showConfirmationDialog(
        'SORA 2 Pro HD has very long generation times: 10-second videos typically take 10-20 minutes, and 15-second videos can take around 30 minutes. This reflects OpenAI\'s native delivery speed. We strongly recommend using 15-second HD with caution.'
      );
    }

    // Seedance models: Show resolution, Pro Fast also shows aspect ratio
    if (isSeedance) {
      const isProFast = model.includes('pro-fast');
      const isLite = model.includes('lite');
      
      if (resolutionGroup) resolutionGroup.style.display = 'block';
      
      // Pro Fast shows aspect ratio, others hide it
      if (aspectRatioGroup) {
        aspectRatioGroup.style.display = isProFast ? 'block' : 'none';
      }
      
      // Set aspect ratio options for Pro Fast
      if (isProFast && aspectRatioSelect) {
        aspectRatioSelect.innerHTML = `
          <option value="auto">auto (default)</option>
          <option value="21:9">21:9 (Ultra-wide)</option>
          <option value="16:9" selected>16:9 (Landscape - YouTube)</option>
          <option value="4:3">4:3 (Classic)</option>
          <option value="1:1">1:1 (Square)</option>
          <option value="3:4">3:4 (Vertical Classic)</option>
          <option value="9:16">9:16 (Portrait - TikTok/Reels)</option>
        `;
      }
      
      if (durationGroup) durationGroup.style.display = 'block';
      // Seedance durations: Lite (5s, 10s only), Pro (3s, 5s, 10s), Pro Fast (2-12s)
      if (durationSelect) {
        if (isLite) {
          durationSelect.innerHTML = `
            <option value="5" selected>5 seconds</option>
            <option value="10">10 seconds</option>
          `;
        } else if (isProFast) {
          durationSelect.innerHTML = `
            <option value="2">2 seconds</option>
            <option value="3">3 seconds</option>
            <option value="4">4 seconds</option>
            <option value="5" selected>5 seconds</option>
            <option value="6">6 seconds</option>
            <option value="7">7 seconds</option>
            <option value="8">8 seconds</option>
            <option value="9">9 seconds</option>
            <option value="10">10 seconds</option>
            <option value="11">11 seconds</option>
            <option value="12">12 seconds</option>
          `;
        } else {
          durationSelect.innerHTML = `
            <option value="3">3 seconds</option>
            <option value="5" selected>5 seconds</option>
            <option value="10">10 seconds</option>
          `;
        }
      }
      // Hide image mode selection (Seedance auto-determines mode)
      if (imageModeSelection) {
        imageModeSelection.style.display = 'none';
      }
      // Update image label for Seedance (Lite: first frame or reference, Pro Fast: first frame, Pro: reference only)
      if (imageLabel) {
        const isProFast = model.includes('pro-fast');
        const isPro = model.includes('pro') && !isProFast;
        if (isPro) {
          imageLabel.textContent = '- Reference only';
        } else if (isProFast) {
          imageLabel.textContent = '- First frame';
        } else {
          imageLabel.textContent = '- First frame or reference';
        }
      }
      
      // Filter resolution options based on Lite/Pro Fast/Pro
      const resolutionSelect = document.getElementById('media-resolution');
      if (resolutionSelect) {
        const options = resolutionSelect.querySelectorAll('option');
        const currentValue = resolutionSelect.value;
        
        options.forEach(option => {
          // Hide 4K for Seedance Lite and Pro Fast (only available in regular Pro)
          if ((isLite && option.hasAttribute('data-exclude-lite')) || 
              (isProFast && option.hasAttribute('data-exclude-pro-fast'))) {
            option.style.display = 'none';
            option.disabled = true;
          } else {
            option.style.display = '';
            option.disabled = false;
          }
        });
        
        // If current selection is 4K and switching to Lite/Pro Fast, reset to 480p
        if ((isLite || isProFast) && currentValue === '4k') {
          resolutionSelect.value = '480p';
        }
      }
    }
    // VEO 3: Show aspect ratio (8 secs only), hide resolution, variable duration, hide image mode
    else if (isVEO) {
      if (resolutionGroup) resolutionGroup.style.display = 'none';
      if (aspectRatioGroup) aspectRatioGroup.style.display = 'block';
      if (durationGroup) durationGroup.style.display = 'block';
      // VEO 3: 5-10s variable duration
      if (durationSelect) {
        durationSelect.innerHTML = `
          <option value="8" selected>8 seconds</option>
        `;
      }
      // VEO 3: All aspect ratios available
      if (aspectRatioSelect) {
        aspectRatioSelect.innerHTML = `
          <option value="16:9" selected>16:9 (Landscape - YouTube)</option>
          <option value="9:16">9:16 (Portrait - TikTok/Reels)</option>
          <option value="1:1">auto (matches reference image)</option>        
        `;
      }
      // Hide image mode selection for VEO (always reference)
      if (imageModeSelection) imageModeSelection.style.display = 'none';
      // Update image label for VEO 3
      if (imageLabel) imageLabel.textContent = '- First frame or reference';
    }
    // SORA 2: Show aspect ratio (16:9/9:16 ONLY), hide resolution, 10s or 15s only, hide image mode
    else if (isSORA) {
      if (resolutionGroup) resolutionGroup.style.display = 'none';
      if (aspectRatioGroup) aspectRatioGroup.style.display = 'block';
      if (durationGroup) durationGroup.style.display = 'block';
      // SORA 2: ONLY 10s or 15s durations
      if (durationSelect) {
        durationSelect.innerHTML = `
          <option value="10" selected>10 seconds</option>
          <option value="15">15 seconds</option>
        `;
      }
      // SORA 2: ONLY 16:9 and 9:16 aspect ratios
      if (aspectRatioSelect) {
        aspectRatioSelect.innerHTML = `
          <option value="16:9" selected>16:9 (Landscape - YouTube)</option>
          <option value="9:16">9:16 (Portrait - TikTok/Reels)</option>
        `;
      }
      // Hide image mode selection for SORA (always reference)
      if (imageModeSelection) imageModeSelection.style.display = 'none';
      // Update image label for SORA 2
      if (imageLabel) imageLabel.textContent = '- Reference only';
    }

    updateCreditCostPreview();
  });
}

if (resolutionSelect) {
  resolutionSelect.addEventListener('change', updateCreditCostPreview);
}

if (durationSelect) {
  durationSelect.addEventListener('change', updateCreditCostPreview);
}

// **Force correct UI and variable state immediately after setup**
updateMediaInputs();
  </script>
  <!-- Download Modal -->
  <div id="download-modal" class="modal-overlay" style="display: none;" data-testid="modal-download" onclick="if(event.target === this) window.premiumPlayer.closeDownloadModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Download Track</div>
        <div class="modal-subtitle" id="modal-track-title">Select your preferred format</div>
      </div>
      <div class="download-options">
        <div class="download-option" onclick="window.premiumPlayer.selectFormat('mp3')" data-testid="option-mp3">
          <div class="download-option-info">
            <div class="download-option-title">MP3 (Recommended)</div>
            <div class="download-option-desc">Universal format, works everywhere</div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.premiumPlayer.selectFormat('wav')" data-testid="option-wav">
          <div class="download-option-info">
            <div class="download-option-title">WAV (Lossless)</div>
            <div class="download-option-desc">Uncompressed audio, larger file size</div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="window.premiumPlayer.closeDownloadModal()" data-testid="button-modal-cancel">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="window.premiumPlayer.confirmDownload()" data-testid="button-modal-download">Download</button>
      </div>
    </div>
  </div>

  <!-- Album Art Style Selection Modal -->
  <div id="album-art-modal" class="modal-overlay" style="display: none;" data-testid="modal-album-art" onclick="if(event.target === this) window.albumArtModal.close()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Generate Album Art</div>
        <div class="modal-subtitle" id="album-art-track-title">Select art style</div>
      </div>
      
      <!-- Artist Name Input -->
      <div style="margin-bottom: 1.5rem;">
        <label for="album-art-artist-name" class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color);">
          Artist Name (optional)
        </label>
        <input 
          type="text" 
          id="album-art-artist-name" 
          class="form-input" 
          placeholder="Enter artist name to appear on the cover..."
          data-testid="input-artist-name"
          style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3); background: rgba(0, 0, 0, 0.3); color: var(--text-color); font-size: 0.95rem;"
        />
        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">
          DALL-E will include this name on the album cover design
        </div>
      </div>

      <div class="download-options">
        <div class="download-option" onclick="window.albumArtModal.selectStyle('photorealistic', event)" data-testid="style-photorealistic" data-style="photorealistic">
          <div class="download-option-info">
            <div class="download-option-title">Photorealistic</div>
            <div class="download-option-desc">Highly detailed, professional photography style</div>
          </div>
          <svg class="style-checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.albumArtModal.selectStyle('abstract', event)" data-testid="style-abstract" data-style="abstract">
          <div class="download-option-info">
            <div class="download-option-title">Abstract</div>
            <div class="download-option-desc">Flowing shapes, vibrant colors, artistic interpretation</div>
          </div>
          <svg class="style-checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.albumArtModal.selectStyle('cyberpunk', event)" data-testid="style-cyberpunk" data-style="cyberpunk">
          <div class="download-option-info">
            <div class="download-option-title">Cyberpunk</div>
            <div class="download-option-desc">Neon lights, futuristic cityscape, dark with bright accents</div>
          </div>
          <svg class="style-checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.albumArtModal.selectStyle('retro', event)" data-testid="style-retro" data-style="retro">
          <div class="download-option-info">
            <div class="download-option-title">Retro</div>
            <div class="download-option-desc">80s vaporwave, pink and purple gradients, nostalgic</div>
          </div>
          <svg class="style-checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.albumArtModal.selectStyle('minimal', event)" data-testid="style-minimal" data-style="minimal">
          <div class="download-option-info">
            <div class="download-option-title">Minimal</div>
            <div class="download-option-desc">Clean lines, simple composition, modern aesthetic</div>
          </div>
          <svg class="style-checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.albumArtModal.selectStyle('surreal', event)" data-testid="style-surreal" data-style="surreal">
          <div class="download-option-info">
            <div class="download-option-title">Surreal</div>
            <div class="download-option-desc">Dreamlike imagery, unexpected elements, artistic creativity</div>
          </div>
          <svg class="style-checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="window.albumArtModal.close()" data-testid="button-album-art-cancel">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="window.albumArtModal.generate()" data-testid="button-album-art-generate">Generate</button>
      </div>
    </div>
  </div>

  <!-- Quest Modal -->
  <div id="quest-modal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closeQuestModal()">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-title">🎁 Earn Free Credits!</div>
        <div class="modal-subtitle">Complete quests to earn bonus credits</div>
      </div>

      <div id="quest-list" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
        <!-- Quests will be loaded here dynamically -->
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
          Loading quests...
        </div>
      </div>

      <div style="text-align: center; font-size: 0.85rem; color: var(--text-muted); padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
        <strong style="color: var(--text-primary);">Free Tier Credits:</strong> 50 welcome bonus + 10 credits/day (cap: 50)<br>
        Quest rewards can push you over the cap!
      </div>

      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="closeQuestModal()">Close</button>
      </div>
    </div>
  </div>

</body>
</html>